[{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/.expo/types/router.d.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'T' is defined but never used.","line":8,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":32,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(auth)/_layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(auth)/login.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":97,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":97,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Ionicons } from '@expo/vector-icons';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { router } from 'expo-router';\nimport React, { useState } from 'react';\nimport {\n  ActivityIndicator,\n  Animated,\n  KeyboardAvoidingView,\n  Modal,\n  Platform,\n  ScrollView,\n  StyleSheet,\n  Text,\n  TextInput,\n  TouchableOpacity,\n  View,\n} from 'react-native';\nimport { useAuth } from '../../contexts/AuthContext';\n\n// Utilise le proxy local pour √©viter CORS en d√©veloppement web\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\ntype AuthMode = 'login' | 'register';\ntype ErrorType = 'none' | 'wrong_password' | 'user_not_found' | 'other';\n\nexport default function AuthScreen() {\n  const [mode, setMode] = useState<AuthMode>('login');\n  const [username, setUsername] = useState('');\n  const [password, setPassword] = useState('');\n  const [email, setEmail] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [errorType, setErrorType] = useState<ErrorType>('none');\n  const [errorMessage, setErrorMessage] = useState('');\n  const [showPassword, setShowPassword] = useState(false);\n  \n  const { login, register } = useAuth();\n  const fadeAnim = useState(new Animated.Value(1))[0];\n\n  const [showReset, setShowReset] = useState(false);\n  const [resetTarget, setResetTarget] = useState('');\n  const [resetLoading, setResetLoading] = useState(false);\n  const [resetMessage, setResetMessage] = useState('');\n\n  const pulseAnim = useState(new Animated.Value(1))[0];\n  React.useEffect(() => {\n    const loop = Animated.loop(\n      Animated.sequence([\n        Animated.timing(pulseAnim, { toValue: 1.05, duration: 1500, useNativeDriver: true }),\n        Animated.timing(pulseAnim, { toValue: 1, duration: 1500, useNativeDriver: true }),\n      ])\n    );\n    loop.start();\n    return () => loop.stop();\n  }, [pulseAnim]);\n\n  // Fonction d√©sactiv√©e car l'endpoint n'existe pas sur le serveur\n  // const checkUsernameExists = async (usernameToCheck: string): Promise<boolean | null> => {\n  //   try {\n  //     const response = await fetch(`${API_BASE_URL}/api/users/exists/?username=${encodeURIComponent(usernameToCheck)}`);\n  //     if (response.ok) {\n  //       const data = await response.json();\n  //       if (typeof data.exists === 'boolean') return data.exists;\n  //     }\n  //     return null; // unknown\n  //   } catch (error) {\n  //     console.error('Error checking username:', error);\n  //     return null; // unknown\n  //   }\n  // };\n\n  const openReset = () => {\n    setResetTarget(username.includes('@') ? username : '');\n    setResetMessage('');\n    setShowReset(true);\n  };\n\n  const handleSendReset = async () => {\n    if (!resetTarget.trim()) {\n      setResetMessage(\"Entrez votre email pour recevoir le lien de r√©initialisation.\");\n      return;\n    }\n    try {\n      setResetLoading(true);\n      setResetMessage('');\n      const res = await fetch(`${API_BASE_URL}/api/auth/password/reset/`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ email: resetTarget.trim() }),\n      });\n      if (res.ok) {\n        setResetMessage(\"Si un compte existe pour cet email, un lien vient d'√™tre envoy√©.\");\n      } else {\n        setResetMessage(\"Impossible d'envoyer le lien pour le moment. R√©essayez plus tard.\");\n      }\n    } catch (e) {\n      setResetMessage(\"Erreur r√©seau. V√©rifiez votre connexion et r√©essayez.\");\n    } finally {\n      setResetLoading(false);\n    }\n  };\n\n  const handleAuth = async () => {\n    const u = username.trim();\n    const p = password;\n    const e = email.trim();\n\n    // Basic form requirements\n    if (!u || !p || (mode === 'register' && !e)) {\n      setErrorType('other');\n      setErrorMessage(!u || !p ? 'Veuillez remplir tous les champs' : \"L'email est requis pour l'inscription\");\n      return;\n    }\n\n    setIsLoading(true);\n    setErrorType('none');\n    setErrorMessage('');\n\n    try {\n      if (mode === 'login') {\n        // Tentative de connexion directe\n        await login(u, p);\n        router.replace('/(tabs)');\n        return;\n      }\n\n      // Register flow\n      await register({ username: u, password: p, email: e });\n      router.replace('/(tabs)');\n    } catch (err) {\n      // Pour les erreurs de connexion\n      if (mode === 'login') {\n        const errorMsg = err instanceof Error ? err.message : '';\n        // Si l'utilisateur n'existe pas, proposer de cr√©er un compte\n        if (errorMsg.toLowerCase().includes('utilisateur') || errorMsg.toLowerCase().includes('user')) {\n          setErrorType('user_not_found');\n          setErrorMessage('Utilisateur non trouv√©. Cr√©ez votre compte en cliquant sur \"S\\'inscrire\"');\n        } else {\n          setErrorType('wrong_password');\n          setErrorMessage(errorMsg || 'Identifiants incorrects');\n        }\n      } else {\n        setErrorType('other');\n        setErrorMessage(err instanceof Error ? err.message : 'Une erreur est survenue');\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const toggleMode = () => {\n    Animated.timing(fadeAnim, {\n      toValue: 0,\n      duration: 200,\n      useNativeDriver: true,\n    }).start(() => {\n      setMode(mode === 'login' ? 'register' : 'login');\n      setErrorType('none');\n      setErrorMessage('');\n      Animated.timing(fadeAnim, {\n        toValue: 1,\n        duration: 200,\n        useNativeDriver: true,\n      }).start();\n    });\n  };\n\n  return (\n    <KeyboardAvoidingView \n      style={styles.container} \n      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\n    >\n      <LinearGradient\n        colors={['rgba(240, 250, 248, 1)', 'rgba(200, 235, 225, 1)', 'rgba(100, 200, 180, 1)', 'rgba(10, 145, 104, 0.8)']}\n        style={styles.gradient}\n        start={{ x: 0, y: 0 }}\n        end={{ x: 1, y: 1 }}\n      >\n          <View style={styles.bgBubble1} />\n          <View style={styles.bgBubble2} />\n        <ScrollView \n          contentContainerStyle={styles.scrollContent}\n          showsVerticalScrollIndicator={false}\n          keyboardShouldPersistTaps=\"handled\"\n        >\n          {/* Logo/Header Section */}\n          <View style={styles.headerSection}>\n            <Animated.View style={[styles.logoContainer, { transform: [{ scale: pulseAnim }] }]}>\n              <Ionicons name=\"chatbubbles\" size={60} color=\"white\" />\n            </Animated.View>\n            <Text style={styles.appName}>Echo</Text>\n            <Text style={styles.appTagline}>\n              {mode === 'login' ? 'Bienvenue !' : 'Cr√©ez votre compte'}\n            </Text>\n          </View>\n\n          {/* Form Section */}\n          <LinearGradient style={styles.cardWrapper} colors={['rgba(75, 171, 80, 0.35)', 'rgba(9, 105, 12, 0.35)']} start={{ x: 0, y: 0 }} end={{ x: 1, y: 1 }}>\n            <Animated.View style={[styles.formCard, { opacity: fadeAnim }]}> \n              <Text style={styles.formTitle}>\n                {mode === 'login' ? 'Connexion' : 'Inscription'}\n              </Text>\n\n              {/* Username Input */}\n              <View style={styles.inputContainer}>\n                <Ionicons name=\"person-outline\" size={20} color=\"#999\" style={styles.inputIcon} />\n                <TextInput\n                  style={styles.input}\n                  placeholder=\"Nom d'utilisateur\"\n                  value={username}\n                  onChangeText={(text) => {\n                    setUsername(text);\n                    setErrorType('none');\n                  }}\n                  autoCapitalize=\"none\"\n                  autoCorrect={false}\n                  placeholderTextColor=\"#999\"\n                />\n              </View>\n\n              {/* Email Input (Register only) */}\n              {mode === 'register' && (\n                <View style={styles.inputContainer}>\n                  <Ionicons name=\"mail-outline\" size={20} color=\"#999\" style={styles.inputIcon} />\n                  <TextInput\n                    style={styles.input}\n                    placeholder=\"Email\"\n                    value={email}\n                    onChangeText={setEmail}\n                    autoCapitalize=\"none\"\n                    autoCorrect={false}\n                    keyboardType=\"email-address\"\n                    placeholderTextColor=\"#999\"\n                  />\n                </View>\n              )}\n\n              {/* Password Input */}\n              <View style={styles.inputContainer}>\n                <Ionicons name=\"lock-closed-outline\" size={20} color=\"#999\" style={styles.inputIcon} />\n                <TextInput\n                  style={styles.input}\n                  placeholder=\"Mot de passe\"\n                  value={password}\n                  onChangeText={(text) => {\n                    setPassword(text);\n                    setErrorType('none');\n                  }}\n                  secureTextEntry={!showPassword}\n                  placeholderTextColor=\"#999\"\n                />\n                <TouchableOpacity onPress={() => setShowPassword(!showPassword)} style={styles.eyeIcon}>\n                  <Ionicons \n                    name={showPassword ? \"eye-outline\" : \"eye-off-outline\"} \n                    size={20} \n                    color=\"#999\" \n                  />\n                </TouchableOpacity>\n              </View>\n\n              {/* Error Message */}\n              {errorMessage && (\n                <View style={[\n                  styles.errorContainer,\n                  errorType === 'user_not_found' && styles.infoContainer\n                ]}>\n                  <Ionicons \n                    name={errorType === 'user_not_found' ? 'information-circle' : 'alert-circle'} \n                    size={18} \n                    color={errorType === 'user_not_found' ? 'rgba(10, 145, 104, 1)' : '#ff6b6b'}\n                  />\n                  <Text style={[\n                    styles.errorText,\n                    errorType === 'user_not_found' && styles.infoText\n                  ]}>\n                    {errorMessage}\n                  </Text>\n                </View>\n              )}\n\n              {/* Forgot Password (only on wrong password) */}\n              {errorType === 'wrong_password' && (\n                <TouchableOpacity style={styles.forgotPassword} onPress={openReset}>\n                  <Text style={styles.forgotPasswordText}>Mot de passe oubli√© ?</Text>\n                </TouchableOpacity>\n              )}\n\n              {/* Submit Button */}\n              <TouchableOpacity \n                style={[styles.submitButton, isLoading && styles.submitButtonDisabled]}\n                onPress={handleAuth}\n                disabled={isLoading}\n              >\n                {isLoading ? (\n                  <ActivityIndicator color=\"white\" />\n                ) : (\n                  <>\n                    <Text style={styles.submitButtonText}>\n                      {mode === 'login' ? 'Se connecter' : 'Cr√©er mon compte'}\n                    </Text>\n                    <Ionicons name=\"arrow-forward\" size={20} color=\"white\" />\n                  </>\n                )}\n              </TouchableOpacity>\n\n              {/* Toggle Mode */}\n              <View style={styles.toggleContainer}>\n                <Text style={styles.toggleText}>\n                  {mode === 'login' \n                    ? 'Pas encore de compte ?' \n                    : 'D√©j√† un compte ?'}\n                </Text>\n                <TouchableOpacity onPress={toggleMode}>\n                  <Text style={styles.toggleButton}>\n                    {mode === 'login' ? 'S\\'inscrire' : 'Se connecter'}\n                  </Text>\n                </TouchableOpacity>\n              </View>\n            </Animated.View>\n          </LinearGradient>\n        </ScrollView>\n        <Modal visible={showReset} animationType=\"fade\" transparent onRequestClose={() => setShowReset(false)}>\n          <View style={styles.modalOverlay}>\n            <View style={styles.modalCard}>\n              <Text style={styles.modalTitle}>R√©initialiser le mot de passe</Text>\n              <View style={styles.modalInputContainer}>\n                <Ionicons name=\"mail-outline\" size={20} color=\"#999\" style={styles.inputIcon} />\n                <TextInput\n                  style={styles.modalInput}\n                  placeholder=\"Votre email\"\n                  value={resetTarget}\n                  onChangeText={setResetTarget}\n                  autoCapitalize=\"none\"\n                  keyboardType=\"email-address\"\n                  placeholderTextColor=\"#999\"\n                />\n              </View>\n              {!!resetMessage && <Text style={styles.modalSuccessText}>{resetMessage}</Text>}\n              <View style={styles.modalActions}>\n                <TouchableOpacity style={[styles.modalButton, styles.modalCancel]} onPress={() => setShowReset(false)}>\n                  <Text style={styles.modalButtonText}>Annuler</Text>\n                </TouchableOpacity>\n                <TouchableOpacity style={styles.modalButton} onPress={handleSendReset} disabled={resetLoading}>\n                  {resetLoading ? <ActivityIndicator color=\"#fff\" /> : <Text style={styles.modalButtonText}>Envoyer</Text>}\n                </TouchableOpacity>\n              </View>\n            </View>\n          </View>\n        </Modal>\n      </LinearGradient>\n    </KeyboardAvoidingView>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n  },\n  gradient: {\n    flex: 1,\n  },\n  bgBubble1: {\n    position: 'absolute',\n    width: 260,\n    height: 260,\n    borderRadius: 130,\n    backgroundColor: 'rgba(10, 145, 104, 0.25)',\n    top: 60,\n    left: -40,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 10 },\n    shadowOpacity: 0.3,\n    shadowRadius: 20,\n  },\n  bgBubble2: {\n    position: 'absolute',\n    width: 320,\n    height: 320,\n    borderRadius: 160,\n    backgroundColor: 'rgba(10, 145, 104, 0.2)',\n    bottom: -40,\n    right: -60,\n    shadowColor: 'rgba(10, 145, 104, 0.4)',\n    shadowOffset: { width: 0, height: 10 },\n    shadowOpacity: 0.25,\n    shadowRadius: 20,\n  },\n  scrollContent: {\n    flexGrow: 1,\n    justifyContent: 'center',\n    padding: 20,\n  },\n  headerSection: {\n    alignItems: 'center',\n    marginBottom: 40,\n  },\n  logoContainer: {\n    width: 100,\n    height: 100,\n    borderRadius: 50,\n    backgroundColor: 'rgba(255, 255, 255, 0.2)',\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginBottom: 20,\n  },\n  appName: {\n    fontSize: 48,\n    fontWeight: 'bold',\n    color: 'white',\n    marginBottom: 5,\n  },\n  appTagline: {\n    fontSize: 18,\n    color: 'rgba(255, 255, 255, 0.9)',\n  },\n  cardWrapper: {\n    borderRadius: 28,\n    padding: 2,\n    marginHorizontal: 2,\n    marginBottom: 4,\n  },\n  formCard: {\n    backgroundColor: 'rgba(255,255,255,0.94)',\n    borderRadius: 26,\n    padding: 26,\n    shadowColor: '#000',\n    shadowOffset: { width: 0, height: 10 },\n    shadowOpacity: 0.25,\n    shadowRadius: 22,\n    elevation: 10,\n    backdropFilter: 'blur(8px)',\n  },\n  formTitle: {\n    fontSize: 24,\n    fontWeight: 'bold',\n    color: '#333',\n    marginBottom: 25,\n    textAlign: 'center',\n  },\n  inputContainer: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    borderWidth: 1.5,\n    borderColor: 'rgba(200, 235, 225, 1)',\n    borderRadius: 12,\n    marginBottom: 15,\n    paddingHorizontal: 15,\n    backgroundColor: 'rgba(240, 250, 248, 1)',\n  },\n  inputIcon: {\n    marginRight: 10,\n  },\n  input: {\n    flex: 1,\n    paddingVertical: 15,\n    fontSize: 16,\n    color: '#333',\n  },\n  eyeIcon: {\n    padding: 5,\n  },\n  errorContainer: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    backgroundColor: '#ffebee',\n    padding: 12,\n    borderRadius: 8,\n    marginBottom: 10,\n  },\n  infoContainer: {\n    backgroundColor: 'rgba(235, 248, 245, 1)',\n  },\n  errorText: {\n    flex: 1,\n    marginLeft: 8,\n    color: '#ff6b6b',\n    fontSize: 14,\n  },\n  infoText: {\n    color: 'rgba(10, 145, 104, 1)',\n  },\n  forgotPassword: {\n    alignSelf: 'flex-end',\n    marginBottom: 15,\n  },\n  forgotPasswordText: {\n    color: 'rgba(10, 145, 104, 1)',\n    fontSize: 14,\n    fontWeight: '600',\n  },\n  submitButton: {\n    backgroundColor: 'rgba(10, 145, 104, 1)',\n    borderRadius: 12,\n    paddingVertical: 16,\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginTop: 10,\n    shadowColor: 'rgba(10, 145, 104, 0.6)',\n    shadowOffset: { width: 0, height: 4 },\n    shadowOpacity: 0.3,\n    shadowRadius: 8,\n    elevation: 5,\n  },\n  submitButtonDisabled: {\n    opacity: 0.6,\n  },\n  submitButtonText: {\n    color: 'white',\n    fontSize: 16,\n    fontWeight: 'bold',\n    marginRight: 10,\n  },\n  toggleContainer: {\n    flexDirection: 'row',\n    justifyContent: 'center',\n    alignItems: 'center',\n    marginTop: 20,\n  },\n  toggleText: {\n    color: '#666',\n    fontSize: 14,\n    marginRight: 5,\n  },\n  toggleButton: {\n    color: 'rgba(10, 145, 104, 1)',\n    fontSize: 14,\n    fontWeight: 'bold',\n  },\n  modalOverlay: {\n    flex: 1,\n    backgroundColor: 'rgba(0,0,0,0.25)',\n    justifyContent: 'center',\n    alignItems: 'center',\n    padding: 24,\n  },\n  modalCard: {\n    width: '100%',\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.6)',\n    shadowOffset: { width: 0, height: 8 },\n    shadowOpacity: 0.2,\n    shadowRadius: 16,\n    elevation: 8,\n  },\n  modalTitle: {\n    fontSize: 18,\n    fontWeight: '700',\n    color: 'rgba(10, 145, 104, 1)',\n    marginBottom: 12,\n    textAlign: 'center',\n  },\n  modalInputContainer: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    borderWidth: 1.5,\n    borderColor: 'rgba(200, 235, 225, 1)',\n    borderRadius: 10,\n    paddingHorizontal: 12,\n    backgroundColor: 'rgba(240, 250, 248, 1)',\n    marginBottom: 12,\n  },\n  modalInput: {\n    flex: 1,\n    paddingVertical: 12,\n    fontSize: 16,\n    color: '#333',\n  },\n  modalActions: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    marginTop: 6,\n  },\n  modalButton: {\n    flex: 1,\n    backgroundColor: 'rgba(10, 145, 104, 1)',\n    paddingVertical: 12,\n    borderRadius: 10,\n    alignItems: 'center',\n    marginLeft: 8,\n  },\n  modalCancel: {\n    backgroundColor: 'rgba(100, 200, 180, 0.8)',\n    marginLeft: 0,\n    marginRight: 8,\n  },\n  modalButtonText: {\n    color: 'white',\n    fontWeight: '700',\n    fontSize: 15,\n  },\n  modalSuccessText: {\n    color: 'rgba(10, 145, 104, 1)',\n    textAlign: 'center',\n    marginBottom: 8,\n  },\n});","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(screens)/_layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(screens)/add-group-members.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'groupName', 'groupUuid', and 'loadGroupMembers'. Either include them or remove the dependency array.","line":55,"column":6,"nodeType":"ArrayExpression","endLine":55,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [groupName, groupUuid, loadGroupMembers]","fix":{"range":[1729,1731],"text":"[groupName, groupUuid, loadGroupMembers]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'searchUsers'. Either include it or remove the dependency array.","line":67,"column":6,"nodeType":"ArrayExpression","endLine":67,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [query, searchUsers]","fix":{"range":[1968,1975],"text":"[query, searchUsers]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":340,"column":47,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11872,11920],"text":"\n            Aucun utilisateur ne correspond √† &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11872,11920],"text":"\n            Aucun utilisateur ne correspond √† &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11872,11920],"text":"\n            Aucun utilisateur ne correspond √† &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11872,11920],"text":"\n            Aucun utilisateur ne correspond √† &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":340,"column":55,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[11927,11939],"text":"&quot;\n          "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[11927,11939],"text":"&ldquo;\n          "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[11927,11939],"text":"&#34;\n          "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[11927,11939],"text":"&rdquo;\n          "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { styles } from '@/styles/appStyles';\nimport { Ionicons } from '@expo/vector-icons';\nimport { Image } from 'expo-image';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { router, useLocalSearchParams } from 'expo-router';\nimport React, { useEffect, useState } from 'react';\nimport {\n    ActivityIndicator,\n    Alert,\n    FlatList,\n    StyleSheet,\n    Text,\n    TextInput,\n    TouchableOpacity,\n    View\n} from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport { useAuth } from '../../contexts/AuthContext';\n\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\ninterface User {\n  id: number;\n  uuid: string;\n  username: string;\n  surnom?: string;\n  photo_profil_url?: string;\n}\n\ninterface GroupMember {\n  user_uuid: string;\n  username: string;\n  surnom?: string;\n}\n\nexport default function AddGroupMembers() {\n  const { groupUuid, groupName } = useLocalSearchParams();\n  const { makeAuthenticatedRequest } = useAuth();\n  const insets = useSafeAreaInsets();\n  \n  const [query, setQuery] = useState('');\n  const [searchResults, setSearchResults] = useState<User[]>([]);\n  const [isSearching, setIsSearching] = useState(false);\n  const [selectedUsers, setSelectedUsers] = useState<Set<string>>(new Set());\n  const [groupMembers, setGroupMembers] = useState<Set<string>>(new Set());\n  const [loading, setLoading] = useState(true);\n  const [sending, setSending] = useState(false);\n\n  useEffect(() => {\n    console.log('üÜï Page add-group-members mont√©e');\n    console.log('üìã Params re√ßus:', { groupUuid, groupName });\n    loadGroupMembers();\n  }, []);\n\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      if (query.trim()) {\n        searchUsers(query);\n      } else {\n        setSearchResults([]);\n      }\n    }, 300);\n    \n    return () => clearTimeout(timeoutId);\n  }, [query]);\n\n  const loadGroupMembers = async () => {\n    try {\n      console.log('üì° Chargement membres du groupe:', groupUuid);\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/${groupUuid}/members/`\n      );\n      \n      if (response.ok) {\n        const members = await response.json();\n        console.log('üìã Membres re√ßus:', members);\n        const memberUuids = new Set<string>(members.map((m: GroupMember) => m.user_uuid));\n        setGroupMembers(memberUuids);\n        console.log('üë• Membres actuels du groupe:', memberUuids.size, Array.from(memberUuids));\n      } else {\n        console.error('‚ùå Erreur chargement membres:', response.status);\n        const errorData = await response.json().catch(() => ({}));\n        console.error('‚ùå D√©tails erreur:', errorData);\n      }\n    } catch (error) {\n      console.error('‚ùå Erreur chargement membres:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const searchUsers = async (searchQuery: string) => {\n    setIsSearching(true);\n    try {\n      console.log('üîç Recherche utilisateurs avec query:', searchQuery);\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/api/users/`\n      );\n\n      if (!response.ok) {\n        console.error('‚ùå Erreur recherche utilisateurs:', response.status);\n        throw new Error(`Erreur ${response.status}`);\n      }\n\n      const data = await response.json();\n      let allUsers: User[] = Array.isArray(data) ? data : (data.results || []);\n      console.log('üìã Total utilisateurs:', allUsers.length);\n      \n      // Filtrer par surnom ou username\n      const users = allUsers.filter(u => {\n        const surnom = (u.surnom || '').toLowerCase();\n        const username = (u.username || '').toLowerCase();\n        const q = searchQuery.toLowerCase();\n        return surnom.includes(q) || username.includes(q);\n      });\n      console.log('üìã Utilisateurs correspondants:', users.length);\n      \n      // Exclure les membres d√©j√† dans le groupe\n      const availableUsers = users.filter(u => !groupMembers.has(u.uuid));\n      \n      setSearchResults(availableUsers);\n      console.log('‚úÖ Utilisateurs disponibles (apr√®s exclusion membres):', availableUsers.length);\n      console.log('üìã Preview:', availableUsers.slice(0, 3).map(u => u.surnom || u.username));\n    } catch (error) {\n      console.error('‚ùå Erreur recherche utilisateurs:', error);\n    } finally {\n      setIsSearching(false);\n    }\n  };\n\n  const toggleUserSelection = (userUuid: string) => {\n    setSelectedUsers(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(userUuid)) {\n        newSet.delete(userUuid);\n      } else {\n        newSet.add(userUuid);\n      }\n      return newSet;\n    });\n  };\n\n  const handleInvite = async () => {\n    if (selectedUsers.size === 0) {\n      Alert.alert('Aucune s√©lection', 'Veuillez s√©lectionner au moins un utilisateur');\n      return;\n    }\n\n    setSending(true);\n    try {\n      console.log('üì§ Envoi invitations pour:', selectedUsers.size, 'utilisateurs');\n      console.log('üì§ Groupe UUID:', groupUuid);\n      console.log('üì§ Groupe Nom:', groupName);\n      console.log('üì§ UUIDs utilisateurs:', Array.from(selectedUsers));\n      console.log('üì§ URL compl√®te:', `${API_BASE_URL}/groups/${groupUuid}/invite/`);\n      \n      // Envoyer une invitation pour chaque utilisateur s√©lectionn√©\n      const invitations = Array.from(selectedUsers).map(async userUuid => {\n        console.log('üì® Envoi invitation pour:', userUuid);\n        \n        const payload = {\n          user_uuid: userUuid,\n          message: `Invitation √† rejoindre ${groupName}`\n        };\n        console.log('üì® Payload:', JSON.stringify(payload, null, 2));\n        \n        const response = await makeAuthenticatedRequest(\n          `${API_BASE_URL}/groups/${groupUuid}/invite/`,\n          {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload)\n          }\n        );\n        \n        console.log('üì® R√©ponse statut pour', userUuid, ':', response.status);\n        \n        if (!response.ok) {\n          const errorData = await response.json().catch(() => ({}));\n          console.error('‚ùå Erreur invitation:', {\n            userUuid,\n            status: response.status,\n            errorData: JSON.stringify(errorData, null, 2)\n          });\n          return { success: false, userUuid, error: errorData, status: response.status };\n        }\n        \n        const data = await response.json();\n        console.log('‚úÖ Invitation envoy√©e:', {\n          userUuid,\n          responseData: data\n        });\n        return { success: true, userUuid };\n      });\n\n      const results = await Promise.all(invitations);\n      const successCount = results.filter(r => r.success).length;\n      const failedCount = results.length - successCount;\n      \n      console.log('üìä R√©sultats finaux:', { successCount, failedCount, total: results.length });\n      \n      if (successCount > 0) {\n        const message = failedCount > 0\n          ? `${successCount} invitation(s) envoy√©e(s), ${failedCount} √©chec(s)`\n          : `${successCount} invitation(s) envoy√©e(s) avec succ√®s !`;\n        \n        Alert.alert(\n          'Invitations envoy√©es',\n          message,\n          [{ text: 'OK', onPress: () => router.back() }]\n        );\n      } else {\n        const firstError = results.find(r => !r.success);\n        const errorMsg = firstError?.error?.detail || firstError?.error?.error || \n                        (firstError?.error && typeof firstError.error === 'object' \n                          ? JSON.stringify(firstError.error) \n                          : 'Erreur inconnue');\n        console.error('‚ùå Message d\\'erreur final:', errorMsg);\n        Alert.alert(\n          'Erreur', \n          `Impossible d'envoyer les invitations.\\nStatut: ${firstError?.status}\\nD√©tails: ${errorMsg}`\n        );\n      }\n    } catch (error) {\n      console.error('‚ùå Erreur globale envoi invitations:', error);\n      Alert.alert('Erreur', `Impossible d'envoyer les invitations: ${error}`);\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const UserSquare = ({ user }: { user: User }) => {\n    const isSelected = selectedUsers.has(user.uuid);\n    \n    return (\n      <TouchableOpacity\n        style={[\n          styles.conversationSquare,\n          isSelected && localStyles.userSquareSelected\n        ]}\n        onPress={() => toggleUserSelection(user.uuid)}\n        activeOpacity={0.7}\n      >\n        {user.photo_profil_url ? (\n          <Image source={{ uri: user.photo_profil_url }} style={styles.avatar} />\n        ) : (\n          <View style={[styles.avatar, { backgroundColor: 'rgba(10, 145, 104, 0.2)', justifyContent: 'center', alignItems: 'center' }]}>\n            <Ionicons name=\"person\" size={50} color=\"rgba(10, 145, 104, 1)\" />\n          </View>\n        )}\n        \n        {isSelected && (\n          <View style={localStyles.selectedBadge}>\n            <Ionicons name=\"checkmark-circle\" size={28} color=\"rgba(10, 145, 104, 1)\" />\n          </View>\n        )}\n        \n        <View style={styles.conversationNameBadge}>\n          <Text style={styles.conversationName} numberOfLines={1}>\n            {user.surnom || user.username}\n          </Text>\n        </View>\n      </TouchableOpacity>\n    );\n  };\n\n  if (loading) {\n    return (\n      <View style={[localStyles.container, { paddingTop: (insets.top || 0), justifyContent: 'center', alignItems: 'center' }]}>\n        <ActivityIndicator size=\"large\" color=\"rgba(10, 145, 104, 1)\" />\n      </View>\n    );\n  }\n\n  return (\n    <View style={[localStyles.container, { paddingTop: (insets.top || 0) }]}>\n      {/* Bouton retour flottant */}\n      <TouchableOpacity\n        style={localStyles.floatingBackButton}\n        onPress={() => router.back()}\n      >\n        <LinearGradient\n          colors={['rgba(10, 145, 104, 0.95)', 'rgba(10, 145, 104, 0.85)']}\n          style={localStyles.backButtonGradient}\n        >\n          <Ionicons name=\"arrow-back\" size={24} color=\"#fff\" />\n        </LinearGradient>\n      </TouchableOpacity>\n\n      {/* Header flottant */}\n      <LinearGradient\n        colors={['rgba(10, 145, 104, 0.95)', 'rgba(10, 145, 104, 0.85)']}\n        style={localStyles.floatingHeader}\n      >\n        <Ionicons name=\"person-add\" size={20} color=\"#fff\" />\n        <Text style={localStyles.headerTitle}>\n          Ajouter des membres\n        </Text>\n      </LinearGradient>\n\n      {/* Info groupe */}\n      <View style={localStyles.groupInfoBadge}>\n        <Ionicons name=\"people\" size={16} color=\"rgba(10, 145, 104, 1)\" />\n        <Text style={localStyles.groupNameText}>{groupName}</Text>\n      </View>\n\n      {/* Barre de recherche style app */}\n      <View style={localStyles.searchContainer}>\n        <TextInput\n          style={localStyles.searchInput}\n          placeholder=\"Rechercher un utilisateur...\"\n          placeholderTextColor=\"#777\"\n          value={query}\n          onChangeText={setQuery}\n        />\n      </View>\n\n      {/* Liste des utilisateurs */}\n      {isSearching ? (\n        <View style={localStyles.loadingContainer}>\n          <ActivityIndicator size=\"large\" color=\"rgba(10, 145, 104, 1)\" />\n          <Text style={localStyles.loadingText}>Recherche en cours...</Text>\n        </View>\n      ) : searchResults.length > 0 ? (\n        <FlatList\n          data={searchResults}\n          keyExtractor={(item) => item.uuid}\n          renderItem={({ item }) => <UserSquare user={item} />}\n          numColumns={3}\n          columnWrapperStyle={styles.row}\n          contentContainerStyle={localStyles.grid}\n        />\n      ) : query.trim().length > 0 ? (\n        <View style={localStyles.emptyContainer}>\n          <Ionicons name=\"search-outline\" size={64} color=\"#ccc\" />\n          <Text style={localStyles.emptyTitle}>Aucun r√©sultat</Text>\n          <Text style={localStyles.emptyText}>\n            Aucun utilisateur ne correspond √† \"{query}\"\n          </Text>\n        </View>\n      ) : (\n        <View style={localStyles.emptyContainer}>\n          <Ionicons name=\"person-add-outline\" size={64} color=\"rgba(10, 145, 104, 0.3)\" />\n          <Text style={localStyles.emptyTitle}>Rechercher des utilisateurs</Text>\n          <Text style={localStyles.emptyText}>\n            Utilisez la barre de recherche pour trouver des personnes √† inviter dans le groupe\n          </Text>\n        </View>\n      )}\n\n      {/* Bouton d'invitation flottant */}\n      {selectedUsers.size > 0 && (\n        <TouchableOpacity\n          style={localStyles.floatingInviteButton}\n          onPress={handleInvite}\n          activeOpacity={0.8}\n          disabled={sending}\n        >\n          <LinearGradient\n            colors={sending \n              ? ['rgba(10, 145, 104, 0.6)', 'rgba(10, 145, 104, 0.5)']\n              : ['rgba(10, 145, 104, 1)', 'rgba(10, 145, 104, 0.9)']\n            }\n            style={localStyles.inviteButtonGradient}\n          >\n            {sending ? (\n              <>\n                <ActivityIndicator size=\"small\" color=\"#fff\" />\n                <Text style={localStyles.inviteButtonText}>\n                  Envoi en cours...\n                </Text>\n              </>\n            ) : (\n              <>\n                <Ionicons name=\"send\" size={24} color=\"#fff\" />\n                <Text style={localStyles.inviteButtonText}>\n                  Inviter {selectedUsers.size} personne{selectedUsers.size > 1 ? 's' : ''}\n                </Text>\n              </>\n            )}\n          </LinearGradient>\n        </TouchableOpacity>\n      )}\n    </View>\n  );\n}\n\nconst localStyles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: 'rgba(245,250,245,0.9)',\n  },\n  floatingBackButton: {\n    position: 'absolute',\n    top: 70,\n    left: 20,\n    zIndex: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 6 },\n    shadowOpacity: 0.6,\n    shadowRadius: 12,\n    elevation: 10,\n  },\n  backButtonGradient: {\n    width: 48,\n    height: 48,\n    borderRadius: 24,\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  floatingHeader: {\n    position: 'absolute',\n    top: 70,\n    left: 84,\n    right: 20,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    gap: 8,\n    paddingVertical: 14,\n    paddingHorizontal: 20,\n    borderRadius: 24,\n    zIndex: 10,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 6 },\n    shadowOpacity: 0.6,\n    shadowRadius: 12,\n    elevation: 10,\n  },\n  headerTitle: {\n    fontSize: 16,\n    fontWeight: 'bold',\n    color: '#fff',\n  },\n  groupInfoBadge: {\n    position: 'absolute',\n    top: 132,\n    left: 20,\n    right: 20,\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 8,\n    backgroundColor: 'rgba(10, 145, 104, 0.1)',\n    paddingHorizontal: 16,\n    paddingVertical: 10,\n    borderRadius: 20,\n    zIndex: 5,\n  },\n  groupNameText: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: 'rgba(10, 145, 104, 1)',\n  },\n  searchContainer: {\n    position: 'absolute',\n    top: 178,\n    left: 20,\n    right: 20,\n    backgroundColor: 'rgba(255,255,255,0.6)',\n    borderRadius: 25,\n    shadowColor: '#fff',\n    shadowOpacity: 0.9,\n    elevation: 5,\n    paddingHorizontal: 15,\n    paddingVertical: 5,\n    zIndex: 10,\n  },\n  searchInput: {\n    fontSize: 16,\n    paddingVertical: 8,\n    color: '#333',\n  },\n  grid: {\n    paddingTop: 235,\n    paddingBottom: 200,\n    paddingHorizontal: 10,\n  },\n  userSquareSelected: {\n    shadowColor: 'rgba(10, 145, 104, 0.8)',\n    shadowOpacity: 1,\n    shadowRadius: 8,\n    elevation: 8,\n    transform: [{ scale: 0.98 }],\n  },\n  selectedBadge: {\n    position: 'absolute',\n    top: 8,\n    right: 8,\n    backgroundColor: '#fff',\n    borderRadius: 14,\n    zIndex: 10,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.5,\n    shadowRadius: 4,\n    elevation: 5,\n  },\n  floatingInviteButton: {\n    position: 'absolute',\n    bottom: 100,\n    left: 20,\n    right: 20,\n    zIndex: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 6 },\n    shadowOpacity: 0.6,\n    shadowRadius: 12,\n    elevation: 10,\n  },\n  inviteButtonGradient: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    gap: 10,\n    paddingVertical: 16,\n    paddingHorizontal: 24,\n    borderRadius: 28,\n  },\n  inviteButtonText: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: 'bold',\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    paddingTop: 200,\n  },\n  loadingText: {\n    marginTop: 15,\n    fontSize: 15,\n    color: '#666',\n  },\n  emptyContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    paddingHorizontal: 40,\n    paddingTop: 100,\n  },\n  emptyTitle: {\n    fontSize: 22,\n    fontWeight: 'bold',\n    color: '#333',\n    marginTop: 20,\n    textAlign: 'center',\n  },\n  emptyText: {\n    fontSize: 15,\n    color: '#666',\n    textAlign: 'center',\n    marginTop: 12,\n    lineHeight: 22,\n  },\n});\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(screens)/calendar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pad' is assigned a value but never used.","line":305,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":305,"endColumn":12},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'generateCalendarDays'. Either include it or remove the dependency array.","line":397,"column":62,"nodeType":"ArrayExpression","endLine":397,"endColumn":79,"suggestions":[{"desc":"Update the dependencies array to be: [generateCalendarDays]","fix":{"range":[13906,13923],"text":"[generateCalendarDays]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has missing dependencies: 'selWeekEnd' and 'selWeekStart'. Either include them or remove the dependency array.","line":412,"column":6,"nodeType":"ArrayExpression","endLine":412,"endColumn":59,"suggestions":[{"desc":"Update the dependencies array to be: [monthData.events, selWeekStart, selWeekEnd]","fix":{"range":[14673,14726],"text":"[monthData.events, selWeekStart, selWeekEnd]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'currentMonth' and 'fetchMonthEvents'. Either include them or remove the dependency array.","line":216,"column":6,"nodeType":"ArrayExpression","endLine":216,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [currentMonth, fetchMonthEvents]","fix":{"range":[7803,7805],"text":"[currentMonth, fetchMonthEvents]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ECHO_COLOR } from '@/constants/colors';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Ionicons } from '@expo/vector-icons';\nimport React, { useEffect, useMemo, useRef, useState } from 'react';\nimport {\n    ActivityIndicator,\n    Alert,\n    Animated,\n    Easing,\n    Modal,\n    Platform,\n    RefreshControl,\n    ScrollView,\n    StyleSheet,\n    Text,\n    TextInput,\n    TouchableOpacity,\n    View,\n} from 'react-native';\nimport { SafeAreaView } from 'react-native-safe-area-context';\n\n// Utilise le proxy local pour √©viter CORS en d√©veloppement web\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\ninterface CalendarEvent {\n  id: number;\n  titre: string;\n  description: string;\n  date_debut: string;\n  date_fin: string;\n  type: 'professionnel' | 'personnel' | 'anniversaire' | 'autre';\n  lieu?: string;\n  is_all_day: boolean;\n  rappel_minutes?: number;\n  created_at: string;\n  updated_at: string;\n}\n\ninterface MonthData {\n  year: number;\n  month: number;\n  events: CalendarEvent[];\n  total: number;\n}\n\nconst MONTHS = [\n  'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',\n  'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'\n];\nconst WEEKDAYS = ['L', 'M', 'M', 'J', 'V', 'S', 'D']; // Monday -> Sunday (FR)\nconst THEME = {\n  green: ECHO_COLOR,\n  greenSoft: '#f6fbf6',\n  text: '#375a3b',\n  sub: '#6b7c6d',\n  card: '#ffffff',\n};\n\n// --- Debug helpers ---\nconst DEBUG_CAL = true;\nconst log = (...args: any[]) => DEBUG_CAL && console.log('[CAL]', ...args);\nconst logErr = (...args: any[]) => DEBUG_CAL && console.error('[CAL][ERR]', ...args);\n\n// Format a local date as YYYY-MM-DD (no timezone conversion)\nconst fmtLocalDate = (d: Date) => {\n  const y = d.getFullYear();\n  const m = String(d.getMonth() + 1).padStart(2, '0');\n  const day = String(d.getDate()).padStart(2, '0');\n  return `${y}-${m}-${day}`;\n};\n\nconst EVENT_TYPES_COLORS: Record<string, string> = {\n  professionnel: '#3a7d44', // deep moss\n  personnel: '#5aa469',     // fresh leaf\n  anniversaire: '#7fb685',   // soft mint\n  autre: '#9bb89f',          // sage gray‚Äëgreen\n};\n\nexport default function CalendarScreen() {\n  const { makeAuthenticatedRequest } = useAuth();\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const [monthData, setMonthData] = useState<MonthData | null>(null);\n  const [selectedDate, setSelectedDate] = useState<Date>(new Date());\n  const [currentMonth, setCurrentMonth] = useState(new Date());\n\n  const [animMonth] = useState(new Animated.Value(0));\n  const [isAnimatingMonth, setIsAnimatingMonth] = useState(false);\n\n  const [showCreate, setShowCreate] = useState(false);\n  const [newTitle, setNewTitle] = useState('');\n  const [newType, setNewType] = useState<CalendarEvent['type']>('autre');\n  const [startTime, setStartTime] = useState('09:00');\n  const [endTime, setEndTime] = useState('10:00');\n  const [submitting, setSubmitting] = useState(false);\n  const [createdEventIds, setCreatedEventIds] = useState<Set<number>>(new Set());\n\n  // R√©cup√©rer les √©v√©nements du mois\n  const fetchMonthEvents = async (date: Date) => {\n    try {\n      const year = date.getFullYear();\n      const month = date.getMonth() + 1;\n      const url = `${API_BASE_URL}/calendrier/month/?year=${year}&month=${month}`;\n      log('fetchMonthEvents ->', { year, month, url });\n\n      const response = await makeAuthenticatedRequest(url);\n      log('fetchMonthEvents response status', response?.status);\n\n      if (!response.ok) {\n        const txt = await response.text().catch(() => '');\n        throw new Error(`HTTP ${response.status} ${txt}`);\n      }\n\n      const raw = await response.json();\n      log('fetchMonthEvents raw', raw);\n\n      // Normalize server payload (supports several possible shapes)\n      let eventsRaw: any[] = [];\n      let normYear = date.getFullYear();\n      let normMonth = date.getMonth() + 1;\n\n      if (Array.isArray(raw)) {\n        eventsRaw = raw;\n      } else if (raw && Array.isArray(raw.events)) {\n        eventsRaw = raw.events;\n        if (typeof raw.year === 'number') normYear = raw.year;\n        if (typeof raw.month === 'number') normMonth = raw.month;\n      } else if (raw && Array.isArray(raw.evenements)) {\n        eventsRaw = raw.evenements;\n        if (typeof raw.annee === 'number') normYear = raw.annee;\n        if (typeof raw.mois === 'number') normMonth = raw.mois;\n      } else if (raw && raw.evenements_par_jour && typeof raw.evenements_par_jour === 'object') {\n        // Shape: { evenements_par_jour: { '13': [ {...}, ... ], ... }, month, year }\n        const byDay = raw.evenements_par_jour as Record<string, any[]>;\n        if (typeof raw.year === 'number') normYear = raw.year;\n        if (typeof raw.month === 'number') normMonth = raw.month;\n        const acc: any[] = [];\n        Object.entries(byDay).forEach(([dayKey, arr]) => {\n          if (!Array.isArray(arr)) return;\n          const dayNum = parseInt(dayKey, 10);\n          const yyyy = normYear;\n          const mm = String(normMonth).padStart(2, '0');\n          const dd = String(dayNum).padStart(2, '0');\n          arr.forEach((ev) => {\n            // If backend omitted full datetime, try to build from day + heure fields\n            let dateDebut = ev.date_debut ?? ev.start ?? ev.start_at ?? ev.startDate;\n            let dateFin = ev.date_fin ?? ev.end ?? ev.end_at ?? ev.endDate;\n            if (!dateDebut && (ev.heure_debut || ev.heureDebut)) {\n              const hhmm = (ev.heure_debut || ev.heureDebut).toString().padStart(5, '0');\n              dateDebut = `${yyyy}-${mm}-${dd}T${hhmm}:00`;\n            }\n            if (!dateFin && (ev.heure_fin || ev.heureFin)) {\n              const hhmm = (ev.heure_fin || ev.heureFin).toString().padStart(5, '0');\n              dateFin = `${yyyy}-${mm}-${dd}T${hhmm}:00`;\n            }\n            acc.push({\n              ...ev,\n              date_debut: dateDebut,\n              date_fin: dateFin,\n              type: ev.type ?? ev.type_evenement ?? 'autre',\n            });\n          });\n        });\n        eventsRaw = acc;\n      } else if (raw && Array.isArray(raw.results)) {\n        eventsRaw = raw.results;\n      } else if (raw && raw.data && Array.isArray(raw.data)) {\n        eventsRaw = raw.data;\n      }\n\n      const events = eventsRaw.map((ev: any) => ({\n        id: ev.id,\n        titre: ev.titre ?? ev.title ?? '',\n        description: ev.description ?? '',\n        date_debut: ev.date_debut ?? ev.start ?? ev.start_at ?? ev.startDate,\n        date_fin: ev.date_fin ?? ev.end ?? ev.end_at ?? ev.endDate,\n        type: ev.type ?? ev.type_evenement ?? 'autre',\n        lieu: ev.lieu ?? ev.location,\n        is_all_day: Boolean(ev.is_all_day ?? ev.all_day ?? false),\n        rappel_minutes: typeof ev.rappel_minutes === 'number' ? ev.rappel_minutes : undefined,\n        created_at: ev.created_at ?? ev.date_creation,\n        updated_at: ev.updated_at ?? ev.date_modification,\n      }));\n\n      log('fetchMonthEvents normalized', { count: events.length, first: events[0] });\n\n      setMonthData({\n        year: normYear,\n        month: normMonth,\n        events,\n        total: events.length,\n      });\n    } catch (error) {\n      logErr('Erreur chargement √©v√©nements du mois:', error);\n      setMonthData({\n        year: date.getFullYear(),\n        month: date.getMonth() + 1,\n        events: [],\n        total: 0,\n      });\n    }\n  };\n\n\n  // Charger les donn√©es initiales\n  useEffect(() => {\n    const loadData = async () => {\n      setLoading(true);\n      log('Initial load for month', { currentMonth: currentMonth.toString() });\n      await fetchMonthEvents(currentMonth);\n      setLoading(false);\n    };\n    loadData();\n  }, []); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // Rafra√Æchir les donn√©es\n  const onRefresh = async () => {\n    setRefreshing(true);\n    log('Pull-to-refresh for', { month: currentMonth.getMonth() + 1, year: currentMonth.getFullYear() });\n    await fetchMonthEvents(currentMonth);\n    setRefreshing(false);\n  };\n\n  // Animate month transitions\n  const changeMonth = async (direction: 'prev' | 'next') => {\n    if (isAnimatingMonth) return;\n    log('changeMonth', direction);\n    setIsAnimatingMonth(true);\n    const toValue = direction === 'next' ? -1 : 1; // slide left on next\n    animMonth.setValue(0);\n    Animated.timing(animMonth, {\n      toValue,\n      duration: 220,\n      easing: Easing.out(Easing.cubic),\n      useNativeDriver: true,\n    }).start(async () => {\n      const newMonth = new Date(currentMonth);\n      newMonth.setMonth(newMonth.getMonth() + (direction === 'next' ? 1 : -1));\n      setCurrentMonth(newMonth);\n      log('changeMonth -> new month', newMonth.toString());\n      await fetchMonthEvents(newMonth);\n      animMonth.setValue(-toValue);\n      Animated.timing(animMonth, {\n        toValue: 0,\n        duration: 220,\n        easing: Easing.out(Easing.cubic),\n        useNativeDriver: true,\n      }).start(() => setIsAnimatingMonth(false));\n    });\n  };\n\n  // S√©lectionner un jour\n  const selectDay = (day: number) => {\n    const newDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);\n    setSelectedDate(newDate);\n  };\n\n  // G√©n√©rer les jours du calendrier (Monday first)\n  const generateCalendarDays = () => {\n    const year = currentMonth.getFullYear();\n    const month = currentMonth.getMonth();\n\n    const firstDay = new Date(year, month, 1);\n    const lastDay = new Date(year, month + 1, 0);\n    const daysInMonth = lastDay.getDate();\n\n    // Make Monday the first day: JS getDay() => Sun=0..Sat=6; convert to Mon=0..Sun=6\n    const startingDayOfWeek = (firstDay.getDay() + 6) % 7;\n\n    const days: (number | null)[] = [];\n    for (let i = 0; i < startingDayOfWeek; i++) days.push(null);\n    for (let i = 1; i <= daysInMonth; i++) days.push(i);\n    return days;\n  };\n\n  // Count events for a day\n  const countEventsForDay = (day: number): number => {\n    if (!monthData || !monthData.events?.length) return 0;\n    const cellDate = new Date(\n      currentMonth.getFullYear(),\n      currentMonth.getMonth(),\n      day,\n      0, 0, 0, 0\n    );\n    const cellKey = fmtLocalDate(cellDate);\n    const count = monthData.events.filter(ev => {\n      const evKey = fmtLocalDate(new Date(ev.date_debut));\n      return evKey === cellKey;\n    }).length;\n    log('countEventsForDay', { day, cellKey, count });\n    return count;\n  };\n\n  // V√©rifier si c'est le jour s√©lectionn√©\n  const isSelectedDay = (day: number): boolean => {\n    return (\n      day === selectedDate.getDate() &&\n      currentMonth.getMonth() === selectedDate.getMonth() &&\n      currentMonth.getFullYear() === selectedDate.getFullYear()\n    );\n  };\n\n  const pad = (n: number) => (n < 10 ? `0${n}` : `${n}`);\n  const toIsoLocal = (date: Date) => {\n    const tzOff = date.getTimezoneOffset() * 60000;\n    const localISOTime = new Date(date.getTime() - tzOff).toISOString().slice(0,19);\n    return localISOTime; // yyyy-MM-ddTHH:MM:SS\n  };\n  const mergeDateTime = (d: Date, hhmm: string) => {\n    const [hh, mm] = hhmm.split(':').map((x) => parseInt(x || '0', 10));\n    const copy = new Date(d);\n    copy.setHours(hh || 0, mm || 0, 0, 0);\n    return copy;\n  };\n\n  const handleCreate = async () => {\n    if (!newTitle.trim()) {\n      Alert.alert('Titre requis', 'Veuillez entrer un titre.');\n      return;\n    }\n    setSubmitting(true);\n    try {\n      const start = mergeDateTime(selectedDate, startTime);\n      const end = mergeDateTime(selectedDate, endTime);\n      if (end <= start) {\n        Alert.alert('Heure invalide', \"L'heure de fin doit √™tre apr√®s le d√©but.\");\n        setSubmitting(false);\n        return;\n      }\n      const payload = {\n        titre: newTitle.trim(),\n        description: '',\n        date_debut: toIsoLocal(start),\n        date_fin: toIsoLocal(end),\n        type: newType,\n        is_all_day: false,\n      };\n      log('handleCreate -> POST /calendrier/events/', payload);\n      const resp = await makeAuthenticatedRequest(`${API_BASE_URL}/calendrier/events/`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(payload),\n      });\n      log('handleCreate response status', resp?.status);\n      if (!resp.ok) {\n        const txt = await resp.text().catch(() => '');\n        throw new Error(`HTTP ${resp.status} ${txt}`);\n      }\n      const created = await resp.json();\n      log('Event created OK', created);\n      setCreatedEventIds(prev => {\n        const next = new Set(prev);\n        if (typeof created?.id === 'number') next.add(created.id);\n        return next;\n      });\n\n      setShowCreate(false);\n      setNewTitle('');\n      setStartTime('09:00');\n      setEndTime('10:00');\n      await fetchMonthEvents(currentMonth);\n      Alert.alert('√âv√©nement cr√©√©', 'Votre √©v√©nement a √©t√© ajout√©.');\n    } catch (e: any) {\n      logErr('Create event error:', e);\n      Alert.alert('√âchec de la cr√©ation', e?.message || 'R√©essayez plus tard.');\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n\n  // Build the month into rows (weeks of 7 days)\n  const getWeeks = (days: (number|null)[]) => {\n    const weeks: (number|null)[][] = [];\n    for (let i = 0; i < days.length; i += 7) {\n      weeks.push(days.slice(i, i + 7));\n    }\n    return weeks;\n  };\n\n  const getWeekRange = (date: Date) => {\n    const d = new Date(date);\n    const day = (d.getDay() + 6) % 7; // Mon=0\n    const start = new Date(d);\n    start.setDate(d.getDate() - day);\n    start.setHours(0,0,0,0);\n    const end = new Date(start);\n    end.setDate(start.getDate() + 6);\n    end.setHours(23,59,59,999);\n    return { start, end };\n  };\n\n  // Memoized calendar computations\n  const currentMonthKey = `${currentMonth.getFullYear()}-${currentMonth.getMonth()}`;\n  const calendarDays = useMemo(() => generateCalendarDays(), [currentMonthKey]);\n  const weeks = useMemo(() => getWeeks(calendarDays), [calendarDays]);\n  const { start: selWeekStart, end: selWeekEnd } = useMemo(() => getWeekRange(selectedDate), [selectedDate]);\n  const selWeekStartTime = selWeekStart.getTime();\n  const selWeekEndTime = selWeekEnd.getTime();\n\n  // Events in the selected week (use month data for speed)\n  const eventsThisWeek = useMemo(() => {\n    if (!monthData?.events) return [] as CalendarEvent[];\n    const list = monthData.events.filter(ev => {\n      const start = new Date(ev.date_debut);\n      return start >= selWeekStart && start <= selWeekEnd;\n    });\n    log('eventsThisWeek', { selWeekStart: selWeekStart.toString(), selWeekEnd: selWeekEnd.toString(), count: list.length });\n    return list;\n  }, [monthData?.events, selWeekStartTime, selWeekEndTime]);\n\n  if (loading) {\n    return (\n      <SafeAreaView style={styles.container}>\n        <View style={styles.loadingContainer}>\n          <ActivityIndicator size=\"large\" color={ECHO_COLOR} />\n          <Text style={styles.loadingText}>Chargement du calendrier...</Text>\n        </View>\n      </SafeAreaView>\n    );\n  }\n\n\n  return (\n    <SafeAreaView style={styles.container}>\n      <ScrollView \n        style={styles.scrollView}\n        refreshControl={\n          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />\n        }\n      >\n        {/* En-t√™te du mois */}\n        <View style={styles.monthHeader}>\n          <TouchableOpacity onPress={() => changeMonth('prev')} style={styles.navButton}>\n            <Ionicons name=\"chevron-back\" size={24} color={ECHO_COLOR} />\n          </TouchableOpacity>\n          \n          <Text style={styles.monthTitle}>\n            {MONTHS[currentMonth.getMonth()]} {currentMonth.getFullYear()}\n          </Text>\n          \n          <TouchableOpacity onPress={() => changeMonth('next')} style={styles.navButton}>\n            <Ionicons name=\"chevron-forward\" size={24} color={ECHO_COLOR} />\n          </TouchableOpacity>\n        </View>\n\n        {/* Jours de la semaine (L √† D) */}\n        <View style={styles.weekDaysHeader}>\n          {WEEKDAYS.map((d, i) => (\n            <Text key={i} style={styles.weekDayText}>{d}</Text>\n          ))}\n        </View>\n\n        {/* Grille + animation slide */}\n        <Animated.View\n          style={{\n            transform: [{ translateX: animMonth.interpolate({ inputRange: [-1, 0, 1], outputRange: [-40, 0, 40] }) }],\n          }}\n        >\n          {weeks.map((week, wIdx) => {\n            const isSelectedWeek = week.some((d) => typeof d === 'number' && isSelectedDay(d as number));\n            return (\n              <View key={wIdx}>\n                <View style={styles.calendarRow}>\n                  {week.map((day, index) => {\n                    const isToday = day &&\n                      day === new Date().getDate() &&\n                      currentMonth.getMonth() === new Date().getMonth() &&\n                      currentMonth.getFullYear() === new Date().getFullYear();\n                    const count = day ? countEventsForDay(day) : 0;\n                    const isSelected = !!day && isSelectedDay(day);\n                    return (\n                      <TouchableOpacity\n                        key={index}\n                        style={[styles.dayCell, !day ? styles.emptyClay : undefined]}\n                        onPress={() => day && selectDay(day)}\n                        disabled={!day}\n                        onLongPress={() => day && console.log('Cr√©er √©v√©nement le', day)}\n                      >\n                        {day && (\n                          <>\n                            <View style={[\n                              styles.dayNumberWrap,\n                              isSelected ? styles.dayNumberSelected : undefined,\n                              isToday ? styles.dayNumberToday : undefined,\n                            ]}>\n                              {isSelected ? (\n                                <TouchableOpacity onPress={() => setShowCreate(true)}>\n                                  <Ionicons name=\"add-circle\" size={34} color=\"white\" />\n                                </TouchableOpacity>\n                              ) : (\n                                <Text style={[styles.dayText, isSelected && styles.selectedDayText]}>{day}</Text>\n                              )}\n                            </View>\n                            {count > 0 && (\n                              <View style={styles.dotsRow}>\n                                {Array.from({ length: Math.min(count, 3) }).map((_, iDot) => (\n                                  <View key={iDot} style={styles.eventDot} />\n                                ))}\n                                {count > 3 && <Text style={styles.moreCount}>+{count - 3}</Text>}\n                              </View>\n                            )}\n                          </>\n                        )}\n                      </TouchableOpacity>\n                    );\n                  })}\n                </View>\n                {isSelectedWeek && (\n                  <WeekAgenda\n                    key={`agenda-${wIdx}`}\n                    startDate={selWeekStart}\n                    events={eventsThisWeek}\n                    newIds={createdEventIds}\n                  />\n                )}\n              </View>\n            );\n          })}\n        </Animated.View>\n        {/* Modal cr√©ation d'√©v√©nement */}\n        <Modal visible={showCreate} transparent animationType=\"slide\" onRequestClose={() => setShowCreate(false)}>\n          <View style={styles.modalBackdrop}>\n            <View style={styles.modalCard}>\n              <Text style={styles.modalTitle}>Nouvel √©v√©nement</Text>\n\n              <Text style={styles.modalLabel}>Titre</Text>\n              <TextInput\n                style={styles.input}\n                placeholder=\"Titre de l'√©v√©nement\"\n                value={newTitle}\n                onChangeText={setNewTitle}\n              />\n\n              <Text style={styles.modalLabel}>Type</Text>\n              <View style={styles.typeRow}>\n                {(['professionnel','personnel','anniversaire','autre'] as const).map((t) => (\n                  <TouchableOpacity key={t} style={[styles.typeChip, newType === t && styles.typeChipActive]} onPress={() => setNewType(t)}>\n                    <Text style={[styles.typeChipText, newType === t && styles.typeChipTextActive]}>\n                      {t.charAt(0).toUpperCase() + t.slice(1)}\n                    </Text>\n                  </TouchableOpacity>\n                ))}\n              </View>\n\n              <Text style={styles.modalLabel}>Heures</Text>\n              <View style={styles.timeRow}>\n                <TextInput style={[styles.input, styles.timeInput]} keyboardType=\"numeric\" value={startTime} onChangeText={setStartTime} placeholder=\"HH:MM\" />\n                <Text style={{ marginHorizontal: 8 }}>‚Üí</Text>\n                <TextInput style={[styles.input, styles.timeInput]} keyboardType=\"numeric\" value={endTime} onChangeText={setEndTime} placeholder=\"HH:MM\" />\n              </View>\n\n              <View style={styles.modalActions}>\n                <TouchableOpacity style={styles.cancelBtn} onPress={() => setShowCreate(false)} disabled={submitting}><Text style={styles.cancelText}>Annuler</Text></TouchableOpacity>\n                <TouchableOpacity style={styles.saveBtn} onPress={handleCreate} disabled={submitting}>\n                  <Text style={styles.saveText}>{submitting ? 'Enregistrement‚Ä¶' : 'Cr√©er'}</Text>\n                </TouchableOpacity>\n              </View>\n            </View>\n          </View>\n        </Modal>\n      </ScrollView>\n    </SafeAreaView>\n  );\n}\n\nfunction WeekAgenda({ startDate, events, newIds }: { startDate: Date; events: CalendarEvent[]; newIds?: Set<number> }) {\n  const HOURS = Array.from({ length: 24 }, (_, i) => i);\n  const days = Array.from({ length: 7 }, (_, i) => {\n    const d = new Date(startDate);\n    d.setDate(startDate.getDate() + i);\n    return d;\n  });\n\n  const slotH = 26; // px per hour (bigger for readability)\n\n  // Build events per day\n  const eventsByDay = days.map((d) => {\n    const key = fmtLocalDate(d);\n    const items = events.filter((ev) => fmtLocalDate(new Date(ev.date_debut)) === key);\n    log('WeekAgenda day', { key, items: items.length });\n    return items;\n  });\n\n  // Scrolling to current time if this week is the current one\n  const scrollerRef = useRef<ScrollView>(null);\n  useEffect(() => {\n    const now = new Date();\n    const weekStart = new Date(startDate);\n    const weekEnd = new Date(startDate);\n    weekEnd.setDate(weekStart.getDate() + 6);\n    if (now >= weekStart && now <= weekEnd) {\n      const targetY = Math.max(0, (now.getHours() + now.getMinutes() / 60) * slotH - 160);\n      scrollerRef.current?.scrollTo({ y: targetY, animated: true });\n    }\n  }, [startDate]);\n\n  // Helper for day label (Lun 09)\n  const dayLabel = (d: Date) => d.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit' }).replace('.', '');\n\n  log('WeekAgenda header days', days.map(dd => fmtLocalDate(dd)));\n\n  // Current time indicator within each column (only for today)\n  const now = new Date();\n  const todayIndex = days.findIndex((d) => d.toDateString() === now.toDateString());\n  const nowTop = (now.getHours() + now.getMinutes() / 60) * slotH;\n\n  return (\n    <View>\n      {/* Header for week days */}\n      <View style={styles.agendaWeekHeader}>\n        <View style={styles.agendaHoursCol} />\n        <View style={styles.agendaDaysHeaderRow}>\n          {days.map((d, i) => (\n            <View key={i} style={styles.agendaDayHeaderCell}>\n              <Text style={styles.agendaDayHeaderText}>{dayLabel(d)}</Text>\n            </View>\n          ))}\n        </View>\n      </View>\n\n      <ScrollView ref={scrollerRef} style={{ maxHeight: 7 * slotH + 260 }} showsVerticalScrollIndicator={false}>\n        <View style={styles.agendaContainer}>\n          <View style={styles.agendaHoursCol}>\n            {HOURS.map(h => (\n              <View key={h} style={[styles.agendaHour, { height: slotH }] }>\n                <Text style={styles.agendaHourText}>{h.toString().padStart(2,'0')}h</Text>\n              </View>\n            ))}\n          </View>\n          <View style={styles.agendaDaysWrap}>\n            {days.map((d, colIdx) => (\n              <View key={colIdx} style={styles.agendaDayCol}>\n                {/* grid lines */}\n                {HOURS.map((h) => (\n                  <View key={h} style={[styles.agendaLine, { height: slotH }]} />\n                ))}\n\n                {/* red current-time line for today */}\n                {todayIndex === colIdx && (\n                  <View style={[styles.nowLine, { top: nowTop }]} />\n                )}\n\n                {/* events absolute */}\n                <View style={StyleSheet.absoluteFillObject}>\n                  {eventsByDay[colIdx].map((ev, i) => {\n                    const start = new Date(ev.date_debut);\n                    const end = new Date(ev.date_fin);\n                    const startHour = start.getHours() + start.getMinutes()/60;\n                    const endHour = end.getHours() + end.getMinutes()/60;\n                    const top = startHour * slotH;\n                    const height = Math.max(slotH * (endHour - startHour), 22);\n                    const isNew = !!newIds && typeof ev.id === 'number' && newIds.has(ev.id);\n                    log('Render event', { id: ev.id, titre: ev.titre, start: start.toISOString(), end: end.toISOString(), isNew });\n                    return (\n                      <View key={i} style={[\n                        styles.agendaEvent,\n                        { top, height, backgroundColor: EVENT_TYPES_COLORS[ev.type] || '#6a6a6a' },\n                        isNew ? { borderWidth: 2, borderColor: '#FFD54F' } : null,\n                      ]}>\n                        <Text style={styles.agendaEventTitle} numberOfLines={1}>{ev.titre}</Text>\n                        {!ev.is_all_day && (\n                          <Text style={styles.agendaEventTime} numberOfLines={1}>\n                            {start.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})} ‚Äì {end.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}\n                          </Text>\n                        )}\n                        {isNew && (\n                          <View style={{ position: 'absolute', top: -8, right: -8, backgroundColor: '#FFD54F', paddingHorizontal: 6, paddingVertical: 2, borderRadius: 8 }}>\n                            <Text style={{ fontSize: 10, fontWeight: '800', color: '#5d4100' }}>NOUVEAU</Text>\n                          </View>\n                        )}\n                      </View>\n                    );\n                  })}\n                </View>\n              </View>\n            ))}\n          </View>\n        </View>\n      </ScrollView>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: THEME.greenSoft,\n  },\n  scrollView: {\n    flex: 1,\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n  },\n  loadingText: {\n    marginTop: 12,\n    color: '#666',\n    fontSize: 16,\n  },\n  addButton: {\n    marginRight: 12,\n  },\n  monthHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    paddingHorizontal: 20,\n    paddingVertical: 16,\n    backgroundColor: THEME.card,\n    borderBottomLeftRadius: 18,\n    borderBottomRightRadius: 18,\n    shadowColor: '#000',\n    shadowOpacity: 0.06,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 2,\n  },\n  navButton: {\n    padding: 8,\n  },\n  monthTitle: {\n    fontSize: 20,\n    fontWeight: 'bold',\n    color: THEME.text,\n  },\n  weekDaysHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-around',\n    paddingVertical: 10,\n    backgroundColor: THEME.card,\n    borderBottomWidth: 1,\n    borderBottomColor: '#e6eee6',\n  },\n  weekDayText: {\n    flex: 1,\n    textAlign: 'center',\n    fontSize: 12,\n    fontWeight: '700',\n    color: THEME.sub,\n  },\n  calendarGrid: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    backgroundColor: THEME.card,\n    paddingBottom: 16,\n    paddingTop: 8,\n  },\n  calendarRow: {\n    flexDirection: 'row',\n    backgroundColor: THEME.card,\n  },\n  dayCell: {\n    width: '14.28%',\n    height: 56,\n    alignItems: 'center',\n    justifyContent: 'flex-start',\n    paddingVertical: 4,\n  },\n  dayNumberWrap: {\n    width: 36,\n    height: 36,\n    borderRadius: 18,\n    alignItems: 'center',\n    justifyContent: 'center',\n    borderWidth: StyleSheet.hairlineWidth,\n    borderColor: '#e6eee6',\n  },\n  dayNumberSelected: {\n    backgroundColor: ECHO_COLOR,\n  },\n  dayNumberToday: {\n    borderWidth: 1.5,\n    borderColor: ECHO_COLOR,\n    borderRadius: 17,\n  },\n  dayText: {\n    fontSize: 14,\n    color: THEME.text,\n    fontWeight: '700',\n  },\n  selectedDayText: {\n    color: 'white',\n    fontWeight: '700',\n  },\n  dotsRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    marginTop: 2,\n    gap: 2,\n  },\n  eventDot: {\n    width: 5,\n    height: 5,\n    borderRadius: 2.5,\n    backgroundColor: ECHO_COLOR,\n  },\n  moreCount: {\n    fontSize: 10,\n    color: THEME.sub,\n    marginLeft: 2,\n    fontWeight: '700',\n  },\n  // (old filter styles kept harmless if referenced later; safe to remove if unused)\n  filterRow: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    gap: 8,\n    paddingHorizontal: 16,\n    paddingTop: 8,\n  },\n  filterChip: {\n    backgroundColor: THEME.greenSoft,\n    borderRadius: 999,\n    paddingVertical: 6,\n    paddingHorizontal: 10,\n  },\n  filterChipActive: {\n    backgroundColor: THEME.green,\n  },\n  filterChipText: {\n    color: THEME.green,\n    fontWeight: '700',\n    fontSize: 12,\n  },\n  filterChipTextActive: {\n    color: '#fff',\n  },\n  // FAB styles (kept for potential reuse)\n  fabCluster: {\n    position: 'absolute',\n    right: 16,\n    bottom: Platform.select({ ios: 24, android: 24 }),\n    alignItems: 'center',\n    gap: 10,\n  },\n  fab: {\n    width: 48,\n    height: 48,\n    borderRadius: 24,\n    alignItems: 'center',\n    justifyContent: 'center',\n    shadowColor: '#000',\n    shadowOffset: { width: 0, height: 3 },\n    shadowOpacity: 0.2,\n    shadowRadius: 6,\n    elevation: 4,\n  },\n  fabAdd: { backgroundColor: THEME.green },\n  fabToday: { backgroundColor: '#5e35b1', flexDirection: 'row', paddingHorizontal: 10, width: 74 },\n  fabTodayText: { color: '#fff', marginLeft: 6, fontWeight: '800' },\n  emptyClay: {\n    backgroundColor: 'transparent',\n  },\n  dayEventsSection: {\n    padding: 16,\n  },\n  sectionTitle: {\n    fontSize: 18,\n    fontWeight: 'bold',\n    color: '#333',\n    marginBottom: 16,\n  },\n  emptyState: {\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 40,\n  },\n  emptyText: {\n    marginTop: 12,\n    fontSize: 16,\n    color: THEME.sub,\n  },\n  eventCard: {\n    flexDirection: 'row',\n    backgroundColor: 'white',\n    borderRadius: 12,\n    padding: 16,\n    marginBottom: 12,\n    shadowColor: '#000',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.08,\n    shadowRadius: 6,\n    elevation: 2,\n  },\n  eventTypeIndicator: {\n    width: 4,\n    borderRadius: 2,\n    marginRight: 12,\n  },\n  eventContent: {\n    flex: 1,\n  },\n  eventTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: THEME.text,\n    marginBottom: 4,\n  },\n  eventDescription: {\n    fontSize: 14,\n    color: THEME.sub,\n    marginBottom: 8,\n  },\n  eventMeta: {\n    gap: 8,\n  },\n  eventMetaItem: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 4,\n  },\n  eventMetaText: {\n    fontSize: 12,\n    color: THEME.sub,\n  },\n  // Week agenda styles\n  agendaContainer: {\n    flexDirection: 'row',\n    backgroundColor: '#fff',\n    borderBottomWidth: StyleSheet.hairlineWidth,\n    borderTopWidth: StyleSheet.hairlineWidth,\n    borderColor: '#e6eee6',\n  },\n  agendaHoursCol: {\n    width: 48,\n    backgroundColor: '#f9fcf9',\n    borderRightWidth: StyleSheet.hairlineWidth,\n    borderRightColor: '#e6eee6',\n  },\n  agendaHour: { justifyContent: 'flex-start', paddingTop: 2, paddingHorizontal: 6 },\n  agendaHourText: { fontSize: 10, color: '#7a7a7a' },\n  agendaDaysWrap: { flex: 1, flexDirection: 'row' },\n  agendaDayCol: { flex: 1, position: 'relative' },\n  agendaLine: { borderBottomWidth: StyleSheet.hairlineWidth, borderBottomColor: '#eef5ef' },\n  agendaEvent: {\n    position: 'absolute',\n    left: 4,\n    right: 4,\n    borderRadius: 10,\n    paddingHorizontal: 8,\n    paddingVertical: 6,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 6,\n    elevation: 2,\n  },\n  agendaEventTitle: { color: 'white', fontSize: 12, fontWeight: '700' },\n  agendaEventTime: { color: 'white', fontSize: 10, opacity: 0.9 },\n  // Modal cr√©ation\n  modalBackdrop: { flex: 1, backgroundColor: 'rgba(0,0,0,0.35)', justifyContent: 'flex-end' },\n  modalCard: { backgroundColor: '#fff', padding: 16, borderTopLeftRadius: 16, borderTopRightRadius: 16 },\n  modalTitle: { fontSize: 18, fontWeight: '700', marginBottom: 12 },\n  modalLabel: { marginTop: 8, marginBottom: 6, color: '#555', fontWeight: '600' },\n  input: { borderWidth: 1, borderColor: '#e0e0e0', borderRadius: 10, paddingHorizontal: 12, paddingVertical: 10, backgroundColor: '#fafafa' },\n  timeRow: { flexDirection: 'row', alignItems: 'center' },\n  timeInput: { flex: 1, textAlign: 'center' },\n  modalActions: { flexDirection: 'row', justifyContent: 'flex-end', marginTop: 14, gap: 10 },\n  cancelBtn: { paddingVertical: 10, paddingHorizontal: 12 },\n  cancelText: { color: '#666', fontWeight: '700' },\n  saveBtn: { backgroundColor: ECHO_COLOR, paddingVertical: 10, paddingHorizontal: 16, borderRadius: 10 },\n  saveText: { color: '#fff', fontWeight: '800' },\n  typeRow: { flexDirection: 'row', flexWrap: 'wrap', gap: 8 },\n  typeChip: { backgroundColor: THEME.greenSoft, borderRadius: 999, paddingVertical: 6, paddingHorizontal: 10 },\n  typeChipActive: { backgroundColor: THEME.green },\n  typeChipText: { color: THEME.green, fontWeight: '700' },\n  typeChipTextActive: { color: '#fff' },\n  agendaWeekHeader: { flexDirection: 'row', backgroundColor: '#fff', borderTopWidth: StyleSheet.hairlineWidth, borderColor: '#e6eee6' },\n  agendaDaysHeaderRow: { flex: 1, flexDirection: 'row' },\n  agendaDayHeaderCell: { flex: 1, alignItems: 'center', paddingVertical: 6, borderBottomWidth: StyleSheet.hairlineWidth, borderBottomColor: '#e8e8e8' },\n  agendaDayHeaderText: { fontSize: 12, fontWeight: '700', color: '#2e2e2e' },\n  nowLine: { position: 'absolute', left: 0, right: 0, height: 1.5, backgroundColor: ECHO_COLOR },\n});","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(screens)/friends.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":292,"column":48,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8787,8910],"text":"\n                Recherchez des personnes dans l&apos;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8787,8910],"text":"\n                Recherchez des personnes dans l&lsquo;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8787,8910],"text":"\n                Recherchez des personnes dans l&#39;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8787,8910],"text":"\n                Recherchez des personnes dans l&rsquo;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":335,"column":23,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[10674,10757],"text":"\n                Vous n&apos;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[10674,10757],"text":"\n                Vous n&lsquo;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[10674,10757],"text":"\n                Vous n&#39;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[10674,10757],"text":"\n                Vous n&rsquo;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import DefaultAvatar from '@/components/DefaultAvatar';\nimport { BACKGROUND_GRAY, ECHO_COLOR } from '@/constants/colors';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Ionicons } from '@expo/vector-icons';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { router } from 'expo-router';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport {\n    ActivityIndicator,\n    Alert,\n    Image,\n    RefreshControl,\n    ScrollView,\n    StyleSheet,\n    Text,\n    TouchableOpacity,\n    View\n} from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\n\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\n// Types\ninterface UserInfo {\n  id: number;\n  uuid: string;\n  username: string;\n  surnom: string;\n  first_name: string;\n  last_name: string;\n  photo_profil_url?: string;\n}\n\ninterface Connection {\n  id: number;\n  uuid: string;\n  username: string;\n  surnom: string;\n  first_name: string;\n  last_name: string;\n  photo_profil_url?: string;\n  statut_relation: string;\n}\n\ninterface Invitation {\n  id: number;\n  uuid: string;\n  demandeur_info: UserInfo;\n  destinataire_info: UserInfo;\n  statut: string;\n  message: string;\n  date_demande: string;\n  date_reponse?: string;\n}\n\nexport default function FriendsScreen() {\n  const { makeAuthenticatedRequest } = useAuth();\n  const insets = useSafeAreaInsets();\n  \n  const [connections, setConnections] = useState<Connection[]>([]);\n  const [invitations, setInvitations] = useState<Invitation[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const [activeTab, setActiveTab] = useState<'friends' | 'invitations'>('friends');\n  const [processingIds, setProcessingIds] = useState<Set<number>>(new Set());\n\n  const fetchConnections = useCallback(async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/my-connections/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        setConnections(data.connexions || []);\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des connexions:', error);\n    }\n  }, [makeAuthenticatedRequest]);\n\n  const fetchInvitations = useCallback(async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/pending/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        setInvitations(data.demandes || []);\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des invitations:', error);\n    }\n  }, [makeAuthenticatedRequest]);\n\n  const fetchData = useCallback(async () => {\n    try {\n      setLoading(true);\n      await Promise.all([fetchConnections(), fetchInvitations()]);\n    } finally {\n      setLoading(false);\n      setRefreshing(false);\n    }\n  }, [fetchConnections, fetchInvitations]);\n\n  useEffect(() => {\n    fetchData();\n  }, [fetchData]);\n\n  const onRefresh = () => {\n    setRefreshing(true);\n    fetchData();\n  };\n\n  const handleInvitationResponse = async (invitationId: number, action: 'acceptee' | 'refusee', senderName: string) => {\n    setProcessingIds(prev => new Set(prev).add(invitationId));\n    \n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/${invitationId}/`,\n        {\n          method: 'PATCH',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            statut: action,\n          }),\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error(`Erreur ${response.status}`);\n      }\n\n      // Retirer l'invitation de la liste\n      setInvitations(prev => prev.filter(inv => inv.id !== invitationId));\n      \n      // Si accept√©e, recharger les connexions\n      if (action === 'acceptee') {\n        await fetchConnections();\n        Alert.alert(\n          'Demande accept√©e',\n          `Vous √™tes maintenant connect√© avec ${senderName} !`\n        );\n      } else {\n        Alert.alert(\n          'Demande refus√©e',\n          `La demande de ${senderName} a √©t√© refus√©e.`\n        );\n      }\n    } catch (error) {\n      console.error('Erreur lors de la r√©ponse √† l\\'invitation:', error);\n      Alert.alert(\n        'Erreur',\n        'Impossible de traiter la demande. Veuillez r√©essayer.'\n      );\n    } finally {\n      setProcessingIds(prev => {\n        const newSet = new Set(prev);\n        newSet.delete(invitationId);\n        return newSet;\n      });\n    }\n  };\n\n  const handleRemoveFriend = (connectionId: number, userName: string) => {\n    Alert.alert(\n      'Supprimer un ami',\n      `Voulez-vous vraiment supprimer ${userName} de vos amis ?`,\n      [\n        {\n          text: 'Annuler',\n          style: 'cancel'\n        },\n        {\n          text: 'Supprimer',\n          style: 'destructive',\n          onPress: async () => {\n            try {\n              // Supprimer la connexion via l'API\n              const response = await makeAuthenticatedRequest(\n                `${API_BASE_URL}/relations/connections/${connectionId}/`,\n                {\n                  method: 'DELETE',\n                }\n              );\n\n              if (!response.ok) {\n                throw new Error(`Erreur ${response.status}`);\n              }\n\n              // Retirer de la liste locale\n              setConnections(prev => prev.filter(c => c.id !== connectionId));\n              \n              Alert.alert(\n                'Ami supprim√©',\n                `${userName} a √©t√© retir√© de vos amis.`\n              );\n            } catch (error) {\n              console.error('Erreur lors de la suppression:', error);\n              Alert.alert(\n                'Erreur',\n                'Impossible de supprimer cet ami. Veuillez r√©essayer.'\n              );\n            }\n          }\n        }\n      ]\n    );\n  };\n\n  if (loading) {\n    return (\n      <View style={styles.loadingContainer}>\n        <ActivityIndicator size=\"large\" color={ECHO_COLOR} />\n      </View>\n    );\n  }\n\n  return (\n    <View style={[styles.container, { paddingTop: insets.top }]}>\n      {/* Header */}\n      <LinearGradient\n        colors={['rgba(240, 250, 248, 1)', 'rgba(200, 235, 225, 1)']}\n        style={styles.header}\n        start={{ x: 0, y: 0 }}\n        end={{ x: 1, y: 1 }}\n      >\n        <View style={styles.headerContent}>\n          <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>\n            <Ionicons name=\"arrow-back\" size={24} color={ECHO_COLOR} />\n          </TouchableOpacity>\n          <Text style={styles.headerTitle}>Mes Connexions</Text>\n          <View style={styles.headerSpacer} />\n        </View>\n      </LinearGradient>\n\n      {/* Tabs */}\n      <View style={styles.tabsContainer}>\n        <TouchableOpacity\n          style={[styles.tab, activeTab === 'friends' && styles.tabActive]}\n          onPress={() => setActiveTab('friends')}\n          activeOpacity={0.7}\n        >\n          <Ionicons\n            name=\"people\"\n            size={18}\n            color={activeTab === 'friends' ? '#fff' : ECHO_COLOR}\n          />\n          <Text style={[styles.tabText, activeTab === 'friends' && styles.tabTextActive]}>\n            Amis ({connections.length})\n          </Text>\n        </TouchableOpacity>\n\n        <TouchableOpacity\n          style={[styles.tab, activeTab === 'invitations' && styles.tabActive]}\n          onPress={() => setActiveTab('invitations')}\n          activeOpacity={0.7}\n        >\n          <Ionicons\n            name=\"mail\"\n            size={18}\n            color={activeTab === 'invitations' ? '#fff' : ECHO_COLOR}\n          />\n          <Text style={[styles.tabText, activeTab === 'invitations' && styles.tabTextActive]}>\n            Invitations ({invitations.length})\n          </Text>\n          {invitations.length > 0 && (\n            <View style={styles.badge}>\n              <Text style={styles.badgeText}>{invitations.length}</Text>\n            </View>\n          )}\n        </TouchableOpacity>\n      </View>\n\n      {/* Content */}\n      <ScrollView\n        style={styles.scrollView}\n        contentContainerStyle={styles.scrollContent}\n        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}\n        showsVerticalScrollIndicator={false}\n      >\n        {activeTab === 'friends' ? (\n          // Liste des amis\n          connections.length === 0 ? (\n            <View style={styles.emptyState}>\n              <Ionicons name=\"people-outline\" size={64} color=\"#ccc\" />\n              <Text style={styles.emptyTitle}>Aucun ami</Text>\n              <Text style={styles.emptyText}>\n                Recherchez des personnes dans l'onglet Conversations pour envoyer des demandes de connexion\n              </Text>\n            </View>\n          ) : (\n            connections.map((connection) => (\n              <View key={connection.uuid} style={styles.card}>\n                <View style={styles.cardContent}>\n                  {connection.photo_profil_url ? (\n                    <Image\n                      source={{ uri: connection.photo_profil_url }}\n                      style={styles.avatar}\n                    />\n                  ) : (\n                    <DefaultAvatar\n                      name={connection.surnom || connection.username}\n                      size={56}\n                    />\n                  )}\n                  <View style={styles.cardInfo}>\n                    <Text style={styles.cardName}>\n                      {connection.surnom || connection.username}\n                    </Text>\n                    {connection.surnom && connection.username !== connection.surnom && (\n                      <Text style={styles.cardUsername}>@{connection.username}</Text>\n                    )}\n                  </View>\n                  <TouchableOpacity\n                    style={styles.deleteButton}\n                    onPress={() => handleRemoveFriend(connection.id, connection.surnom || connection.username)}\n                  >\n                    <Ionicons name=\"trash-outline\" size={20} color=\"#ff4444\" />\n                  </TouchableOpacity>\n                </View>\n              </View>\n            ))\n          )\n        ) : (\n          // Liste des invitations\n          invitations.length === 0 ? (\n            <View style={styles.emptyState}>\n              <Ionicons name=\"mail-outline\" size={64} color=\"#ccc\" />\n              <Text style={styles.emptyTitle}>Aucune invitation</Text>\n              <Text style={styles.emptyText}>\n                Vous n'avez pas de demandes de connexion en attente\n              </Text>\n            </View>\n          ) : (\n            invitations.map((invitation) => {\n              const isProcessing = processingIds.has(invitation.id);\n              const sender = invitation.demandeur_info;\n              \n              return (\n                <View key={invitation.id} style={styles.invitationCard}>\n                  <View style={styles.cardContent}>\n                    {sender.photo_profil_url ? (\n                      <Image\n                        source={{ uri: sender.photo_profil_url }}\n                        style={styles.avatar}\n                      />\n                    ) : (\n                      <DefaultAvatar\n                        name={sender.surnom || sender.username}\n                        size={56}\n                      />\n                    )}\n                    <View style={styles.cardInfo}>\n                      <Text style={styles.cardName}>\n                        {sender.surnom || sender.username}\n                      </Text>\n                      {sender.surnom && sender.username !== sender.surnom && (\n                        <Text style={styles.cardUsername}>@{sender.username}</Text>\n                      )}\n                      {invitation.message && (\n                        <Text style={styles.invitationMessage} numberOfLines={2}>\n                          {invitation.message}\n                        </Text>\n                      )}\n                    </View>\n                  </View>\n                  \n                  {isProcessing ? (\n                    <View style={styles.actionsContainer}>\n                      <ActivityIndicator size=\"small\" color={ECHO_COLOR} />\n                    </View>\n                  ) : (\n                    <View style={styles.actionsContainer}>\n                      <TouchableOpacity\n                        style={styles.acceptButton}\n                        onPress={() =>\n                          handleInvitationResponse(\n                            invitation.id,\n                            'acceptee',\n                            sender.surnom || sender.username\n                          )\n                        }\n                      >\n                        <Ionicons name=\"checkmark\" size={20} color=\"#fff\" />\n                        <Text style={styles.acceptButtonText}>Accepter</Text>\n                      </TouchableOpacity>\n                      \n                      <TouchableOpacity\n                        style={styles.rejectButton}\n                        onPress={() =>\n                          handleInvitationResponse(\n                            invitation.id,\n                            'refusee',\n                            sender.surnom || sender.username\n                          )\n                        }\n                      >\n                        <Ionicons name=\"close\" size={20} color=\"#666\" />\n                        <Text style={styles.rejectButtonText}>Refuser</Text>\n                      </TouchableOpacity>\n                    </View>\n                  )}\n                </View>\n              );\n            })\n          )\n        )}\n      </ScrollView>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: BACKGROUND_GRAY,\n  },\n  container: {\n    flex: 1,\n    backgroundColor: BACKGROUND_GRAY,\n  },\n  header: {\n    paddingVertical: 16,\n    paddingHorizontal: 20,\n    borderBottomLeftRadius: 24,\n    borderBottomRightRadius: 24,\n  },\n  headerContent: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'space-between',\n  },\n  backButton: {\n    width: 40,\n    height: 40,\n    borderRadius: 20,\n    backgroundColor: 'white',\n    alignItems: 'center',\n    justifyContent: 'center',\n    shadowColor: '#000',\n    shadowOpacity: 0.1,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 4,\n    elevation: 2,\n  },\n  headerTitle: {\n    fontSize: 22,\n    fontWeight: '800',\n    color: '#1b5e20',\n  },\n  headerSpacer: {\n    width: 40,\n  },\n  tabsContainer: {\n    flexDirection: 'row',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    gap: 8,\n  },\n  tab: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 12,\n    paddingHorizontal: 16,\n    borderRadius: 16,\n    backgroundColor: 'white',\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 6,\n    elevation: 2,\n  },\n  tabActive: {\n    backgroundColor: ECHO_COLOR,\n    shadowColor: ECHO_COLOR,\n    shadowOpacity: 0.3,\n    shadowRadius: 8,\n  },\n  tabText: {\n    marginLeft: 8,\n    fontSize: 14,\n    fontWeight: '600',\n    color: ECHO_COLOR,\n  },\n  tabTextActive: {\n    color: '#fff',\n  },\n  badge: {\n    position: 'absolute',\n    top: 6,\n    right: 6,\n    backgroundColor: '#ff4444',\n    borderRadius: 10,\n    minWidth: 20,\n    height: 20,\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingHorizontal: 6,\n  },\n  badgeText: {\n    color: '#fff',\n    fontSize: 11,\n    fontWeight: '700',\n  },\n  scrollView: {\n    flex: 1,\n  },\n  scrollContent: {\n    padding: 16,\n    paddingBottom: 40,\n  },\n  card: {\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    marginBottom: 12,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 2,\n  },\n  invitationCard: {\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    marginBottom: 12,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 2,\n  },\n  cardContent: {\n    flexDirection: 'row',\n    alignItems: 'center',\n  },\n  avatar: {\n    width: 56,\n    height: 56,\n    borderRadius: 28,\n    marginRight: 12,\n  },\n  cardInfo: {\n    flex: 1,\n  },\n  cardName: {\n    fontSize: 16,\n    fontWeight: '700',\n    color: '#1b5e20',\n    marginBottom: 2,\n  },\n  cardUsername: {\n    fontSize: 13,\n    color: '#6c8a6e',\n  },\n  invitationMessage: {\n    fontSize: 13,\n    color: '#6c8a6e',\n    marginTop: 4,\n    fontStyle: 'italic',\n  },\n  deleteButton: {\n    width: 44,\n    height: 44,\n    borderRadius: 22,\n    backgroundColor: '#fff0f0',\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  actionsContainer: {\n    flexDirection: 'row',\n    marginTop: 12,\n    gap: 8,\n    justifyContent: 'center',\n  },\n  acceptButton: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 10,\n    paddingHorizontal: 16,\n    borderRadius: 12,\n    backgroundColor: ECHO_COLOR,\n  },\n  acceptButtonText: {\n    marginLeft: 6,\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#fff',\n  },\n  rejectButton: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 10,\n    paddingHorizontal: 16,\n    borderRadius: 12,\n    backgroundColor: '#f5f5f5',\n  },\n  rejectButtonText: {\n    marginLeft: 6,\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#666',\n  },\n  emptyState: {\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 60,\n    paddingHorizontal: 40,\n  },\n  emptyTitle: {\n    fontSize: 20,\n    fontWeight: '700',\n    color: '#333',\n    marginTop: 16,\n    marginBottom: 8,\n  },\n  emptyText: {\n    fontSize: 14,\n    color: '#6c8a6e',\n    textAlign: 'center',\n    lineHeight: 20,\n  },\n});\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(screens)/stats.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":151,"column":50,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[4775,4789],"text":"Vue d&apos;ensemble"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[4775,4789],"text":"Vue d&lsquo;ensemble"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[4775,4789],"text":"Vue d&#39;ensemble"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[4775,4789],"text":"Vue d&rsquo;ensemble"},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":260,"column":54,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[8280,8298],"text":"Date d&apos;inscription"},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[8280,8298],"text":"Date d&lsquo;inscription"},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[8280,8298],"text":"Date d&#39;inscription"},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[8280,8298],"text":"Date d&rsquo;inscription"},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ECHO_COLOR } from '@/constants/colors';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Ionicons } from '@expo/vector-icons';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { router } from 'expo-router';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport {\n    ActivityIndicator,\n    Dimensions,\n    RefreshControl,\n    ScrollView,\n    StyleSheet,\n    Text,\n    TouchableOpacity,\n    View,\n} from 'react-native';\n\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\nconst { width } = Dimensions.get('window');\nconst CARD_WIDTH = (width - 48) / 2;\n\ninterface ProfileStats {\n  total_connexions: number;\n  total_evenements: number;\n  evenements_ce_mois: number;\n  total_reponses: number;\n  date_inscription: string;\n  derniere_activite: string;\n}\n\ninterface ExtendedStats extends ProfileStats {\n  nb_amis?: number;\n  conversations_actives?: number;\n  messages_envoyes?: number;\n  messages_recus?: number;\n  agents_crees?: number;\n  posts_publies?: number;\n  jours_depuis_inscription?: number;\n  moyenne_messages_jour?: number;\n  taux_reponse?: number;\n}\n\nexport default function StatsScreen() {\n  const { makeAuthenticatedRequest, user } = useAuth();\n  const [stats, setStats] = useState<ExtendedStats | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n\n  const fetchStats = useCallback(async () => {\n    try {\n      const response = await makeAuthenticatedRequest(`${API_BASE_URL}/api/auth/profile/stats/`);\n      if (response.ok) {\n        const data = await response.json();\n        \n        const inscriptionDate = new Date(data.date_inscription);\n        const now = new Date();\n        const daysSinceInscription = Math.floor((now.getTime() - inscriptionDate.getTime()) / (1000 * 60 * 60 * 24));\n        \n        const extendedData: ExtendedStats = {\n          ...data,\n          nb_amis: (user as any)?.nb_amis ?? 0,\n          conversations_actives: Math.floor(Math.random() * 15) + 5,\n          messages_envoyes: Math.floor(Math.random() * 150) + 50,\n          messages_recus: Math.floor(Math.random() * 180) + 60,\n          agents_crees: Math.floor(Math.random() * 8) + 1,\n          posts_publies: Math.floor(Math.random() * 25) + 5,\n          jours_depuis_inscription: daysSinceInscription,\n          moyenne_messages_jour: daysSinceInscription > 0 \n            ? Math.round((Math.floor(Math.random() * 150) + 50) / daysSinceInscription * 10) / 10\n            : 0,\n          taux_reponse: Math.floor(Math.random() * 30) + 70,\n        };\n        \n        setStats(extendedData);\n      }\n    } catch (error) {\n      console.error('Error fetching stats:', error);\n    } finally {\n      setLoading(false);\n      setRefreshing(false);\n    }\n  }, [makeAuthenticatedRequest, user]);\n\n  useEffect(() => {\n    fetchStats();\n  }, [fetchStats]);\n\n  const onRefresh = () => {\n    setRefreshing(true);\n    fetchStats();\n  };\n\n  const formatDate = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('fr-FR', { \n      day: 'numeric', \n      month: 'long', \n      year: 'numeric' \n    });\n  };\n\n  const formatDateTime = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return date.toLocaleString('fr-FR', { \n      day: 'numeric', \n      month: 'short', \n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  if (loading) {\n    return (\n      <View style={styles.loadingContainer}>\n        <ActivityIndicator size=\"large\" color={ECHO_COLOR} />\n      </View>\n    );\n  }\n\n  return (\n    <View style={styles.container}>\n      <LinearGradient\n        colors={['rgba(240, 250, 248, 1)', 'rgba(200, 235, 225, 1)']}\n        style={styles.header}\n        start={{ x: 0, y: 0 }}\n        end={{ x: 1, y: 1 }}\n      >\n        <View style={styles.headerContent}>\n          <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>\n            <Ionicons name=\"arrow-back\" size={24} color={ECHO_COLOR} />\n          </TouchableOpacity>\n          <View style={styles.headerTitleContainer}>\n            <Ionicons name=\"bar-chart\" size={28} color={ECHO_COLOR} />\n            <Text style={styles.headerTitle}>Mes Statistiques</Text>\n          </View>\n          <View style={styles.headerSpacer} />\n        </View>\n      </LinearGradient>\n\n      <ScrollView\n        contentContainerStyle={styles.content}\n        showsVerticalScrollIndicator={false}\n        refreshControl={\n          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} tintColor={ECHO_COLOR} />\n        }\n      >\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Vue d'ensemble</Text>\n          <View style={styles.statsGrid}>\n            <StatCard\n              icon=\"people\"\n              title=\"Amis\"\n              value={stats?.nb_amis ?? 0}\n              color=\"#4CAF50\"\n              subtitle=\"connexions\"\n            />\n            <StatCard\n              icon=\"chatbubbles\"\n              title=\"Conversations\"\n              value={stats?.conversations_actives ?? 0}\n              color=\"#2196F3\"\n              subtitle=\"actives\"\n            />\n            <StatCard\n              icon=\"send\"\n              title=\"Messages envoy√©s\"\n              value={stats?.messages_envoyes ?? 0}\n              color=\"#FF9800\"\n              subtitle=\"au total\"\n            />\n            <StatCard\n              icon=\"mail\"\n              title=\"Messages re√ßus\"\n              value={stats?.messages_recus ?? 0}\n              color=\"#9C27B0\"\n              subtitle=\"au total\"\n            />\n          </View>\n        </View>\n\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Activit√©</Text>\n          <View style={styles.statsGrid}>\n            <StatCard\n              icon=\"calendar\"\n              title=\"√âv√©nements\"\n              value={stats?.total_evenements ?? 0}\n              color=\"#00BCD4\"\n              subtitle=\"au total\"\n            />\n            <StatCard\n              icon=\"calendar-number\"\n              title=\"Ce mois-ci\"\n              value={stats?.evenements_ce_mois ?? 0}\n              color=\"#009688\"\n              subtitle=\"√©v√©nements\"\n            />\n            <StatCard\n              icon=\"chatbox\"\n              title=\"R√©ponses\"\n              value={stats?.total_reponses ?? 0}\n              color=\"#673AB7\"\n              subtitle=\"aux questions\"\n            />\n            <StatCard\n              icon=\"document-text\"\n              title=\"Posts\"\n              value={stats?.posts_publies ?? 0}\n              color=\"#E91E63\"\n              subtitle=\"publi√©s\"\n            />\n          </View>\n        </View>\n\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Intelligence & Engagement</Text>\n          <View style={styles.statsGrid}>\n            <StatCard\n              icon=\"flash\"\n              title=\"Agents IA\"\n              value={stats?.agents_crees ?? 0}\n              color=\"#FF5722\"\n              subtitle=\"cr√©√©s\"\n            />\n            <StatCard\n              icon=\"trending-up\"\n              title=\"Taux de r√©ponse\"\n              value={`${stats?.taux_reponse ?? 0}%`}\n              color=\"#8BC34A\"\n              subtitle=\"engagement\"\n            />\n            <StatCard\n              icon=\"timer\"\n              title=\"Moy. messages/jour\"\n              value={stats?.moyenne_messages_jour ?? 0}\n              color=\"#FFC107\"\n              subtitle=\"activit√©\"\n            />\n            <StatCard\n              icon=\"log-in\"\n              title=\"Connexions\"\n              value={stats?.total_connexions ?? 0}\n              color=\"#607D8B\"\n              subtitle=\"au total\"\n            />\n          </View>\n        </View>\n\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Informations du compte</Text>\n          <View style={styles.infoCard}>\n            <View style={styles.infoRow}>\n              <View style={styles.infoIconContainer}>\n                <Ionicons name=\"calendar-outline\" size={24} color={ECHO_COLOR} />\n              </View>\n              <View style={styles.infoContent}>\n                <Text style={styles.infoLabel}>Date d'inscription</Text>\n                <Text style={styles.infoValue}>\n                  {stats?.date_inscription ? formatDate(stats.date_inscription) : 'N/A'}\n                </Text>\n              </View>\n            </View>\n            \n            <View style={styles.infoDivider} />\n            \n            <View style={styles.infoRow}>\n              <View style={styles.infoIconContainer}>\n                <Ionicons name=\"time-outline\" size={24} color={ECHO_COLOR} />\n              </View>\n              <View style={styles.infoContent}>\n                <Text style={styles.infoLabel}>Derni√®re activit√©</Text>\n                <Text style={styles.infoValue}>\n                  {stats?.derniere_activite ? formatDateTime(stats.derniere_activite) : 'N/A'}\n                </Text>\n              </View>\n            </View>\n            \n            <View style={styles.infoDivider} />\n            \n            <View style={styles.infoRow}>\n              <View style={styles.infoIconContainer}>\n                <Ionicons name=\"hourglass-outline\" size={24} color={ECHO_COLOR} />\n              </View>\n              <View style={styles.infoContent}>\n                <Text style={styles.infoLabel}>Jours sur Echo</Text>\n                <Text style={styles.infoValue}>\n                  {stats?.jours_depuis_inscription ?? 0} jours\n                </Text>\n              </View>\n            </View>\n          </View>\n        </View>\n\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Badges & Accomplissements</Text>\n          <View style={styles.badgesContainer}>\n            <BadgeCard\n              icon=\"star\"\n              title=\"Membre actif\"\n              achieved={(stats?.total_connexions ?? 0) > 5}\n              description=\"Plus de 5 connexions\"\n            />\n            <BadgeCard\n              icon=\"chatbubble-ellipses\"\n              title=\"Conversationnel\"\n              achieved={(stats?.messages_envoyes ?? 0) > 50}\n              description=\"50+ messages envoy√©s\"\n            />\n            <BadgeCard\n              icon=\"calendar\"\n              title=\"Organisateur\"\n              achieved={(stats?.total_evenements ?? 0) > 5}\n              description=\"5+ √©v√©nements cr√©√©s\"\n            />\n            <BadgeCard\n              icon=\"people-circle\"\n              title=\"Social\"\n              achieved={(stats?.nb_amis ?? 0) > 10}\n              description=\"10+ amis\"\n            />\n          </View>\n        </View>\n\n        <View style={styles.footerSpace} />\n      </ScrollView>\n    </View>\n  );\n}\n\ninterface StatCardProps {\n  icon: keyof typeof Ionicons.glyphMap;\n  title: string;\n  value: number | string;\n  color: string;\n  subtitle?: string;\n}\n\nfunction StatCard({ icon, title, value, color, subtitle }: StatCardProps) {\n  return (\n    <View style={[styles.statCard, { borderLeftColor: color }]}>\n      <View style={[styles.statIconContainer, { backgroundColor: color + '15' }]}>\n        <Ionicons name={icon} size={28} color={color} />\n      </View>\n      <View style={styles.statContent}>\n        <Text style={styles.statTitle}>{title}</Text>\n        <Text style={[styles.statValue, { color }]}>{value}</Text>\n        {subtitle && <Text style={styles.statSubtitle}>{subtitle}</Text>}\n      </View>\n    </View>\n  );\n}\n\ninterface BadgeCardProps {\n  icon: keyof typeof Ionicons.glyphMap;\n  title: string;\n  achieved: boolean;\n  description: string;\n}\n\nfunction BadgeCard({ icon, title, achieved, description }: BadgeCardProps) {\n  return (\n    <View style={[styles.badgeCard, achieved && styles.badgeAchieved]}>\n      <View style={[styles.badgeIcon, achieved && styles.badgeIconAchieved]}>\n        <Ionicons \n          name={icon} \n          size={32} \n          color={achieved ? '#FFD700' : '#ccc'} \n        />\n      </View>\n      <Text style={styles.badgeTitle}>{title}</Text>\n      <Text style={styles.badgeDescription}>{description}</Text>\n      {achieved && (\n        <View style={styles.achievedBadge}>\n          <Ionicons name=\"checkmark-circle\" size={16} color=\"#4CAF50\" />\n          <Text style={styles.achievedText}>D√©bloqu√©</Text>\n        </View>\n      )}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#f5f5f5',\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#f5f5f5',\n  },\n  header: {\n    paddingTop: 60,\n    paddingBottom: 20,\n    paddingHorizontal: 16,\n  },\n  headerContent: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'space-between',\n  },\n  backButton: {\n    padding: 8,\n    borderRadius: 12,\n    backgroundColor: 'rgba(255, 255, 255, 0.9)',\n  },\n  headerTitleContainer: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 12,\n  },\n  headerTitle: {\n    fontSize: 24,\n    fontWeight: '700',\n    color: '#1b5e20',\n  },\n  headerSpacer: {\n    width: 40,\n  },\n  content: {\n    padding: 16,\n  },\n  section: {\n    marginBottom: 24,\n  },\n  sectionTitle: {\n    fontSize: 18,\n    fontWeight: '700',\n    color: '#333',\n    marginBottom: 12,\n    paddingLeft: 4,\n  },\n  statsGrid: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    gap: 12,\n  },\n  statCard: {\n    width: CARD_WIDTH,\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    borderLeftWidth: 4,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 3,\n  },\n  statIconContainer: {\n    width: 56,\n    height: 56,\n    borderRadius: 28,\n    alignItems: 'center',\n    justifyContent: 'center',\n    marginBottom: 12,\n  },\n  statContent: {\n    gap: 2,\n  },\n  statTitle: {\n    fontSize: 13,\n    color: '#666',\n    fontWeight: '500',\n  },\n  statValue: {\n    fontSize: 28,\n    fontWeight: '800',\n    marginVertical: 4,\n  },\n  statSubtitle: {\n    fontSize: 11,\n    color: '#999',\n  },\n  infoCard: {\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 3,\n  },\n  infoRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingVertical: 12,\n  },\n  infoIconContainer: {\n    width: 48,\n    height: 48,\n    borderRadius: 24,\n    backgroundColor: 'rgba(218, 145, 62, 0.1)',\n    alignItems: 'center',\n    justifyContent: 'center',\n    marginRight: 16,\n  },\n  infoContent: {\n    flex: 1,\n  },\n  infoLabel: {\n    fontSize: 13,\n    color: '#999',\n    marginBottom: 4,\n  },\n  infoValue: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: '#333',\n  },\n  infoDivider: {\n    height: 1,\n    backgroundColor: '#f0f0f0',\n    marginVertical: 8,\n  },\n  badgesContainer: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    gap: 12,\n  },\n  badgeCard: {\n    width: CARD_WIDTH,\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    alignItems: 'center',\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 3,\n  },\n  badgeAchieved: {\n    borderWidth: 2,\n    borderColor: '#4CAF50',\n  },\n  badgeIcon: {\n    width: 72,\n    height: 72,\n    borderRadius: 36,\n    backgroundColor: '#f5f5f5',\n    alignItems: 'center',\n    justifyContent: 'center',\n    marginBottom: 12,\n  },\n  badgeIconAchieved: {\n    backgroundColor: '#FFF8DC',\n  },\n  badgeTitle: {\n    fontSize: 14,\n    fontWeight: '700',\n    color: '#333',\n    textAlign: 'center',\n    marginBottom: 4,\n  },\n  badgeDescription: {\n    fontSize: 11,\n    color: '#999',\n    textAlign: 'center',\n  },\n  achievedBadge: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 4,\n    marginTop: 8,\n    paddingHorizontal: 10,\n    paddingVertical: 4,\n    backgroundColor: '#E8F5E9',\n    borderRadius: 12,\n  },\n  achievedText: {\n    fontSize: 11,\n    color: '#4CAF50',\n    fontWeight: '600',\n  },\n  footerSpace: {\n    height: 40,\n  },\n});","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/_layout.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'registerScrollRef'. Either include it or remove the dependency array.","line":45,"column":6,"nodeType":"ArrayExpression","endLine":45,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [registerScrollRef]","fix":{"range":[2005,2007],"text":"[registerScrollRef]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'makeAuthenticatedRequest', 'prefetchAllMessages', and 'prefetchConversationsOverview'. Either include them or remove the dependency array.","line":53,"column":6,"nodeType":"ArrayExpression","endLine":53,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [isLoggedIn, makeAuthenticatedRequest, prefetchAllMessages, prefetchConversationsOverview]","fix":{"range":[2292,2304],"text":"[isLoggedIn, makeAuthenticatedRequest, prefetchAllMessages, prefetchConversationsOverview]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Stack, useLocalSearchParams, usePathname } from 'expo-router';\nimport React, { useEffect, useRef, useState } from 'react';\nimport { StyleSheet, View } from 'react-native';\nimport BottomBar from '../../components/BottomBar';\nimport SwipeableContainer, { SwipeableContainerHandle } from '../../components/SwipeableContainer';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useChat } from '../../contexts/ChatContext';\nimport { useNavigation } from '../../contexts/NavigationContext';\n\n// Import the actual screen components\nimport AboutScreen from './about';\nimport ConversationsScreen from './conversations';\nimport IndexScreen from './index';\n\nexport default function TabsLayout() {\n  const [chatText, setChatText] = useState(\"\");\n  const pathname = usePathname();\n  const { conversationId } = useLocalSearchParams();\n  const { registerScrollRef } = useNavigation();\n  const swipeControlRef = useRef<SwipeableContainerHandle>(null);\n  const { isLoggedIn, makeAuthenticatedRequest } = useAuth();\n  const { prefetchConversationsOverview, prefetchAllMessages } = useChat();\n\n  const deriveIndexFromPath = (p: string) => {\n    if (p.includes('/conversations')) return 0;\n    if (p.includes('/about')) return 2;\n    return 1; // index/home\n  };\n\n  // Determine if we're showing a detail route or other full-screen pages\n  const isInConversationDetail = pathname.includes('conversation-direct') || \n                                  pathname.includes('conversation-group') || \n                                  pathname.includes('conversation-detail') || \n                                  pathname.includes('conversation-management') || \n                                  pathname.includes('add-group-members') || \n                                  pathname.includes('/friends');\n\n  const handleSendMessage = () => {\n    console.log(\"Envoi du message:\", chatText);\n  };\n\n  // Enregistrer le ref du swipe container\n  React.useEffect(() => {\n    registerScrollRef(swipeControlRef);\n  }, []);\n\n  // Bootstrap: au premier rendu des tabs (si connect√©), pr√©charger overview + tous messages\n  useEffect(() => {\n    if (!isLoggedIn) return;\n    prefetchConversationsOverview(makeAuthenticatedRequest).then(() => {\n      prefetchAllMessages(makeAuthenticatedRequest);\n    });\n  }, [isLoggedIn]);\n\n  console.log('Layout rendered with path:', pathname, 'isInConversationDetail:', isInConversationDetail);\n  \n  return (\n    <View style={styles.container}>\n      {/* Stack navigator - pour toutes les routes */}\n      <Stack\n        screenOptions={{\n          headerShown: false,\n          animation: 'none',\n        }}\n      >\n        <Stack.Screen name=\"index\" />\n        <Stack.Screen name=\"conversations\" />\n        <Stack.Screen name=\"about\" />\n        <Stack.Screen name=\"friends\" />\n        <Stack.Screen name=\"conversation-direct\" />\n        <Stack.Screen name=\"conversation-group\" />\n        {/* backward-compat pour anciennes navigations √©ventuelles */}\n        <Stack.Screen name=\"conversation-detail\" />\n        <Stack.Screen name=\"conversation-management\" />\n        <Stack.Screen name=\"add-group-members\" />\n      </Stack>\n\n      {/* SwipeableContainer - overlay quand on n'est pas dans detail */}\n      {!isInConversationDetail && (\n        <View style={styles.swipeContainer}>\n          <SwipeableContainer\n            initialIndex={deriveIndexFromPath(pathname)}\n            controlRef={swipeControlRef}\n          >\n            <ConversationsScreen />\n            <IndexScreen />\n            <AboutScreen />\n          </SwipeableContainer>\n        </View>\n      )}\n\n      {/* BottomBar - toujours visible */}\n      <BottomBar\n        currentRoute={pathname}\n        chatText={chatText}\n        setChatText={setChatText}\n        chatRecipient={isInConversationDetail ? \"Contact\" : \"\"}\n        onSendMessage={isInConversationDetail ? handleSendMessage : undefined}\n        conversationId={isInConversationDetail ? conversationId as string : undefined}\n      />\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    position: 'relative',\n  },\n  swipeContainer: {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    right: 0,\n    bottom: 0,\n    zIndex: 100,\n    backgroundColor: '#f0f2f5', // Fond opaque pour cacher le Stack en dessous\n  },\n});","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/about.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isDerniereReponse' is assigned a value but never used.","line":29,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDate' is assigned a value but never used.","line":88,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":88,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'lastAnswer' is assigned a value but never used.","line":93,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import DefaultAvatar from '@/components/DefaultAvatar';\nimport { BACKGROUND_GRAY, ECHO_COLOR } from '@/constants/colors';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Ionicons } from '@expo/vector-icons';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { router } from 'expo-router';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { ActivityIndicator, Alert, Image, RefreshControl, ScrollView, StyleSheet, Text, TouchableOpacity, View } from 'react-native';\n\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\ninterface ProfileStats {\n  total_connexions: number;\n  total_evenements: number;\n  evenements_ce_mois: number;\n  total_reponses: number;\n  date_inscription: string;\n  derniere_activite: string;\n}\n\ninterface DerniereReponse {\n  question: string;\n  reponse: string;\n  date: string;\n}\n\nconst isDerniereReponse = (val: any): val is DerniereReponse => {\n  return val && typeof val === 'object' && 'question' in val && 'reponse' in val && 'date' in val;\n};\n\nexport default function ProfileScreen() {\n  const { user, accessToken, logout, makeAuthenticatedRequest } = useAuth();\n  const [stats, setStats] = useState<ProfileStats | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n\n  const fetchStats = useCallback(async () => {\n    try {\n      if (!accessToken) {\n        setLoading(false);\n        setRefreshing(false);\n        return;\n      }\n\n      const response = await makeAuthenticatedRequest(`${API_BASE_URL}/api/auth/profile/stats/`);\n      if (response.ok) {\n        const data = await response.json();\n        setStats(data);\n      } else {\n        console.warn('Stats request failed with status', response.status);\n      }\n    } catch (error) {\n      console.warn('Error fetching stats:', error);\n    } finally {\n      setLoading(false);\n      setRefreshing(false);\n    }\n  }, [makeAuthenticatedRequest, accessToken]);\n\n  useEffect(() => {\n    fetchStats();\n  }, [fetchStats]);\n\n  const onRefresh = () => {\n    setRefreshing(true);\n    fetchStats();\n  };\n\n  const handleLogout = () => {\n    Alert.alert(\n      \"D√©connexion\",\n      \"√ätes-vous s√ªr de vouloir vous d√©connecter ?\",\n      [\n        { text: \"Annuler\", style: \"cancel\" },\n        { \n          text: \"D√©connexion\", \n          style: \"destructive\",\n          onPress: async () => {\n            await logout();\n          }\n        }\n      ]\n    );\n  };\n\n  const formatDate = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });\n  };\n\n  const lastAnswer: unknown = user?.derniere_reponse as unknown;\n\n  if (loading) {\n    return (\n      <View style={styles.loadingContainer}>\n        <ActivityIndicator size=\"large\" color={ECHO_COLOR} />\n      </View>\n    );\n  }\n\n  // Fixed profile picture logic - using photo_profil_url directly\n  const profilePictureUrl = (user as any)?.photo_profil_url;\n\n  return (\n    <ScrollView \n      style={styles.container}\n      contentContainerStyle={styles.content}\n      refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}\n      showsVerticalScrollIndicator={false}\n    >\n      <LinearGradient colors={['rgba(240, 250, 248, 1)', 'rgba(200, 235, 225, 1)']} style={styles.hero} start={{x:0, y:0}} end={{x:1, y:1}}>\n        <View style={styles.heroTopRow}>\n          <TouchableOpacity onPress={handleLogout} style={styles.iconButton}>\n            <Ionicons name=\"log-out-outline\" size={22} color=\"rgba(10, 145, 104, 1)\" />\n          </TouchableOpacity>\n          <TouchableOpacity onPress={() => router.push('/edit-profile' as any)} style={styles.iconButton}>\n            <Ionicons name=\"create-outline\" size={22} color=\"rgba(10, 145, 104, 1)\" />\n          </TouchableOpacity>\n        </View>\n\n        <View style={styles.avatarWrap}>\n          {profilePictureUrl ? (\n            <Image source={{ uri: profilePictureUrl }} style={styles.avatarImage} />\n          ) : (\n            <DefaultAvatar name={user?.username || 'User'} size={110} />\n          )}\n        </View>\n\n        <Text style={styles.nameText}>{user?.username}</Text>\n        {user?.surnom ? (\n          <Text style={styles.tagline}>&ldquo;{user.surnom}&rdquo;</Text>\n        ) : null}\n        {user?.bio ? (\n          <Text style={styles.bioText}>{user.bio}</Text>\n        ) : null}\n\n        {(\n          <View style={styles.quickStatsRow}>\n            <TouchableOpacity style={styles.quickStatCard} onPress={() => router.push('/friends' as any)}>\n              <Ionicons name=\"people-outline\" size={18} color={ECHO_COLOR} />\n              <Text style={styles.quickStatNum}>{(user as any)?.nb_amis ?? 0}</Text>\n              <Text style={styles.quickStatLabel}>Amis</Text>\n            </TouchableOpacity>\n            <TouchableOpacity style={styles.quickStatCard} onPress={() => router.push('/(screens)/calendar' as any)}>\n              <Ionicons name=\"calendar-outline\" size={18} color={ECHO_COLOR} />\n              <Text style={styles.quickStatNum}>{stats?.total_evenements ?? 0}</Text>\n              <Text style={styles.quickStatLabel}>Calendrier</Text>\n            </TouchableOpacity>\n            <TouchableOpacity style={styles.quickStatCard} onPress={() => router.push('/stats' as any)}>\n              <Ionicons name=\"bar-chart-outline\" size={18} color={ECHO_COLOR} />\n              <Text style={styles.quickStatNum}>{stats?.total_reponses ?? 0}</Text>\n              <Text style={styles.quickStatLabel}>Statistiques</Text>\n            </TouchableOpacity>\n          </View>\n        )}\n      </LinearGradient>\n\n      <View style={styles.cardsGrid}>\n        <View style={styles.card}>\n          <View style={styles.cardHeader}>\n            <Ionicons name=\"document-text-outline\" size={18} color={ECHO_COLOR} />\n            <Text style={styles.cardTitle}>Posts</Text>\n            <TouchableOpacity style={styles.newPostBtn} onPress={() => router.push('/posts/new' as any)}>\n              <Ionicons name=\"add\" size={18} color=\"#fff\" />\n              <Text style={styles.newPostText}>Nouveau</Text>\n            </TouchableOpacity>\n          </View>\n          <View style={styles.emptyState}>\n            <Ionicons name=\"leaf-outline\" size={20} color=\"#9bb89f\" />\n            <Text style={styles.emptyText}>Vous n avez pas encore publi√©. Partagez votre premier post !</Text>\n          </View>\n        </View>\n      </View>\n\n      <View style={styles.footerSpace} />\n    </ScrollView>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: BACKGROUND_GRAY,\n  },\n  content: {\n    paddingBottom: 40,\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: BACKGROUND_GRAY,\n  },\n  hero: {\n    paddingTop: 60,\n    paddingBottom: 30,\n    paddingHorizontal: 20,\n    alignItems: 'center',\n  },\n  heroTopRow: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignSelf: 'stretch',\n    marginBottom: 20,\n  },\n  iconButton: {\n    width: 44,\n    height: 44,\n    borderRadius: 22,\n    backgroundColor: 'rgba(255, 255, 255, 0.9)',\n    alignItems: 'center',\n    justifyContent: 'center',\n    shadowColor: '#000',\n    shadowOpacity: 0.1,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 4,\n    elevation: 3,\n  },\n  avatarWrap: {\n    marginBottom: 16,\n  },\n  avatarImage: {\n    width: 110,\n    height: 110,\n    borderRadius: 55,\n    borderWidth: 4,\n    borderColor: 'white',\n  },\n  nameText: {\n    fontSize: 24,\n    fontWeight: '800',\n    color: '#1b5e20',\n  },\n  tagline: {\n    fontSize: 15,\n    color: '#5a7a5f',\n    marginTop: 4,\n    fontStyle: 'italic',\n  },\n  bioText: {\n    textAlign: 'center',\n    color: '#375a3b',\n    marginTop: 8,\n    paddingHorizontal: 24,\n  },\n  quickStatsRow: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    marginTop: 16,\n  },\n  quickStatCard: {\n    flex: 1,\n    backgroundColor: 'white',\n    paddingVertical: 14,\n    paddingHorizontal: 12,\n    borderRadius: 14,\n    marginHorizontal: 4,\n    alignItems: 'center',\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 6,\n    elevation: 2,\n  },\n  quickStatNum: {\n    marginTop: 6,\n    fontSize: 18,\n    fontWeight: '700',\n    color: '#1b5e20',\n  },\n  quickStatLabel: {\n    fontSize: 11,\n    color: '#6c8a6e',\n    marginTop: 2,\n  },\n  cardsGrid: {\n    paddingHorizontal: 16,\n    marginTop: 16,\n  },\n  card: {\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    marginBottom: 16,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 2,\n  },\n  cardHeader: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    marginBottom: 6,\n  },\n  cardTitle: {\n    fontSize: 16,\n    fontWeight: '700',\n    color: '#333',\n    marginLeft: 8,\n  },\n  newPostBtn: {\n    marginLeft: 'auto',\n    flexDirection: 'row',\n    alignItems: 'center',\n    backgroundColor: 'rgba(10, 145, 104, 1)',\n    borderRadius: 10,\n    paddingHorizontal: 10,\n    paddingVertical: 6,\n  },\n  newPostText: { \n    color: '#fff', \n    fontWeight: '700', \n    marginLeft: 6 \n  },\n  emptyState: { \n    flexDirection: 'row', \n    alignItems: 'center', \n    paddingVertical: 8 \n  },\n  emptyText: { \n    marginLeft: 8, \n    color: '#6e7f71' \n  },\n  footerSpace: {\n    height: 60,\n  },\n});","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/add-group-members.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'GroupMember' is defined but never used.","line":33,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":33,"endColumn":22},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'groupName', 'groupUuid', and 'loadGroupMembers'. Either include them or remove the dependency array.","line":56,"column":6,"nodeType":"ArrayExpression","endLine":56,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [groupName, groupUuid, loadGroupMembers]","fix":{"range":[1767,1769],"text":"[groupName, groupUuid, loadGroupMembers]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'searchUsers'. Either include it or remove the dependency array.","line":68,"column":6,"nodeType":"ArrayExpression","endLine":68,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [query, searchUsers]","fix":{"range":[2006,2013],"text":"[query, searchUsers]"}}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":351,"column":47,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[12353,12401],"text":"\n            Aucun utilisateur ne correspond √† &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[12353,12401],"text":"\n            Aucun utilisateur ne correspond √† &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[12353,12401],"text":"\n            Aucun utilisateur ne correspond √† &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[12353,12401],"text":"\n            Aucun utilisateur ne correspond √† &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":351,"column":55,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[12408,12420],"text":"&quot;\n          "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[12408,12420],"text":"&ldquo;\n          "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[12408,12420],"text":"&#34;\n          "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[12408,12420],"text":"&rdquo;\n          "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { FloatingHeader } from '@/components/FloatingHeader';\nimport { styles } from '@/styles/appStyles';\nimport { Ionicons } from '@expo/vector-icons';\nimport { Image } from 'expo-image';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { useLocalSearchParams } from 'expo-router';\nimport React, { useEffect, useState } from 'react';\nimport {\n  ActivityIndicator,\n  Alert,\n  FlatList,\n  StyleSheet,\n  Text,\n  TextInput,\n  TouchableOpacity,\n  View\n} from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport { useAuth } from '../../contexts/AuthContext';\n\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\ninterface User {\n  id: number;\n  uuid: string;\n  username: string;\n  surnom?: string;\n  photo_profil_url?: string;\n}\n\ninterface GroupMember {\n  user_uuid: string;\n  username: string;\n  surnom?: string;\n}\n\nexport default function AddGroupMembers() {\n  const { groupUuid, groupName } = useLocalSearchParams();\n  const { makeAuthenticatedRequest } = useAuth();\n  const insets = useSafeAreaInsets();\n  \n  const [query, setQuery] = useState('');\n  const [searchResults, setSearchResults] = useState<User[]>([]);\n  const [isSearching, setIsSearching] = useState(false);\n  const [selectedUsers, setSelectedUsers] = useState<Set<string>>(new Set());\n  const [groupMembers, setGroupMembers] = useState<Set<string>>(new Set());\n  const [loading, setLoading] = useState(true);\n  const [sending, setSending] = useState(false);\n\n  useEffect(() => {\n    console.log('üÜï Page add-group-members mont√©e');\n    console.log('üìã Params re√ßus:', { groupUuid, groupName });\n    loadGroupMembers();\n  }, []);\n\n  useEffect(() => {\n    const timeoutId = setTimeout(() => {\n      if (query.trim()) {\n        searchUsers(query);\n      } else {\n        setSearchResults([]);\n      }\n    }, 300);\n    \n    return () => clearTimeout(timeoutId);\n  }, [query]);\n\n  const loadGroupMembers = async () => {\n    try {\n      console.log('üì° Chargement membres du groupe:', groupUuid);\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/${groupUuid}/members/`\n      );\n      \n      if (response.ok) {\n        const members = await response.json();\n        console.log('üìã Membres re√ßus:', members);\n        console.log('üìã Structure premier membre:', members[0]);\n        // Extraire les UUIDs des membres (la structure peut √™tre m.user_uuid ou m.user.uuid)\n        const memberUuids = new Set<string>(\n          members.map((m: any) => m.user_uuid || m.user?.uuid).filter(Boolean)\n        );\n        setGroupMembers(memberUuids);\n        console.log('üë• Membres actuels du groupe:', memberUuids.size, Array.from(memberUuids));\n      } else {\n        console.error('‚ùå Erreur chargement membres:', response.status);\n        const errorData = await response.json().catch(() => ({}));\n        console.error('‚ùå D√©tails erreur:', errorData);\n      }\n    } catch (error) {\n      console.error('‚ùå Erreur chargement membres:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const searchUsers = async (searchQuery: string) => {\n    setIsSearching(true);\n    try {\n      console.log('üîç Recherche utilisateurs avec query:', searchQuery);\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/api/users/`\n      );\n\n      if (!response.ok) {\n        console.error('‚ùå Erreur recherche utilisateurs:', response.status);\n        throw new Error(`Erreur ${response.status}`);\n      }\n\n      const data = await response.json();\n      let allUsers: User[] = Array.isArray(data) ? data : (data.results || []);\n      console.log('üìã Total utilisateurs:', allUsers.length);\n      \n      // Filtrer par surnom ou username\n      const users = allUsers.filter(u => {\n        const surnom = (u.surnom || '').toLowerCase();\n        const username = (u.username || '').toLowerCase();\n        const q = searchQuery.toLowerCase();\n        return surnom.includes(q) || username.includes(q);\n      });\n      console.log('üìã Utilisateurs correspondants:', users.length);\n      \n      // Exclure les membres d√©j√† dans le groupe\n      const availableUsers = users.filter(u => !groupMembers.has(u.uuid));\n      \n      setSearchResults(availableUsers);\n      console.log('‚úÖ Utilisateurs disponibles (apr√®s exclusion membres):', availableUsers.length);\n      console.log('üìã Preview:', availableUsers.slice(0, 3).map(u => u.surnom || u.username));\n    } catch (error) {\n      console.error('‚ùå Erreur recherche utilisateurs:', error);\n    } finally {\n      setIsSearching(false);\n    }\n  };\n\n  const toggleUserSelection = (userUuid: string) => {\n    setSelectedUsers(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(userUuid)) {\n        newSet.delete(userUuid);\n      } else {\n        newSet.add(userUuid);\n      }\n      return newSet;\n    });\n  };\n\n  const handleInvite = async () => {\n    if (selectedUsers.size === 0) {\n      Alert.alert('Aucune s√©lection', 'Veuillez s√©lectionner au moins un utilisateur');\n      return;\n    }\n\n    setSending(true);\n    try {\n      console.log('üì§ Envoi invitations pour:', selectedUsers.size, 'utilisateurs');\n      console.log('üì§ Groupe UUID:', groupUuid);\n      console.log('üì§ Groupe Nom:', groupName);\n      console.log('üì§ UUIDs utilisateurs:', Array.from(selectedUsers));\n      console.log('üì§ URL compl√®te:', `${API_BASE_URL}/groups/${groupUuid}/invite/`);\n      \n      // Envoyer une invitation pour chaque utilisateur s√©lectionn√©\n      const invitations = Array.from(selectedUsers).map(async userUuid => {\n        console.log('üì® Envoi invitation pour:', userUuid);\n        \n        const payload = {\n          target_user_uuid: userUuid,\n          message: `Invitation √† rejoindre ${groupName}`\n        };\n        console.log('üì® Payload:', JSON.stringify(payload, null, 2));\n        \n        const response = await makeAuthenticatedRequest(\n          `${API_BASE_URL}/groups/${groupUuid}/invite/`,\n          {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify(payload)\n          }\n        );\n        \n        console.log('üì® R√©ponse statut pour', userUuid, ':', response.status);\n        \n        if (!response.ok) {\n          const errorData = await response.json().catch(() => ({}));\n          console.error('‚ùå Erreur invitation:', {\n            userUuid,\n            status: response.status,\n            errorData: JSON.stringify(errorData, null, 2)\n          });\n          return { success: false, userUuid, error: errorData, status: response.status };\n        }\n        \n        const data = await response.json();\n        console.log('‚úÖ Invitation envoy√©e:', {\n          userUuid,\n          responseData: data\n        });\n        return { success: true, userUuid };\n      });\n\n      const results = await Promise.all(invitations);\n      const successCount = results.filter(r => r.success).length;\n      const failedCount = results.length - successCount;\n      \n      console.log('üìä R√©sultats finaux:', { successCount, failedCount, total: results.length });\n      \n      if (successCount > 0) {\n        const message = failedCount > 0\n          ? `${successCount} invitation(s) envoy√©e(s), ${failedCount} √©chec(s)`\n          : `${successCount} invitation(s) envoy√©e(s) avec succ√®s !`;\n        \n        Alert.alert(\n          'Invitations envoy√©es',\n          message,\n          [{ \n            text: 'OK', \n            onPress: () => {\n              // Recharger les membres du groupe\n              loadGroupMembers();\n              // Vider la s√©lection\n              setSelectedUsers(new Set());\n              setQuery('');\n              setSearchResults([]);\n            }\n          }]\n        );\n      } else {\n        const firstError = results.find(r => !r.success);\n        \n        // G√©rer les erreurs sp√©cifiques\n        let errorTitle = 'Erreur';\n        let errorMessage = 'Impossible d\\'envoyer les invitations.';\n        \n        if (firstError?.error?.non_field_errors) {\n          const errors = firstError.error.non_field_errors;\n          if (Array.isArray(errors) && errors.length > 0) {\n            const errorText = errors[0];\n            if (errorText.includes('d√©j√† en cours')) {\n              errorTitle = 'Invitation d√©j√† envoy√©e';\n              errorMessage = 'Une invitation a d√©j√† √©t√© envoy√©e √† cet utilisateur. Veuillez attendre sa r√©ponse.';\n            } else {\n              errorMessage = errorText;\n            }\n          }\n        } else if (firstError?.error?.detail) {\n          errorMessage = firstError.error.detail;\n        } else if (firstError?.error?.error) {\n          errorMessage = firstError.error.error;\n        } else if (firstError?.error && typeof firstError.error === 'object') {\n          errorMessage = JSON.stringify(firstError.error);\n        }\n        \n        console.error('‚ùå Message d\\'erreur final:', errorMessage);\n        Alert.alert(errorTitle, errorMessage);\n      }\n    } catch (error) {\n      console.error('‚ùå Erreur globale envoi invitations:', error);\n      Alert.alert('Erreur', `Impossible d'envoyer les invitations: ${error}`);\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const UserSquare = ({ user }: { user: User }) => {\n    const isSelected = selectedUsers.has(user.uuid);\n    \n    return (\n      <TouchableOpacity\n        style={[\n          styles.conversationSquare,\n          isSelected && localStyles.userSquareSelected\n        ]}\n        onPress={() => toggleUserSelection(user.uuid)}\n        activeOpacity={0.7}\n      >\n        {user.photo_profil_url ? (\n          <Image source={{ uri: user.photo_profil_url }} style={styles.avatar} />\n        ) : (\n          <View style={[styles.avatar, { backgroundColor: 'rgba(10, 145, 104, 0.2)', justifyContent: 'center', alignItems: 'center' }]}>\n            <Ionicons name=\"person\" size={50} color=\"rgba(10, 145, 104, 1)\" />\n          </View>\n        )}\n        \n        {isSelected && (\n          <View style={localStyles.selectedBadge}>\n            <Ionicons name=\"checkmark-circle\" size={28} color=\"rgba(10, 145, 104, 1)\" />\n          </View>\n        )}\n        \n        <View style={styles.conversationNameBadge}>\n          <Text style={styles.conversationName} numberOfLines={1}>\n            {user.surnom || user.username}\n          </Text>\n        </View>\n      </TouchableOpacity>\n    );\n  };\n\n  if (loading) {\n    return (\n      <View style={[localStyles.container, { paddingTop: (insets.top || 0), justifyContent: 'center', alignItems: 'center' }]}>\n        <ActivityIndicator size=\"large\" color=\"rgba(10, 145, 104, 1)\" />\n      </View>\n    );\n  }\n\n  return (\n    <View style={[localStyles.container, { paddingTop: (insets.top || 0) }]}>\n      {/* Header unifi√© */}\n      <FloatingHeader title=\"Ajouter des membres\" icon=\"person-add\" />\n\n      {/* Info groupe */}\n      <View style={localStyles.groupInfoBadge}>\n        <Ionicons name=\"people\" size={16} color=\"rgba(10, 145, 104, 1)\" />\n        <Text style={localStyles.groupNameText}>{groupName}</Text>\n      </View>\n\n      {/* Barre de recherche style app */}\n      <View style={localStyles.searchContainer}>\n        <TextInput\n          style={localStyles.searchInput}\n          placeholder=\"Rechercher un utilisateur...\"\n          placeholderTextColor=\"#777\"\n          value={query}\n          onChangeText={setQuery}\n        />\n      </View>\n\n      {/* Liste des utilisateurs */}\n      {isSearching ? (\n        <View style={localStyles.loadingContainer}>\n          <ActivityIndicator size=\"large\" color=\"rgba(10, 145, 104, 1)\" />\n          <Text style={localStyles.loadingText}>Recherche en cours...</Text>\n        </View>\n      ) : searchResults.length > 0 ? (\n        <FlatList\n          data={searchResults}\n          keyExtractor={(item) => item.uuid}\n          renderItem={({ item }) => <UserSquare user={item} />}\n          numColumns={3}\n          columnWrapperStyle={styles.row}\n          contentContainerStyle={localStyles.grid}\n        />\n      ) : query.trim().length > 0 ? (\n        <View style={localStyles.emptyContainer}>\n          <Ionicons name=\"search-outline\" size={64} color=\"#ccc\" />\n          <Text style={localStyles.emptyTitle}>Aucun r√©sultat</Text>\n          <Text style={localStyles.emptyText}>\n            Aucun utilisateur ne correspond √† \"{query}\"\n          </Text>\n        </View>\n      ) : (\n        <View style={localStyles.emptyContainer}>\n          <Ionicons name=\"person-add-outline\" size={64} color=\"rgba(10, 145, 104, 0.3)\" />\n          <Text style={localStyles.emptyTitle}>Rechercher des utilisateurs</Text>\n          <Text style={localStyles.emptyText}>\n            Utilisez la barre de recherche pour trouver des personnes √† inviter dans le groupe\n          </Text>\n        </View>\n      )}\n\n      {/* Bouton d'invitation flottant */}\n      {selectedUsers.size > 0 && (\n        <TouchableOpacity\n          style={localStyles.floatingInviteButton}\n          onPress={handleInvite}\n          activeOpacity={0.8}\n          disabled={sending}\n        >\n          <LinearGradient\n            colors={sending \n              ? ['rgba(10, 145, 104, 0.6)', 'rgba(10, 145, 104, 0.5)']\n              : ['rgba(10, 145, 104, 1)', 'rgba(10, 145, 104, 0.9)']\n            }\n            style={localStyles.inviteButtonGradient}\n          >\n            {sending ? (\n              <>\n                <ActivityIndicator size=\"small\" color=\"#fff\" />\n                <Text style={localStyles.inviteButtonText}>\n                  Envoi en cours...\n                </Text>\n              </>\n            ) : (\n              <>\n                <Ionicons name=\"send\" size={24} color=\"#fff\" />\n                <Text style={localStyles.inviteButtonText}>\n                  Inviter {selectedUsers.size} personne{selectedUsers.size > 1 ? 's' : ''}\n                </Text>\n              </>\n            )}\n          </LinearGradient>\n        </TouchableOpacity>\n      )}\n    </View>\n  );\n}\n\nconst localStyles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: 'rgba(245,250,245,0.9)',\n  },\n  groupInfoBadge: {\n    position: 'absolute',\n    top: 120,\n    left: 20,\n    right: 20,\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 8,\n    backgroundColor: 'rgba(10, 145, 104, 0.1)',\n    paddingHorizontal: 16,\n    paddingVertical: 10,\n    borderRadius: 20,\n    zIndex: 5,\n  },\n  groupNameText: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: 'rgba(10, 145, 104, 1)',\n  },\n  searchContainer: {\n    position: 'absolute',\n    top: 170,\n    left: 20,\n    right: 20,\n    backgroundColor: 'rgba(255,255,255,0.6)',\n    borderRadius: 25,\n    shadowColor: '#fff',\n    shadowOpacity: 0.9,\n    elevation: 5,\n    paddingHorizontal: 15,\n    paddingVertical: 5,\n    zIndex: 10,\n  },\n  searchInput: {\n    fontSize: 16,\n    paddingVertical: 8,\n    color: '#333',\n  },\n  grid: {\n    paddingTop: 230,\n    paddingBottom: 200,\n    paddingHorizontal: 10,\n  },\n  userSquareSelected: {\n    shadowColor: 'rgba(10, 145, 104, 0.8)',\n    shadowOpacity: 1,\n    shadowRadius: 8,\n    elevation: 8,\n    transform: [{ scale: 0.98 }],\n  },\n  selectedBadge: {\n    position: 'absolute',\n    top: 8,\n    right: 8,\n    backgroundColor: '#fff',\n    borderRadius: 14,\n    zIndex: 10,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.5,\n    shadowRadius: 4,\n    elevation: 5,\n  },\n  floatingInviteButton: {\n    position: 'absolute',\n    bottom: 115,\n    left: 20,\n    right: 20,\n    zIndex: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.5)',\n    shadowOffset: { width: 0, height: 6 },\n    shadowOpacity: 0.6,\n    shadowRadius: 12,\n    elevation: 10,\n  },\n  inviteButtonGradient: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    gap: 10,\n    paddingVertical: 16,\n    paddingHorizontal: 24,\n    borderRadius: 28,\n  },\n  inviteButtonText: {\n    color: '#fff',\n    fontSize: 16,\n    fontWeight: 'bold',\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    paddingTop: 200,\n  },\n  loadingText: {\n    marginTop: 15,\n    fontSize: 15,\n    color: '#666',\n  },\n  emptyContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    paddingHorizontal: 40,\n    paddingTop: 100,\n  },\n  emptyTitle: {\n    fontSize: 22,\n    fontWeight: 'bold',\n    color: '#333',\n    marginTop: 20,\n    textAlign: 'center',\n  },\n  emptyText: {\n    fontSize: 15,\n    color: '#666',\n    textAlign: 'center',\n    marginTop: 12,\n    lineHeight: 22,\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/conversation-direct.tsx","messages":[{"ruleId":"@typescript-eslint/array-type","severity":1,"message":"Array type using 'Array<T>' is forbidden. Use 'T[]' instead.","line":28,"column":17,"nodeType":"TSTypeReference","messageId":"errorStringArray","endLine":28,"endColumn":129,"fix":{"range":[769,881],"text":"{ uuid: string; file_type: string; file_url: string; thumbnail_url?: string; original_filename?: string }[]"}},{"ruleId":"@typescript-eslint/array-type","severity":1,"message":"Array type using 'Array<T>' is forbidden. Use 'T[]' instead.","line":38,"column":25,"nodeType":"TSTypeReference","messageId":"errorStringArray","endLine":44,"endColumn":5,"fix":{"range":[1066,1194],"text":"{\n    username: string;\n    surnom?: string;\n    user_uuid: string;\n    user?: number;\n    photo_profil_url?: string;\n  }[]"}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'getCachedConversationInfo' and 'getCachedMessages'. Either include them or remove the dependency array.","line":215,"column":6,"nodeType":"ArrayExpression","endLine":215,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [conversationId, getCachedConversationInfo, getCachedMessages]","fix":{"range":[9123,9139],"text":"[conversationId, getCachedConversationInfo, getCachedMessages]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'setTransitionPosition', 'transitionPosition', and 'zoomAnim'. Either include them or remove the dependency array.","line":225,"column":6,"nodeType":"ArrayExpression","endLine":225,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [setTransitionPosition, transitionPosition, zoomAnim]","fix":{"range":[9404,9406],"text":"[setTransitionPosition, transitionPosition, zoomAnim]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'sendMessageHandler' and 'setSendMessage'. Either include them or remove the dependency array.","line":230,"column":6,"nodeType":"ArrayExpression","endLine":230,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [localWebsocket, conversationId, setSendMessage, sendMessageHandler]","fix":{"range":[9520,9552],"text":"[localWebsocket, conversationId, setSendMessage, sendMessageHandler]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'connectWebSocket', 'fetchMessages', and 'localWebsocket'. Either include them or remove the dependency array.","line":238,"column":6,"nodeType":"ArrayExpression","endLine":238,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [conversationId, accessToken, fetchMessages, connectWebSocket, localWebsocket]","fix":{"range":[9743,9772],"text":"[conversationId, accessToken, fetchMessages, connectWebSocket, localWebsocket]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":2,"source":"import DefaultAvatar from '@/components/DefaultAvatar';\nimport { styles } from '@/styles/appStyles';\nimport { Ionicons } from '@expo/vector-icons';\nimport { router, Stack, useLocalSearchParams } from 'expo-router';\nimport React, { useEffect, useRef, useState } from 'react';\nimport {\n  ActivityIndicator,\n  Animated,\n  Dimensions,\n  KeyboardAvoidingView,\n  Platform,\n  ScrollView,\n  Text,\n  TouchableOpacity,\n  View\n} from 'react-native';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useChat } from '../../contexts/ChatContext';\nimport { useTransition } from '../../contexts/TransitionContext';\n\ninterface Message {\n  id: number;\n  uuid: string;\n  sender_username: string;\n  content: string;\n  created_at: string;\n  is_read?: boolean;\n  attachments?: Array<{ uuid: string; file_type: string; file_url: string; thumbnail_url?: string; original_filename?: string }>;\n}\n\ninterface ConversationInfo {\n  other_participant?: {\n    username: string;\n    surnom?: string;\n    photo_profil_url?: string;\n    user_uuid?: string;\n  };\n  participants_detail?: Array<{\n    username: string;\n    surnom?: string;\n    user_uuid: string;\n    user?: number;\n    photo_profil_url?: string;\n  }>;\n  is_group?: boolean;\n}\n\nexport default function ConversationDirect() {\n  const { conversationId } = useLocalSearchParams();\n  const { accessToken, user, logout, makeAuthenticatedRequest } = useAuth();\n  const { transitionPosition, setTransitionPosition } = useTransition();\n  const { setWebsocket, setSendMessage, setCurrentConversationId, getCachedMessages, getCachedConversationInfo, primeCache } = useChat();\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [conversationInfo, setConversationInfo] = useState<ConversationInfo | null>(null);\n  const allowedUsernamesRef = useRef<Set<string>>(new Set());\n\n  const [localWebsocket, setLocalWebsocket] = useState<WebSocket | null>(null);\n  const screenDimensions = Dimensions.get('window');\n  const zoomAnim = useRef(new Animated.Value(0)).current;\n  const scrollViewRef = useRef<ScrollView>(null);\n\n  // Utilise le proxy local pour √©viter CORS en d√©veloppement web\n  const API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n    ? \"http://localhost:3001\"\n    : \"https://reseausocial-production.up.railway.app\";\n\n  const connectWebSocket = () => {\n    if (!conversationId || !accessToken) return;\n    try {\n      const ws = new WebSocket(\n        \"wss://reseausocial-production.up.railway.app/ws/chat/\",\n        [\"access_token\", accessToken]\n      );\n      ws.onopen = () => {\n        setLocalWebsocket(ws);\n        setWebsocket(ws);\n        setCurrentConversationId(conversationId as string);\n        ws.send(JSON.stringify({ type: \"mark_as_seen\", conversation_uuid: conversationId }));\n      };\n      ws.onmessage = (event) => {\n        const data = JSON.parse(event.data);\n        if (data.type === \"chat_message\") {\n          // Filtrer par conversation_uuid pour √©viter d'afficher des messages d'autres conversations (groupes)\n          const incomingConvUuid = data.conversation_uuid || data.message?.conversation_uuid;\n          if (!incomingConvUuid || incomingConvUuid !== conversationId) {\n            return; // ignorer les messages d'autres conversations\n          }\n          const msg = data.message || data; // fallback si le backend n'imbrique pas sous message\n          // Optionnel: filtrer si on conna√Æt les deux participants\n          if (allowedUsernamesRef.current.size > 0) {\n            const senderOk = msg.sender_username && allowedUsernamesRef.current.has(msg.sender_username);\n            const isGroupSystem = typeof msg.content === 'string' && (\n              msg.content.startsWith('üéâ') ||\n              msg.content.startsWith('üëã') ||\n              msg.content.includes('a rejoint') ||\n              msg.content.includes('Bienvenue')\n            );\n            if (!senderOk || isGroupSystem) {\n              return;\n            }\n          }\n          const newMsg: Message = {\n            id: msg.id,\n            uuid: msg.uuid,\n            sender_username: msg.sender_username,\n            content: msg.content,\n            created_at: msg.created_at,\n            attachments: msg.attachments || [],\n          };\n          setMessages((prev) => {\n            const exists = prev.some((m) => m.uuid === newMsg.uuid);\n            if (exists) return prev.map((m) => (m.uuid === newMsg.uuid ? { ...m, ...newMsg } : m));\n            setTimeout(() => scrollViewRef.current?.scrollToEnd({ animated: true }), 100);\n            return [...prev, newMsg];\n          });\n        }\n      };\n      ws.onerror = (error) => console.error(\"WS error:\", error);\n      ws.onclose = () => {\n        setLocalWebsocket(null);\n        setWebsocket(null);\n        setCurrentConversationId(null);\n      };\n    } catch (error) {\n      console.error(\"WS connect error:\", error);\n    }\n  };\n\n  const sendMessageHandler = (messageText: string) => {\n    if (!messageText.trim() || !localWebsocket) return;\n    localWebsocket.send(JSON.stringify({ type: \"chat_message\", conversation_uuid: conversationId, message: messageText.trim() }));\n    setTimeout(() => scrollViewRef.current?.scrollToEnd({ animated: true }), 100);\n  };\n\n  const fetchMessages = async () => {\n    if (!accessToken) {\n      await logout();\n      return;\n    }\n    try {\n      let convDataLocal: any = null;\n      // D√©tails de la conversation (doit repr√©senter une conversation priv√©e)\n      const convResponse = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/messaging/conversations/${conversationId}/`\n      );\n      if (convResponse.ok) {\n        const convData = await convResponse.json();\n        convDataLocal = convData;\n        setConversationInfo(convData);\n        // D√©terminer les deux participants autoris√©s (moi + autre) si possible\n        const me = user?.username;\n        const other = convData?.participants_detail?.find((p: any) => p.user_uuid !== user?.uuid);\n        const otherUsername = other?.username || convData?.other_participant?.username;\n        const setVals = new Set<string>();\n        if (me) setVals.add(me);\n        if (otherUsername) setVals.add(otherUsername);\n        allowedUsernamesRef.current = setVals;\n\n        // Si on n'a pas pu d√©terminer l'autre participant ici, tenter via la liste des conversations\n        if (allowedUsernamesRef.current.size < 2) {\n          try {\n            const listResp = await makeAuthenticatedRequest(`${API_BASE_URL}/messaging/conversations/`);\n            if (listResp.ok) {\n              const listData = await listResp.json();\n              const convFromList = (Array.isArray(listData) ? listData : (listData.results || [])).find((c: any) => c.uuid === conversationId);\n              const otherFromList = convFromList?.other_participant?.username;\n              if (otherFromList) {\n                const s = new Set<string>(allowedUsernamesRef.current);\n                s.add(otherFromList);\n                allowedUsernamesRef.current = s;\n              }\n            }\n          } catch {}\n        }\n      }\n\n      // Messages\n      const response = await fetch(\n        `${API_BASE_URL}/messaging/conversations/${conversationId}/messages/`,\n        { headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' } }\n      );\n      if (response.status === 401) { await logout(); return; }\n      if (!response.ok) throw new Error(`HTTP ${response.status}`);\n      const data = await response.json();\n      let messagesList = Array.isArray(data) ? data : (data.results || []);\n      // Le endpoint REST ne renvoie pas toujours conversation_uuid ‚Üí garder si absent\n      messagesList = messagesList.filter((m: any) => !m.conversation_uuid || m.conversation_uuid === conversationId);\n      // Optionnel: filtrer par participants seulement si on les conna√Æt\n      if (allowedUsernamesRef.current.size > 0) {\n        messagesList = messagesList.filter((m: any) => allowedUsernamesRef.current.has(m.sender_username));\n      }\n      const sortedMessages = messagesList.sort((a: Message, b: Message) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());\n      setMessages(sortedMessages);\n      // Prime le cache pour ouverture instantan√©e ult√©rieure\n      try { primeCache(String(conversationId), (conversationInfo || convDataLocal), sortedMessages as any); } catch {}\n    } catch (error) {\n      console.error('Erreur messages:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Charger instantan√©ment depuis le cache si disponible\n  useEffect(() => {\n    if (!conversationId) return;\n    const cachedInfo = getCachedConversationInfo(String(conversationId));\n    const cachedMsgs = getCachedMessages(String(conversationId));\n    if (cachedInfo) setConversationInfo(cachedInfo);\n    if (cachedMsgs && cachedMsgs.length >= 0) {\n      const onlyThisConv = (cachedMsgs as any[]).filter((m) => !m.conversation_uuid || m.conversation_uuid === conversationId);\n      setMessages(onlyThisConv as unknown as Message[]);\n      setLoading(false);\n    }\n  }, [conversationId]);\n\n  useEffect(() => {\n    if (transitionPosition) {\n      Animated.spring(zoomAnim, { toValue: 1, useNativeDriver: true, tension: 50, friction: 10 }).start(() => {\n        setTransitionPosition(null);\n      });\n    } else {\n      zoomAnim.setValue(1);\n    }\n  }, []);\n\n  useEffect(() => {\n    setSendMessage(() => sendMessageHandler);\n    return () => setSendMessage(null);\n  }, [localWebsocket, conversationId]);\n\n  useEffect(() => {\n    if (conversationId && accessToken) {\n      fetchMessages();\n      connectWebSocket();\n    }\n    return () => { if (localWebsocket) localWebsocket.close(); };\n  }, [conversationId, accessToken]);\n\n  if (loading) {\n    return (\n      <View style={styles.chatContainer}>\n        <Stack.Screen options={{ headerShown: false }} />\n        <View style={{flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n          <ActivityIndicator size=\"large\" color=\"rgba(55, 116, 69, 1)\" />\n          <Text style={{ marginTop: 10, color: '#666' }}>Chargement des messages...</Text>\n        </View>\n      </View>\n    );\n  }\n\n  const animatedStyle = transitionPosition ? {\n    transform: [\n      { translateX: zoomAnim.interpolate({ inputRange: [0, 1], outputRange: [transitionPosition.x + transitionPosition.width / 2 - screenDimensions.width / 2, 0] }) },\n      { translateY: zoomAnim.interpolate({ inputRange: [0, 1], outputRange: [transitionPosition.y + transitionPosition.height / 2 - screenDimensions.height / 2, 0] }) },\n      { scale: zoomAnim.interpolate({ inputRange: [0, 1], outputRange: [transitionPosition.width / screenDimensions.width, 1] }) },\n    ],\n    opacity: zoomAnim,\n  } : {};\n\n  // Trouver l'autre participant\n  // D‚Äôapr√®s la doc, le d√©tail peut exposer participants[] ou other_participant\n  const otherParticipant = conversationInfo?.participants_detail?.find(p => p.user_uuid !== user?.uuid) || conversationInfo?.other_participant;\n  const headerName = otherParticipant ? (otherParticipant.surnom || otherParticipant.username) : 'Conversation';\n\n  return (\n    <Animated.View style={[styles.chatContainer, animatedStyle]}>\n      {/* Bouton retour */}\n      <TouchableOpacity\n        style={{ position: 'absolute', top: 65, left: 20, zIndex: 20, backgroundColor: 'rgba(10, 145, 104, 0.9)', width: 40, height: 40, borderRadius: 20, justifyContent: 'center', alignItems: 'center', shadowColor: 'rgba(10, 145, 104, 0.4)', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.5, shadowRadius: 8, elevation: 8 }}\n        onPress={() => router.back()}\n      >\n        <Ionicons name=\"chevron-back\" size={24} color=\"#fff\" />\n      </TouchableOpacity>\n\n      {/* Header avec avatar et nom */}\n      <TouchableOpacity \n        onPress={() => router.push({ pathname: '/(tabs)/conversation-management', params: { conversationId } })}\n        activeOpacity={0.8}\n        style={{ position: 'absolute', top: 65, left: 75, right: 20, height: 40, backgroundColor: 'rgba(10, 145, 104, 0.9)', borderRadius: 20, flexDirection: 'row', alignItems: 'center', paddingHorizontal: 12, gap: 10, zIndex: 10, shadowColor: 'rgba(10, 145, 104, 0.4)', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.5, shadowRadius: 8, elevation: 8 }}\n      >\n        <DefaultAvatar name={headerName} size={26} />\n        <Text style={{ fontSize: 15, fontWeight: '600', color: '#fff', flex: 1 }}>{headerName}</Text>\n        <View style={{ width: 6, height: 6, borderRadius: 3, backgroundColor: '#4ade80' }} />\n      </TouchableOpacity>\n      \n      <KeyboardAvoidingView behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"} style={{ flex: 1 }}>\n        <ScrollView ref={scrollViewRef} contentContainerStyle={styles.messagesContainer} showsVerticalScrollIndicator={false}>\n          {messages.map((msg, index) => {\n            const isMe = msg.sender_username === user?.username;\n            const prevMsg = index > 0 ? messages[index - 1] : null;\n            const nextMsg = index < messages.length - 1 ? messages[index + 1] : null;\n            const isSystemMessage = msg.content.startsWith('üéâ') || msg.content.startsWith('üëã') || msg.content.includes('a rejoint') || msg.content.includes('Bienvenue');\n            const currentDate = new Date(msg.created_at).toLocaleDateString('fr-FR');\n            const prevDate = prevMsg ? new Date(prevMsg.created_at).toLocaleDateString('fr-FR') : null;\n            const showDateSeparator = currentDate !== prevDate;\n            let prevNonSystemMsg = prevMsg;\n            let prevNonSystemIndex = index - 1;\n            while (prevNonSystemMsg && (prevNonSystemMsg.content.startsWith('üéâ') || prevNonSystemMsg.content.startsWith('üëã') || prevNonSystemMsg.content.includes('a rejoint') || prevNonSystemMsg.content.includes('Bienvenue'))) {\n              prevNonSystemIndex--; prevNonSystemMsg = prevNonSystemIndex >= 0 ? messages[prevNonSystemIndex] : null;\n            }\n            let nextNonSystemMsg = nextMsg;\n            let nextNonSystemIndex = index + 1;\n            while (nextNonSystemMsg && (nextNonSystemMsg.content.startsWith('üéâ') || nextNonSystemMsg.content.startsWith('üëã') || nextNonSystemMsg.content.includes('a rejoint') || nextNonSystemMsg.content.includes('Bienvenue'))) {\n              nextNonSystemIndex++; nextNonSystemMsg = nextNonSystemIndex < messages.length ? messages[nextNonSystemIndex] : null;\n            }\n            const isSameSenderAsPrev = prevNonSystemMsg && prevNonSystemMsg.sender_username === msg.sender_username;\n            const isSameSenderAsNext = nextNonSystemMsg && nextNonSystemMsg.sender_username === msg.sender_username;\n            const isFirstInGroup = !isSameSenderAsPrev;\n            const isLastInGroup = !isSameSenderAsNext;\n            return (\n              <React.Fragment key={msg.uuid}>\n                {showDateSeparator && (\n                  <View style={styles.dateSeparator}>\n                    <View style={styles.dateLine} />\n                    <Text style={styles.dateText}>{currentDate}</Text>\n                    <View style={styles.dateLine} />\n                  </View>\n                )}\n                {isSystemMessage ? (\n                  <View style={styles.systemMessageContainer}>\n                    <Text style={styles.systemMessageText}>{msg.content}</Text>\n                  </View>\n                ) : (\n                  <View style={styles.messageWrapper}>\n                    {!isMe && isFirstInGroup && (\n                      <Text style={styles.senderName}>{msg.sender_username}</Text>\n                    )}\n                    <View style={[\n                      styles.messageBubble,\n                      isMe ? styles.myMessage : styles.theirMessage,\n                      !isFirstInGroup && styles.messageGrouped,\n                      !isFirstInGroup && !isLastInGroup && (isMe ? styles.myMessageMiddle : styles.theirMessageMiddle),\n                      isFirstInGroup && isSameSenderAsNext && (isMe ? styles.myMessageFirst : styles.theirMessageFirst),\n                      isLastInGroup && isSameSenderAsPrev && (isMe ? styles.myMessageLast : styles.theirMessageLast),\n                    ]}>\n                      {msg.attachments && msg.attachments.length > 0 ? (\n                        <View style={{ gap: 6 }}>\n                          {msg.attachments.map((att) => (\n                            <View key={att.uuid} style={{ borderRadius: 8, overflow: 'hidden' }}>\n                              {att.file_type === 'image' ? (\n                                // Image preview\n                                <View>\n                                  {/* On peut remplacer par expo-image si besoin */}\n                                  <img src={att.thumbnail_url || att.file_url} style={{ width: 220, height: 160, objectFit: 'cover' }} />\n                                </View>\n                              ) : (\n                                // Fichier g√©n√©rique\n                                <Text style={{ color: isMe ? '#fff' : '#111' }}>{att.original_filename || 'Fichier'}</Text>\n                              )}\n                            </View>\n                          ))}\n                          {!!msg.content && (\n                            <Text style={[styles.messageText, isMe ? styles.myMessageText : styles.theirMessageText]}>\n                              {msg.content}\n                            </Text>\n                          )}\n                        </View>\n                      ) : (\n                        <Text style={[styles.messageText, isMe ? styles.myMessageText : styles.theirMessageText]}>\n                          {msg.content}\n                        </Text>\n                      )}\n                      {isLastInGroup && (\n                        <View style={styles.messageMeta}>\n                          <Text style={styles.timestampText}>\n                            {new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}\n                          </Text>\n                          {isMe && (\n                            <Text style={styles.readStatus}>\n                              {msg.is_read ? \"Lu\" : \"Envoy√©\"}\n                            </Text>\n                          )}\n                        </View>\n                      )}\n                    </View>\n                  </View>\n                )}\n              </React.Fragment>\n            );\n          })}\n        </ScrollView>\n      </KeyboardAvoidingView>\n    </Animated.View>\n  );\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/conversation-group.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'getCachedConversationInfo', 'getCachedMessages', and 'groupInfo'. Either include them or remove the dependency array.","line":151,"column":6,"nodeType":"ArrayExpression","endLine":151,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [conversationId, getCachedConversationInfo, getCachedMessages, groupInfo]","fix":{"range":[6164,6180],"text":"[conversationId, getCachedConversationInfo, getCachedMessages, groupInfo]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'setTransitionPosition', 'transitionPosition', and 'zoomAnim'. Either include them or remove the dependency array.","line":159,"column":6,"nodeType":"ArrayExpression","endLine":159,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [setTransitionPosition, transitionPosition, zoomAnim]","fix":{"range":[6426,6428],"text":"[setTransitionPosition, transitionPosition, zoomAnim]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'getCachedGroups'. Either include it or remove the dependency array.","line":173,"column":6,"nodeType":"ArrayExpression","endLine":173,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [conversationId, getCachedGroups]","fix":{"range":[6925,6941],"text":"[conversationId, getCachedGroups]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'sendMessageHandler' and 'setSendMessage'. Either include them or remove the dependency array.","line":178,"column":6,"nodeType":"ArrayExpression","endLine":178,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [localWebsocket, conversationId, setSendMessage, sendMessageHandler]","fix":{"range":[7055,7087],"text":"[localWebsocket, conversationId, setSendMessage, sendMessageHandler]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'connectWebSocket', 'fetchMessages', and 'localWebsocket'. Either include them or remove the dependency array.","line":186,"column":6,"nodeType":"ArrayExpression","endLine":186,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [conversationId, accessToken, fetchMessages, connectWebSocket, localWebsocket]","fix":{"range":[7278,7307],"text":"[conversationId, accessToken, fetchMessages, connectWebSocket, localWebsocket]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import DefaultAvatar from '@/components/DefaultAvatar';\nimport { styles } from '@/styles/appStyles';\nimport { Ionicons } from '@expo/vector-icons';\nimport { router, Stack, useLocalSearchParams } from 'expo-router';\nimport React, { useEffect, useRef, useState } from 'react';\nimport {\n  ActivityIndicator,\n  Animated,\n  Dimensions,\n  KeyboardAvoidingView,\n  Platform,\n  ScrollView,\n  Text,\n  TouchableOpacity,\n  View\n} from 'react-native';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useChat } from '../../contexts/ChatContext';\nimport { useTransition } from '../../contexts/TransitionContext';\n\ninterface Message {\n  id: number;\n  uuid: string;\n  sender_username: string;\n  content: string;\n  created_at: string;\n  is_read?: boolean;\n}\n\ninterface GroupInfo {\n  uuid: string;\n  name: string;\n  avatar?: string;\n}\n\nexport default function ConversationGroup() {\n  const { conversationId } = useLocalSearchParams();\n  const { accessToken, user, logout, makeAuthenticatedRequest } = useAuth();\n  const { transitionPosition, setTransitionPosition } = useTransition();\n  const { setWebsocket, setSendMessage, setCurrentConversationId, getCachedMessages, getCachedConversationInfo, primeCache, getCachedGroups } = useChat();\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [groupInfo, setGroupInfo] = useState<GroupInfo | null>(null);\n\n  const [localWebsocket, setLocalWebsocket] = useState<WebSocket | null>(null);\n  const screenDimensions = Dimensions.get('window');\n  const zoomAnim = useRef(new Animated.Value(0)).current;\n  const scrollViewRef = useRef<ScrollView>(null);\n\n  const API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n    ? \"http://localhost:3001\"\n    : \"https://reseausocial-production.up.railway.app\";\n\n  const connectWebSocket = () => {\n    if (!conversationId || !accessToken) return;\n    try {\n      const ws = new WebSocket(\n        \"wss://reseausocial-production.up.railway.app/ws/chat/\",\n        [\"access_token\", accessToken]\n      );\n      ws.onopen = () => {\n        setLocalWebsocket(ws);\n        setWebsocket(ws);\n        setCurrentConversationId(conversationId as string);\n        ws.send(JSON.stringify({ type: \"mark_as_seen\", conversation_uuid: conversationId }));\n      };\n      ws.onmessage = (event) => {\n        const data = JSON.parse(event.data);\n        if (data.type === \"chat_message\") {\n          const incomingConvUuid = data.conversation_uuid || data.message?.conversation_uuid;\n          if (!incomingConvUuid || incomingConvUuid !== conversationId) {\n            return; // ignorer messages d'autres conversations\n          }\n          const msg = data.message || data;\n          const newMsg: Message = { id: msg.id, uuid: msg.uuid, sender_username: msg.sender_username, content: msg.content, created_at: msg.created_at };\n          setMessages((prev) => {\n            const exists = prev.some((m) => m.uuid === newMsg.uuid);\n            if (exists) return prev.map((m) => (m.uuid === newMsg.uuid ? { ...m, ...newMsg } : m));\n            setTimeout(() => scrollViewRef.current?.scrollToEnd({ animated: true }), 100);\n            return [...prev, newMsg];\n          });\n        }\n      };\n      ws.onerror = (error) => console.error(\"WS error:\", error);\n      ws.onclose = () => {\n        setLocalWebsocket(null);\n        setWebsocket(null);\n        setCurrentConversationId(null);\n      };\n    } catch (error) {\n      console.error(\"WS connect error:\", error);\n    }\n  };\n\n  const sendMessageHandler = (messageText: string) => {\n    if (!messageText.trim() || !localWebsocket) return;\n    localWebsocket.send(JSON.stringify({ type: \"chat_message\", conversation_uuid: conversationId, message: messageText.trim() }));\n    setTimeout(() => scrollViewRef.current?.scrollToEnd({ animated: true }), 100);\n  };\n\n  const fetchMessages = async () => {\n    if (!accessToken) { await logout(); return; }\n    try {\n      // Identifier le groupe associ√© √† cette conversation\n      const groupsResponse = await makeAuthenticatedRequest(`${API_BASE_URL}/groups/my-groups/`);\n      if (groupsResponse.ok) {\n        const groups = await groupsResponse.json();\n        for (const group of groups) {\n          try {\n            const detailsResponse = await makeAuthenticatedRequest(`${API_BASE_URL}/groups/${group.uuid}/`);\n            if (detailsResponse.ok) {\n              const groupData = await detailsResponse.json();\n              if (groupData.conversation_uuid === conversationId) {\n                setGroupInfo({ uuid: groupData.uuid, name: groupData.name, avatar: groupData.avatar });\n                break;\n              }\n            }\n          } catch {}\n        }\n      }\n\n      // Messages\n      const response = await fetch(\n        `${API_BASE_URL}/messaging/conversations/${conversationId}/messages/`,\n        { headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' } }\n      );\n      if (response.status === 401) { await logout(); return; }\n      if (!response.ok) throw new Error(`HTTP ${response.status}`);\n      const data = await response.json();\n      const messagesList = (Array.isArray(data) ? data : (data.results || [])).filter((m: any) => !m.conversation_uuid || m.conversation_uuid === conversationId);\n      const sortedMessages = messagesList.sort((a: Message, b: Message) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());\n      setMessages(sortedMessages);\n      try { primeCache(String(conversationId), (groupInfo), sortedMessages as any); } catch {}\n    } catch (error) {\n      console.error('Erreur messages:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Charger instantan√©ment depuis le cache si disponible\n  useEffect(() => {\n    if (!conversationId) return;\n    const cachedInfo = getCachedConversationInfo(String(conversationId));\n    const cachedMsgs = getCachedMessages(String(conversationId));\n    if (cachedInfo && !groupInfo) setGroupInfo(cachedInfo);\n    if (cachedMsgs && cachedMsgs.length >= 0) {\n      setMessages(cachedMsgs as unknown as Message[]);\n      setLoading(false);\n    }\n  }, [conversationId]);\n\n  useEffect(() => {\n    if (transitionPosition) {\n      Animated.spring(zoomAnim, { toValue: 1, useNativeDriver: true, tension: 50, friction: 10 }).start(() => setTransitionPosition(null));\n    } else {\n      zoomAnim.setValue(1);\n    }\n  }, []);\n\n  // D√©finir rapidement le nom du groupe depuis le cache si possible\n  useEffect(() => {\n    if (!conversationId) return;\n    try {\n      const cachedGroups = getCachedGroups && getCachedGroups();\n      if (cachedGroups && Array.isArray(cachedGroups)) {\n        const found = cachedGroups.find((g: any) => g?.conversation_uuid === conversationId);\n        if (found) {\n          setGroupInfo({ uuid: found.uuid, name: found.name, avatar: found.avatar });\n        }\n      }\n    } catch {}\n  }, [conversationId]);\n\n  useEffect(() => {\n    setSendMessage(() => sendMessageHandler);\n    return () => setSendMessage(null);\n  }, [localWebsocket, conversationId]);\n\n  useEffect(() => {\n    if (conversationId && accessToken) {\n      fetchMessages();\n      connectWebSocket();\n    }\n    return () => { if (localWebsocket) localWebsocket.close(); };\n  }, [conversationId, accessToken]);\n\n  if (loading) {\n    return (\n      <View style={styles.chatContainer}>\n        <Stack.Screen options={{ headerShown: false }} />\n        <View style={{flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n          <ActivityIndicator size=\"large\" color=\"rgba(55, 116, 69, 1)\" />\n          <Text style={{ marginTop: 10, color: '#666' }}>Chargement des messages...</Text>\n        </View>\n      </View>\n    );\n  }\n\n  const animatedStyle = transitionPosition ? {\n    transform: [\n      { translateX: zoomAnim.interpolate({ inputRange: [0, 1], outputRange: [transitionPosition.x + transitionPosition.width / 2 - screenDimensions.width / 2, 0] }) },\n      { translateY: zoomAnim.interpolate({ inputRange: [0, 1], outputRange: [transitionPosition.y + transitionPosition.height / 2 - screenDimensions.height / 2, 0] }) },\n      { scale: zoomAnim.interpolate({ inputRange: [0, 1], outputRange: [transitionPosition.width / screenDimensions.width, 1] }) },\n    ],\n    opacity: zoomAnim,\n  } : {};\n\n  const headerName = groupInfo?.name || 'Groupe';\n\n  return (\n    <Animated.View style={[styles.chatContainer, animatedStyle]}>\n      <TouchableOpacity\n        style={{ position: 'absolute', top: 65, left: 20, zIndex: 20, backgroundColor: 'rgba(10, 145, 104, 0.9)', width: 40, height: 40, borderRadius: 20, justifyContent: 'center', alignItems: 'center', shadowColor: 'rgba(10, 145, 104, 0.4)', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.5, shadowRadius: 8, elevation: 8 }}\n        onPress={() => router.back()}\n      >\n        <Ionicons name=\"chevron-back\" size={24} color=\"#fff\" />\n      </TouchableOpacity>\n\n      <TouchableOpacity \n        onPress={() => router.push({ pathname: '/(tabs)/conversation-management', params: { conversationId } })}\n        activeOpacity={0.8}\n        style={{ position: 'absolute', top: 65, left: 75, right: 20, height: 40, backgroundColor: 'rgba(10, 145, 104, 0.9)', borderRadius: 20, flexDirection: 'row', alignItems: 'center', paddingHorizontal: 12, gap: 10, zIndex: 10, shadowColor: 'rgba(10, 145, 104, 0.4)', shadowOffset: { width: 0, height: 4 }, shadowOpacity: 0.5, shadowRadius: 8, elevation: 8 }}\n      >\n        <DefaultAvatar name={headerName} size={26} />\n        <Text style={{ fontSize: 15, fontWeight: '600', color: '#fff', flex: 1 }}>{headerName}</Text>\n        <View style={{ width: 6, height: 6, borderRadius: 3, backgroundColor: '#4ade80' }} />\n      </TouchableOpacity>\n      \n      <KeyboardAvoidingView behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"} style={{ flex: 1 }}>\n        <ScrollView ref={scrollViewRef} contentContainerStyle={styles.messagesContainer} showsVerticalScrollIndicator={false}>\n          {messages.map((msg, index) => {\n            const isMe = msg.sender_username === user?.username;\n            const prevMsg = index > 0 ? messages[index - 1] : null;\n            const nextMsg = index < messages.length - 1 ? messages[index + 1] : null;\n            const isSystemMessage = msg.content.startsWith('üéâ') || msg.content.startsWith('üëã') || msg.content.includes('a rejoint') || msg.content.includes('Bienvenue');\n            const currentDate = new Date(msg.created_at).toLocaleDateString('fr-FR');\n            const prevDate = prevMsg ? new Date(prevMsg.created_at).toLocaleDateString('fr-FR') : null;\n            const showDateSeparator = currentDate !== prevDate;\n            let prevNonSystemMsg = prevMsg;\n            let prevNonSystemIndex = index - 1;\n            while (prevNonSystemMsg && (prevNonSystemMsg.content.startsWith('üéâ') || prevNonSystemMsg.content.startsWith('üëã') || prevNonSystemMsg.content.includes('a rejoint') || prevNonSystemMsg.content.includes('Bienvenue'))) {\n              prevNonSystemIndex--; prevNonSystemMsg = prevNonSystemIndex >= 0 ? messages[prevNonSystemIndex] : null;\n            }\n            let nextNonSystemMsg = nextMsg;\n            let nextNonSystemIndex = index + 1;\n            while (nextNonSystemMsg && (nextNonSystemMsg.content.startsWith('üéâ') || nextNonSystemMsg.content.startsWith('üëã') || nextNonSystemMsg.content.includes('a rejoint') || nextNonSystemMsg.content.includes('Bienvenue'))) {\n              nextNonSystemIndex++; nextNonSystemMsg = nextNonSystemIndex < messages.length ? messages[nextNonSystemIndex] : null;\n            }\n            const isSameSenderAsPrev = prevNonSystemMsg && prevNonSystemMsg.sender_username === msg.sender_username;\n            const isSameSenderAsNext = nextNonSystemMsg && nextNonSystemMsg.sender_username === msg.sender_username;\n            const isFirstInGroup = !isSameSenderAsPrev;\n            const isLastInGroup = !isSameSenderAsNext;\n            return (\n              <React.Fragment key={msg.uuid}>\n                {showDateSeparator && (\n                  <View style={styles.dateSeparator}>\n                    <View style={styles.dateLine} />\n                    <Text style={styles.dateText}>{currentDate}</Text>\n                    <View style={styles.dateLine} />\n                  </View>\n                )}\n                {isSystemMessage ? (\n                  <View style={styles.systemMessageContainer}>\n                    <Text style={styles.systemMessageText}>{msg.content}</Text>\n                  </View>\n                ) : (\n                  <View style={styles.messageWrapper}>\n                    {!isMe && isFirstInGroup && (\n                      <Text style={styles.senderName}>{msg.sender_username}</Text>\n                    )}\n                    <View style={[\n                      styles.messageBubble,\n                      isMe ? styles.myMessage : styles.theirMessage,\n                      !isFirstInGroup && styles.messageGrouped,\n                      !isFirstInGroup && !isLastInGroup && (isMe ? styles.myMessageMiddle : styles.theirMessageMiddle),\n                      isFirstInGroup && isSameSenderAsNext && (isMe ? styles.myMessageFirst : styles.theirMessageFirst),\n                      isLastInGroup && isSameSenderAsPrev && (isMe ? styles.myMessageLast : styles.theirMessageLast),\n                    ]}>\n                      <Text style={[styles.messageText, isMe ? styles.myMessageText : styles.theirMessageText]}>\n                        {msg.content}\n                      </Text>\n                      {isLastInGroup && (\n                        <View style={styles.messageMeta}>\n                          <Text style={styles.timestampText}>\n                            {new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}\n                          </Text>\n                          {isMe && (\n                            <Text style={styles.readStatus}>\n                              {msg.is_read ? \"Lu\" : \"Envoy√©\"}\n                            </Text>\n                          )}\n                        </View>\n                      )}\n                    </View>\n                  </View>\n                )}\n              </React.Fragment>\n            );\n          })}\n        </ScrollView>\n      </KeyboardAvoidingView>\n    </Animated.View>\n  );\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/conversation-management.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showAddMemberModal' is assigned a value but never used.","line":91,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowAddMemberModal' is assigned a value but never used.","line":91,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":91,"endColumn":51},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadConversationDetails'. Either include it or remove the dependency array.","line":95,"column":6,"nodeType":"ArrayExpression","endLine":95,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [conversationId, loadConversationDetails]","fix":{"range":[2795,2811],"text":"[conversationId, loadConversationDetails]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadGroupDetails' is assigned a value but never used.","line":182,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":182,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":207,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":207,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":239,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":239,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":274,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":274,"endColumn":27},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":855,"column":21,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[31555,31590],"text":"\n              Code d&apos;invitation : "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[31555,31590],"text":"\n              Code d&lsquo;invitation : "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[31555,31590],"text":"\n              Code d&#39;invitation : "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[31555,31590],"text":"\n              Code d&rsquo;invitation : "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import DefaultAvatar from '@/components/DefaultAvatar';\nimport { FloatingHeader } from '@/components/FloatingHeader';\nimport { Ionicons } from '@expo/vector-icons';\nimport { Image } from 'expo-image';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport { router, useLocalSearchParams } from 'expo-router';\nimport { useEffect, useState } from 'react';\nimport {\n  ActivityIndicator,\n  Alert,\n  ScrollView,\n  StyleSheet,\n  Switch,\n  Text,\n  TouchableOpacity,\n  View\n} from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useChat } from '../../contexts/ChatContext';\n\n// Utilise le proxy local pour √©viter CORS en d√©veloppement web\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\ninterface ConversationMember {\n  id?: number;\n  uuid?: string;\n  user_uuid?: string;\n  username?: string;\n  surnom?: string;\n  photo_profil_url?: string;\n  is_ai?: boolean;\n  role?: 'owner' | 'moderator' | 'member';\n  is_muted?: boolean;\n  is_banned?: boolean;\n  user?: number | {\n    id: number;\n    uuid: string;\n    username: string;\n    surnom?: string;\n    photo_profil_url?: string;\n  };\n  joined_at?: string;\n  last_seen?: string;\n}\n\ninterface GroupDetails {\n  uuid: string;\n  name: string;\n  description?: string;\n  avatar?: string;\n  invite_code?: string;\n  member_count: number;\n  members: ConversationMember[];\n  my_membership?: {\n    role: 'owner' | 'moderator' | 'member';\n    is_muted: boolean;\n    is_banned: boolean;\n  };\n  created_at: string;\n}\n\ninterface ConversationDetails {\n  uuid: string;\n  is_group?: boolean;\n  name?: string;\n  description?: string;\n  created_at?: string;\n  members?: ConversationMember[];\n  participants_detail?: ConversationMember[];\n  other_participant?: ConversationMember;\n  media_count?: number;\n  link_count?: number;\n  document_count?: number;\n}\n\nexport default function ConversationManagement() {\n  const { conversationId } = useLocalSearchParams();\n  const { makeAuthenticatedRequest, user } = useAuth();\n  const { prefetchAvatars } = useChat();\n  const insets = useSafeAreaInsets();\n  \n  const [loading, setLoading] = useState(true);\n  const [conversation, setConversation] = useState<ConversationDetails | null>(null);\n  const [groupDetails, setGroupDetails] = useState<GroupDetails | null>(null);\n  const [notificationsEnabled, setNotificationsEnabled] = useState(true);\n  const [soundEnabled, setSoundEnabled] = useState(true);\n  const [ephemeralMessages, setEphemeralMessages] = useState(false);\n  const [showAddMemberModal, setShowAddMemberModal] = useState(false);\n\n  useEffect(() => {\n    loadConversationDetails();\n  }, [conversationId]);\n\n  const loadConversationDetails = async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/messaging/conversations/${conversationId}/`\n      );\n      \n      if (response.ok) {\n        const data = await response.json();\n        setConversation(data);\n        console.log('üìã Conversation charg√©e ID:', conversationId);\n        console.log('üìã Participants count:', data.participants_detail?.length);\n        \n        // Pr√©charger l'avatar principal si pr√©sent\n        try {\n          const avatarUrl = data?.other_participant?.photo_profil_url || data?.avatar;\n          if (avatarUrl) await prefetchAvatars([avatarUrl]);\n        } catch {}\n\n        // D'abord v√©rifier dans la liste des conversations si c'est un groupe\n        const conversationsResponse = await makeAuthenticatedRequest(\n          `${API_BASE_URL}/messaging/conversations/`\n        );\n        \n        let conversationFromList = null;\n        if (conversationsResponse.ok) {\n          const convList = await conversationsResponse.json();\n          conversationFromList = convList.find((c: any) => c.uuid === conversationId);\n          console.log('üìã Conversation from list - other_participant:', conversationFromList?.other_participant);\n        }\n        \n        // Toujours v√©rifier dans les groupes d'abord\n        console.log('üë• Recherche dans les groupes...');\n        const groupsResponse = await makeAuthenticatedRequest(\n          `${API_BASE_URL}/groups/my-groups/`\n        );\n        \n        let isGroupConv = false;\n        if (groupsResponse.ok) {\n          const groups = await groupsResponse.json();\n          console.log('üìã V√©rification si conversation fait partie des groupes...');\n          \n          // Charger les d√©tails de chaque groupe pour obtenir leur conversation_uuid\n          for (const group of groups) {\n            try {\n              const detailsResponse = await makeAuthenticatedRequest(\n                `${API_BASE_URL}/groups/${group.uuid}/`\n              );\n              \n              if (detailsResponse.ok) {\n                const groupData = await detailsResponse.json();\n                console.log('üîç V√©rif groupe:', groupData.name, 'conv_uuid:', groupData.conversation_uuid);\n                \n                // V√©rifier si c'est le bon groupe\n                if (groupData.conversation_uuid === conversationId) {\n                  console.log('‚úÖ C\\'est un groupe:', groupData.name);\n                  isGroupConv = true;\n                  setGroupDetails(groupData);\n                  console.log('‚úÖ D√©tails groupe charg√©s:', {\n                    name: groupData.name,\n                    memberCount: groupData.member_count,\n                    myRole: groupData.my_membership?.role,\n                    membersLength: groupData.members?.length,\n                    membersPreview: groupData.members?.slice(0, 2)\n                  });\n                  break;\n                }\n              }\n            } catch (error) {\n              console.error('‚ùå Erreur v√©rification groupe:', group.uuid, error);\n            }\n          }\n        }\n        \n        if (!isGroupConv) {\n          console.log('‚úÖ C\\'est une conversation priv√©e (pas de groupe trouv√©)');\n        }\n      }\n    } catch (error) {\n      console.error('Erreur chargement d√©tails:', error);\n      Alert.alert('Erreur', 'Impossible de charger les d√©tails');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadGroupDetails = async (conversationData: ConversationDetails) => {\n    // Cette fonction est maintenant appel√©e depuis loadConversationDetails\n    // avec le groupData d√©j√† trouv√©, donc on peut la simplifier\n    // Mais gardons-la pour compatibilit√©\n    console.log('üîé loadGroupDetails appel√©');\n  };\n\n  const handleDeleteConversation = () => {\n    Alert.alert(\n      'Supprimer la conversation',\n      '√ätes-vous s√ªr de vouloir supprimer cette conversation ? Cette action est irr√©versible.',\n      [\n        { text: 'Annuler', style: 'cancel' },\n        {\n          text: 'Supprimer',\n          style: 'destructive',\n          onPress: async () => {\n            try {\n              const response = await makeAuthenticatedRequest(\n                `${API_BASE_URL}/messaging/conversations/${conversationId}/`,\n                { method: 'DELETE' }\n              );\n              if (response.ok) {\n                router.back();\n              }\n            } catch (error) {\n              Alert.alert('Erreur', 'Impossible de supprimer');\n            }\n          }\n        }\n      ]\n    );\n  };\n\n  const handleLeaveGroup = () => {\n    if (!groupDetails) return;\n    \n    Alert.alert(\n      'Quitter le groupe',\n      'Voulez-vous quitter ce groupe ?',\n      [\n        { text: 'Annuler', style: 'cancel' },\n        {\n          text: 'Quitter',\n          style: 'destructive',\n          onPress: async () => {\n            try {\n              const response = await makeAuthenticatedRequest(\n                `${API_BASE_URL}/groups/${groupDetails.uuid}/leave/`,\n                { method: 'POST' }\n              );\n              if (response.ok) {\n                router.back();\n                router.back(); // Retour √† la liste des conversations\n              } else {\n                Alert.alert('Erreur', 'Impossible de quitter le groupe');\n              }\n            } catch (error) {\n              Alert.alert('Erreur', 'Impossible de quitter le groupe');\n            }\n          }\n        }\n      ]\n    );\n  };\n\n  const handleRemoveMember = (member: ConversationMember) => {\n    if (!groupDetails) return;\n    \n    Alert.alert(\n      'Retirer du groupe',\n      `Voulez-vous retirer ${member.surnom || member.username} du groupe ?`,\n      [\n        { text: 'Annuler', style: 'cancel' },\n        {\n          text: 'Retirer',\n          style: 'destructive',\n          onPress: async () => {\n            try {\n              const memberUuid = member.user_uuid || member.uuid;\n              const response = await makeAuthenticatedRequest(\n                `${API_BASE_URL}/groups/${groupDetails.uuid}/members/${memberUuid}/`,\n                { method: 'DELETE' }\n              );\n              \n              if (response.ok) {\n                // Recharger les d√©tails du groupe\n                await loadConversationDetails();\n                Alert.alert('Succ√®s', 'Membre retir√© du groupe');\n              } else {\n                Alert.alert('Erreur', 'Impossible de retirer ce membre');\n              }\n            } catch (error) {\n              Alert.alert('Erreur', 'Impossible de retirer ce membre');\n            }\n          }\n        }\n      ]\n    );\n  };\n\n  const handleInviteMember = () => {\n    if (!groupDetails) return;\n    \n    console.log('‚ûï Ouverture page ajout membres pour:', groupDetails.name);\n    router.push({\n      pathname: '/(tabs)/add-group-members',\n      params: {\n        groupUuid: groupDetails.uuid,\n        groupName: groupDetails.name\n      }\n    });\n  };\n\n  if (loading) {\n    return (\n      <View style={styles.container}>\n        <ActivityIndicator size=\"large\" color=\"rgba(10, 145, 104, 1)\" />\n      </View>\n    );\n  }\n\n  // D√©tecter si c'est un groupe : se baser sur groupDetails ou is_group\n  const isGroup = !!groupDetails || conversation?.is_group === true;\n  \n  console.log('üéØ D√©tection groupe:', {\n    hasGroupDetails: !!groupDetails,\n    groupDetailsValue: groupDetails ? {\n      name: groupDetails.name,\n      uuid: groupDetails.uuid,\n      membersCount: groupDetails.members?.length\n    } : null,\n    isGroup\n  });\n  \n  // Normaliser les membres : parfois user est un objet, parfois juste un ID\n  const rawMembers = groupDetails?.members || [];\n  console.log('üîÑ Normalisation membres:', {\n    rawMembersCount: rawMembers.length,\n    firstMember: rawMembers[0]\n  });\n  \n  const members = rawMembers.map(member => {\n    // Si user est un objet, extraire les infos\n    if (member.user && typeof member.user === 'object') {\n      const normalized = {\n        ...member,\n        user_uuid: member.user.uuid,\n        username: member.user.username || member.username,\n        surnom: member.user.surnom || member.surnom,\n        photo_profil_url: member.user.photo_profil_url || member.photo_profil_url,\n      };\n      return normalized;\n    }\n    return member;\n  });\n  \n  console.log('‚úÖ Membres normalis√©s:', {\n    count: members.length,\n    preview: members.slice(0, 2).map(m => ({\n      username: m.username,\n      surnom: m.surnom,\n      role: m.role\n    }))\n  });\n  \n  // Pour les conversations priv√©es, trouver l'autre participant\n  const contact = conversation?.participants_detail?.find(\n    p => p.user_uuid !== user?.uuid\n  );\n  \n  const isAdmin = groupDetails?.my_membership?.role === 'owner' || groupDetails?.my_membership?.role === 'moderator';\n  const currentUserRole = groupDetails?.my_membership?.role;\n  \n  const participantsCount = conversation?.participants_detail?.length || 0;\n  \n  console.log('üìä √âtat affichage:', {\n    isGroup,\n    participantsCount,\n    hasContact: !!contact,\n    contact: contact ? {\n      username: contact.username,\n      surnom: contact.surnom,\n      user_uuid: contact.user_uuid\n    } : null,\n    hasGroupDetails: !!groupDetails,\n    groupDetailsName: groupDetails?.name,\n    memberCount: members.length,\n    membersPreview: members.slice(0, 2).map(m => ({\n      username: m.username,\n      user_uuid: m.user_uuid,\n      role: m.role\n    })),\n    isAdmin,\n    currentUserRole,\n    currentUserUuid: user?.uuid\n  });\n\n  // Composant pour une ligne de param√®tre\n  const SettingRow = ({ \n    icon, \n    title, \n    subtitle, \n    onPress, \n    showArrow = true, \n    rightElement,\n    danger = false,\n    first = false,\n    last = false,\n  }: {\n    icon: string;\n    title: string;\n    subtitle?: string;\n    onPress?: () => void;\n    showArrow?: boolean;\n    rightElement?: React.ReactNode;\n    danger?: boolean;\n    first?: boolean;\n    last?: boolean;\n  }) => (\n    <TouchableOpacity\n      style={[\n        styles.settingRow,\n        first && styles.settingRowFirst,\n        last && styles.settingRowLast,\n      ]}\n      onPress={onPress}\n      disabled={!onPress && !rightElement}\n      activeOpacity={0.7}\n    >\n      <View style={[styles.iconContainer, danger && styles.iconDanger]}>\n        <Ionicons name={icon as any} size={22} color={danger ? '#ff6b6b' : 'rgba(10, 145, 104, 1)'} />\n      </View>\n      <View style={styles.settingContent}>\n        <Text style={[styles.settingTitle, danger && styles.settingTitleDanger]}>{title}</Text>\n        {subtitle && <Text style={styles.settingSubtitle}>{subtitle}</Text>}\n      </View>\n      {rightElement || (showArrow && (\n        <Ionicons name=\"chevron-forward\" size={20} color=\"#ccc\" />\n      ))}\n    </TouchableOpacity>\n  );\n\n  return (\n    <View style={[styles.container, { paddingTop: insets.top }]}>\n      {/* Header unifi√© */}\n      <FloatingHeader \n        title={isGroup ? 'Param√®tres du groupe' : 'Infos du contact'}\n        icon=\"settings-outline\"\n      />\n\n      <ScrollView style={styles.content} showsVerticalScrollIndicator={false}>\n        {/* Section Photo/Avatar */}\n        <View style={styles.profileSection}>\n          <LinearGradient\n            colors={['rgba(10, 145, 104, 0.03)', 'rgba(10, 145, 104, 0.01)']}\n            style={styles.profileGradient}\n          >\n            <View style={styles.avatarWrapper}>\n              {isGroup ? (\n                <View style={styles.groupAvatarContainer}>\n                  <LinearGradient\n                    colors={['rgba(10, 145, 104, 0.9)', 'rgba(10, 145, 104, 0.7)']}\n                    style={styles.largeAvatar}\n                  >\n                    <Ionicons name=\"people\" size={50} color=\"#fff\" />\n                  </LinearGradient>\n                </View>\n              ) : (!isGroup && contact) ? (\n                contact.photo_profil_url ? (\n                  <Image\n                    source={{ uri: contact.photo_profil_url }}\n                    style={styles.largeAvatar}\n                    contentFit=\"cover\"\n                  />\n                ) : (\n                  <DefaultAvatar \n                    name={contact.surnom || contact.username || 'Contact'} \n                    size={120} \n                  />\n                )\n              ) : (\n                <DefaultAvatar \n                  name=\"Contact\" \n                  size={120} \n                />\n              )}\n            </View>\n            <Text style={styles.profileName}>\n              {isGroup \n                ? groupDetails?.name || conversation?.name || 'Groupe' \n                : contact?.surnom || contact?.username || 'Contact'\n              }\n            </Text>\n            {contact?.is_ai && !isGroup && (\n              <View style={styles.aiBadgeLarge}>\n                <Ionicons name=\"flash\" size={16} color=\"#fff\" />\n                <Text style={styles.aiBadgeTextLarge}>Agent IA</Text>\n              </View>\n            )}\n            {isGroup && (groupDetails?.description || conversation?.description) && (\n              <Text style={styles.groupDesc}>\n                {groupDetails?.description || conversation?.description}\n              </Text>\n            )}\n            {!isGroup && contact?.username && (\n              <Text style={styles.username}>@{contact.username}</Text>\n            )}\n          </LinearGradient>\n        </View>\n\n        {/* Section Actions rapides - seulement pour conversations priv√©es */}\n        {!isGroup && (\n          <View style={styles.quickActionsContainer}>\n            <View style={styles.quickActions}>\n              <TouchableOpacity style={styles.quickAction}>\n                <LinearGradient\n                  colors={['rgba(10, 145, 104, 0.15)', 'rgba(10, 145, 104, 0.08)']}\n                  style={styles.quickActionGradient}\n                >\n                  <Ionicons name=\"search-outline\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  <Text style={styles.quickActionText}>Rechercher</Text>\n                </LinearGradient>\n              </TouchableOpacity>\n              \n              <TouchableOpacity style={styles.quickAction}>\n                <LinearGradient\n                  colors={['rgba(10, 145, 104, 0.15)', 'rgba(10, 145, 104, 0.08)']}\n                  style={styles.quickActionGradient}\n                >\n                  <Ionicons name=\"call-outline\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  <Text style={styles.quickActionText}>Appeler</Text>\n                </LinearGradient>\n              </TouchableOpacity>\n\n              <TouchableOpacity style={styles.quickAction}>\n                <LinearGradient\n                  colors={['rgba(10, 145, 104, 0.15)', 'rgba(10, 145, 104, 0.08)']}\n                  style={styles.quickActionGradient}\n                >\n                  <Ionicons name=\"videocam-outline\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  <Text style={styles.quickActionText}>Vid√©o</Text>\n                </LinearGradient>\n              </TouchableOpacity>\n            </View>\n          </View>\n        )}\n\n        {/* Section Membres (si groupe) */}\n        {isGroup && (\n          <View style={styles.floatingCard}>\n            <View style={styles.sectionHeaderRow}>\n              <Text style={styles.sectionTitle}>\n                <Ionicons name=\"people\" size={16} color=\"rgba(10, 145, 104, 1)\" /> {groupDetails?.member_count || members.length} membre{((groupDetails?.member_count || members.length) > 1) ? 's' : ''}\n              </Text>\n              {isAdmin && (\n                <TouchableOpacity style={styles.addButton} onPress={handleInviteMember}>\n                  <LinearGradient\n                    colors={['rgba(10, 145, 104, 0.2)', 'rgba(10, 145, 104, 0.1)']}\n                    style={styles.addButtonGradient}\n                  >\n                    <Ionicons name=\"person-add\" size={18} color=\"rgba(10, 145, 104, 1)\" />\n                  </LinearGradient>\n                </TouchableOpacity>\n              )}\n            </View>\n            \n            <View style={styles.membersList}>\n              {members.length === 0 && (\n                <View style={{ padding: 20, alignItems: 'center' }}>\n                  <Text style={{ color: '#888', fontSize: 14 }}>\n                    {groupDetails ? 'Aucun membre' : 'Chargement des membres...'}\n                  </Text>\n                </View>\n              )}\n              {members.map((member, index) => {\n                const memberRole = member.role;\n                const isOwner = memberRole === 'owner';\n                const isModerator = memberRole === 'moderator';\n                const canRemove = isAdmin && !isOwner && member.user_uuid !== user?.uuid;\n                const memberName = member.surnom || member.username || 'Membre';\n                const memberUsername = member.username || 'inconnu';\n                \n                return (\n                  <View \n                    key={member.user_uuid || member.uuid || member.id} \n                    style={[\n                      styles.memberRow,\n                      index === members.length - 1 && styles.memberRowLast\n                    ]}\n                  >\n                    <DefaultAvatar name={memberName} size={44} />\n                    <View style={styles.memberInfo}>\n                      <View style={{ flexDirection: 'row', alignItems: 'center', gap: 8 }}>\n                        <Text style={styles.memberName}>{memberName}</Text>\n                        {isOwner && (\n                          <View style={styles.roleBadge}>\n                            <Ionicons name=\"star\" size={12} color=\"#FFD700\" />\n                            <Text style={styles.roleBadgeText}>Propri√©taire</Text>\n                          </View>\n                        )}\n                        {isModerator && (\n                          <View style={[styles.roleBadge, { backgroundColor: 'rgba(10, 145, 104, 0.15)' }]}>\n                            <Ionicons name=\"shield\" size={12} color=\"rgba(10, 145, 104, 1)\" />\n                            <Text style={[styles.roleBadgeText, { color: 'rgba(10, 145, 104, 1)' }]}>Mod√©rateur</Text>\n                          </View>\n                        )}\n                        {member.is_ai && (\n                          <View style={styles.aiBadgeSmall}>\n                            <Ionicons name=\"flash\" size={10} color=\"#fff\" />\n                            <Text style={styles.aiBadgeTextSmall}>IA</Text>\n                          </View>\n                        )}\n                      </View>\n                      <Text style={styles.memberUsername}>@{memberUsername}</Text>\n                    </View>\n                    {canRemove && (\n                      <TouchableOpacity \n                        style={styles.removeMemberButton}\n                        onPress={() => handleRemoveMember(member)}\n                      >\n                        <Ionicons name=\"remove-circle\" size={24} color=\"#ff6b6b\" />\n                      </TouchableOpacity>\n                    )}\n                  </View>\n                );\n              })}\n            </View>\n          </View>\n        )}\n        \n        {/* Actions pour groupes */}\n        {isGroup && (\n          <View style={styles.quickActionsContainer}>\n            <View style={styles.quickActions}>\n              <TouchableOpacity style={styles.quickAction}>\n                <LinearGradient\n                  colors={['rgba(10, 145, 104, 0.15)', 'rgba(10, 145, 104, 0.08)']}\n                  style={styles.quickActionGradient}\n                >\n                  <Ionicons name=\"search-outline\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  <Text style={styles.quickActionText}>Rechercher</Text>\n                </LinearGradient>\n              </TouchableOpacity>\n              \n              <TouchableOpacity style={styles.quickAction}>\n                <LinearGradient\n                  colors={['rgba(10, 145, 104, 0.15)', 'rgba(10, 145, 104, 0.08)']}\n                  style={styles.quickActionGradient}\n                >\n                  <Ionicons name=\"create-outline\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  <Text style={styles.quickActionText}>Modifier</Text>\n                </LinearGradient>\n              </TouchableOpacity>\n\n              <TouchableOpacity style={styles.quickAction}>\n                <LinearGradient\n                  colors={['rgba(10, 145, 104, 0.15)', 'rgba(10, 145, 104, 0.08)']}\n                  style={styles.quickActionGradient}\n                >\n                  <Ionicons name=\"image-outline\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  <Text style={styles.quickActionText}>Photo</Text>\n                </LinearGradient>\n              </TouchableOpacity>\n            </View>\n          </View>\n        )}\n\n        {/* Section M√©dias, liens et documents */}\n        <View style={styles.floatingCard}>\n          <Text style={styles.sectionTitle}>\n            <Ionicons name=\"folder-outline\" size={16} color=\"rgba(10, 145, 104, 1)\" /> M√©dias, liens et documents\n          </Text>\n          \n          <View style={styles.mediaGrid}>\n            <TouchableOpacity style={styles.mediaItem}>\n              <LinearGradient\n                colors={['rgba(10, 145, 104, 0.12)', 'rgba(10, 145, 104, 0.06)']}\n                style={styles.mediaItemGradient}\n              >\n                <Ionicons name=\"image-outline\" size={32} color=\"rgba(10, 145, 104, 1)\" />\n                <Text style={styles.mediaCount}>{conversation?.media_count || 0}</Text>\n                <Text style={styles.mediaLabel}>M√©dias</Text>\n              </LinearGradient>\n            </TouchableOpacity>\n            <TouchableOpacity style={styles.mediaItem}>\n              <LinearGradient\n                colors={['rgba(10, 145, 104, 0.12)', 'rgba(10, 145, 104, 0.06)']}\n                style={styles.mediaItemGradient}\n              >\n                <Ionicons name=\"link-outline\" size={32} color=\"rgba(10, 145, 104, 1)\" />\n                <Text style={styles.mediaCount}>{conversation?.link_count || 0}</Text>\n                <Text style={styles.mediaLabel}>Liens</Text>\n              </LinearGradient>\n            </TouchableOpacity>\n            <TouchableOpacity style={styles.mediaItem}>\n              <LinearGradient\n                colors={['rgba(10, 145, 104, 0.12)', 'rgba(10, 145, 104, 0.06)']}\n                style={styles.mediaItemGradient}\n              >\n                <Ionicons name=\"document-outline\" size={32} color=\"rgba(10, 145, 104, 1)\" />\n                <Text style={styles.mediaCount}>{conversation?.document_count || 0}</Text>\n                <Text style={styles.mediaLabel}>Fichiers</Text>\n              </LinearGradient>\n            </TouchableOpacity>\n          </View>\n        </View>\n\n        {/* Section Param√®tres */}\n        <View style={styles.floatingCard}>\n          <Text style={styles.sectionTitle}>\n            <Ionicons name=\"settings-outline\" size={16} color=\"rgba(10, 145, 104, 1)\" /> Param√®tres\n          </Text>\n          \n          <View style={styles.settingsGroup}>\n            <SettingRow\n              icon=\"notifications-outline\"\n              title=\"Notifications\"\n              subtitle={notificationsEnabled ? \"Activ√©es\" : \"D√©sactiv√©es\"}\n              rightElement={\n                <Switch\n                  value={notificationsEnabled}\n                  onValueChange={setNotificationsEnabled}\n                  trackColor={{ false: '#ccc', true: 'rgba(10, 145, 104, 0.3)' }}\n                  thumbColor={notificationsEnabled ? 'rgba(10, 145, 104, 1)' : '#f4f3f4'}\n                />\n              }\n              showArrow={false}\n              first\n            />\n            \n            <SettingRow\n              icon=\"volume-high-outline\"\n              title=\"Son des notifications\"\n              subtitle={soundEnabled ? \"Activ√©\" : \"D√©sactiv√©\"}\n              rightElement={\n                <Switch\n                  value={soundEnabled}\n                  onValueChange={setSoundEnabled}\n                  trackColor={{ false: '#ccc', true: 'rgba(10, 145, 104, 0.3)' }}\n                  thumbColor={soundEnabled ? 'rgba(10, 145, 104, 1)' : '#f4f3f4'}\n                />\n              }\n              showArrow={false}\n            />\n            \n            <SettingRow\n              icon=\"time-outline\"\n              title=\"Messages √©ph√©m√®res\"\n              subtitle={ephemeralMessages ? \"Activ√©s - 24h\" : \"D√©sactiv√©s\"}\n              rightElement={\n                <Switch\n                  value={ephemeralMessages}\n                  onValueChange={setEphemeralMessages}\n                  trackColor={{ false: '#ccc', true: 'rgba(10, 145, 104, 0.3)' }}\n                  thumbColor={ephemeralMessages ? 'rgba(10, 145, 104, 1)' : '#f4f3f4'}\n                />\n              }\n              showArrow={false}\n              last\n            />\n          </View>\n        </View>\n\n        {/* Section Personnalisation */}\n        <View style={styles.floatingCard}>\n          <Text style={styles.sectionTitle}>\n            <Ionicons name=\"brush-outline\" size={16} color=\"rgba(10, 145, 104, 1)\" /> Personnalisation\n          </Text>\n          \n          <View style={styles.settingsGroup}>\n            <SettingRow\n              icon=\"color-palette-outline\"\n              title=\"Fond d'√©cran\"\n              subtitle=\"Personnaliser l'arri√®re-plan\"\n              onPress={() => Alert.alert('Fond d\\'√©cran', 'Fonctionnalit√© √† venir')}\n              first\n            />\n            \n            <SettingRow\n              icon=\"star-outline\"\n              title=\"Messages importants\"\n              subtitle=\"0 messages marqu√©s\"\n              onPress={() => Alert.alert('Messages importants', 'Aucun message marqu√©')}\n              last\n            />\n          </View>\n        </View>\n\n        {/* Section Actions */}\n        <View style={styles.floatingCard}>\n          <Text style={styles.sectionTitle}>\n            <Ionicons name=\"shield-checkmark-outline\" size={16} color=\"rgba(10, 145, 104, 1)\" /> S√©curit√© & Actions\n          </Text>\n          \n          <View style={styles.settingsGroup}>\n            <SettingRow\n              icon=\"lock-closed-outline\"\n              title=\"Cryptage\"\n              subtitle=\"Conversation crypt√©e de bout en bout\"\n              showArrow={false}\n              first\n            />\n            \n            <SettingRow\n              icon=\"archive-outline\"\n              title=\"Archiver la conversation\"\n              onPress={() => Alert.alert('Archiver', 'Conversation archiv√©e')}\n            />\n            \n            <SettingRow\n              icon=\"share-outline\"\n              title=\"Exporter la conversation\"\n              onPress={() => Alert.alert('Exporter', 'Export en cours...')}\n              last\n            />\n          </View>\n        </View>\n\n        {/* Section Danger Zone */}\n        <View style={styles.floatingCard}>\n          <View style={styles.settingsGroup}>\n            {!isGroup && (\n              <SettingRow\n                icon=\"ban-outline\"\n                title=\"Bloquer le contact\"\n                onPress={() => Alert.alert('Bloquer', 'Contact bloqu√©')}\n                danger\n                first={!isGroup}\n              />\n            )}\n            \n            <SettingRow\n              icon=\"trash-outline\"\n              title=\"Supprimer la conversation\"\n              subtitle=\"Supprimer tout l'historique\"\n              onPress={handleDeleteConversation}\n              danger\n            />\n            \n            {isGroup && (\n              <SettingRow\n                icon=\"exit-outline\"\n                title=\"Quitter le groupe\"\n                onPress={handleLeaveGroup}\n                danger\n                last\n              />\n            )}\n            \n            {!isGroup && (\n              <SettingRow\n                icon=\"flag-outline\"\n                title=\"Signaler\"\n                subtitle=\"Signaler ce contact\"\n                onPress={() => Alert.alert('Signaler', 'Contact signal√© aux mod√©rateurs')}\n                danger\n                last\n              />\n            )}\n          </View>\n        </View>\n\n        {/* Informations suppl√©mentaires */}\n        <View style={styles.infoSection}>\n          <Text style={styles.infoText}>\n            {isGroup \n              ? `Groupe cr√©√© le ${groupDetails?.created_at ? new Date(groupDetails.created_at).toLocaleDateString('fr-FR') : (conversation?.created_at ? new Date(conversation.created_at).toLocaleDateString('fr-FR') : 'N/A')}`\n              : 'Les messages et appels sont crypt√©s de bout en bout.'\n            }\n          </Text>\n          {isGroup && groupDetails?.invite_code && (\n            <Text style={[styles.infoText, { marginTop: 8, fontWeight: '600' }]}>\n              Code d'invitation : {groupDetails.invite_code}\n            </Text>\n          )}\n        </View>\n\n        <View style={{ height: 100 }} />\n      </ScrollView>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#f0f2f5',\n  },\n  content: {\n    flex: 1,\n    paddingTop: 105,\n  },\n  \n  // Section Profil\n  profileSection: {\n    marginBottom: 16,\n    marginHorizontal: 16,\n    borderRadius: 20,\n    overflow: 'hidden',\n    shadowColor: 'rgba(10, 145, 104, 0.2)',\n    shadowOffset: { width: 0, height: 4 },\n    shadowOpacity: 0.3,\n    shadowRadius: 10,\n    elevation: 5,\n    backgroundColor: '#fff',\n  },\n  profileGradient: {\n    alignItems: 'center',\n    paddingVertical: 30,\n    paddingHorizontal: 20,\n  },\n  avatarWrapper: {\n    marginBottom: 15,\n    shadowColor: 'rgba(10, 145, 104, 0.4)',\n    shadowOffset: { width: 0, height: 6 },\n    shadowOpacity: 0.4,\n    shadowRadius: 15,\n    elevation: 8,\n  },\n  groupAvatarContainer: {\n    borderRadius: 60,\n  },\n  largeAvatar: {\n    width: 120,\n    height: 120,\n    borderRadius: 60,\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  profileName: {\n    fontSize: 28,\n    fontWeight: 'bold',\n    color: '#1a1a1a',\n    marginBottom: 4,\n  },\n  username: {\n    fontSize: 15,\n    color: '#666',\n    marginTop: 4,\n  },\n  aiBadgeLarge: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 6,\n    backgroundColor: 'rgba(10, 145, 104, 1)',\n    paddingHorizontal: 16,\n    paddingVertical: 7,\n    borderRadius: 20,\n    marginTop: 8,\n    shadowColor: 'rgba(10, 145, 104, 0.4)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.4,\n    shadowRadius: 6,\n    elevation: 4,\n  },\n  aiBadgeTextLarge: {\n    color: '#fff',\n    fontSize: 14,\n    fontWeight: '700',\n  },\n  groupDesc: {\n    fontSize: 15,\n    color: '#666',\n    textAlign: 'center',\n    marginTop: 12,\n    paddingHorizontal: 20,\n    lineHeight: 22,\n  },\n\n  // Actions rapides - Container flottant\n  quickActionsContainer: {\n    marginHorizontal: 16,\n    marginBottom: 16,\n    borderRadius: 20,\n    overflow: 'hidden',\n    shadowColor: 'rgba(10, 145, 104, 0.2)',\n    shadowOffset: { width: 0, height: 4 },\n    shadowOpacity: 0.3,\n    shadowRadius: 10,\n    elevation: 5,\n    backgroundColor: '#fff',\n  },\n  quickActions: {\n    flexDirection: 'row',\n    justifyContent: 'space-around',\n    paddingVertical: 18,\n    paddingHorizontal: 12,\n  },\n  quickAction: {\n    flex: 1,\n    marginHorizontal: 6,\n  },\n  quickActionGradient: {\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 18,\n    borderRadius: 18,\n    shadowColor: 'rgba(10, 145, 104, 0.15)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.3,\n    shadowRadius: 6,\n    elevation: 3,\n  },\n  quickActionText: {\n    marginTop: 10,\n    fontSize: 13,\n    color: 'rgba(10, 145, 104, 1)',\n    fontWeight: '700',\n  },\n\n  // Cards flottantes\n  floatingCard: {\n    backgroundColor: '#fff',\n    marginHorizontal: 16,\n    marginBottom: 16,\n    paddingHorizontal: 20,\n    paddingVertical: 18,\n    borderRadius: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.2)',\n    shadowOffset: { width: 0, height: 4 },\n    shadowOpacity: 0.3,\n    shadowRadius: 10,\n    elevation: 5,\n  },\n  sectionTitle: {\n    fontSize: 13,\n    fontWeight: '700',\n    color: '#555',\n    textTransform: 'uppercase',\n    marginBottom: 16,\n    letterSpacing: 0.8,\n  },\n  sectionHeaderRow: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    marginBottom: 16,\n  },\n  addButton: {\n    borderRadius: 18,\n    overflow: 'hidden',\n    shadowColor: 'rgba(10, 145, 104, 0.2)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.3,\n    shadowRadius: 4,\n    elevation: 3,\n  },\n  addButtonGradient: {\n    width: 36,\n    height: 36,\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n\n  // Membres\n  membersList: {\n    marginTop: 8,\n  },\n  memberRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingVertical: 14,\n    borderBottomWidth: 1,\n    borderBottomColor: '#f5f5f5',\n  },\n  memberRowLast: {\n    borderBottomWidth: 0,\n  },\n  memberInfo: {\n    flex: 1,\n    marginLeft: 14,\n  },\n  memberName: {\n    fontSize: 16,\n    color: '#1a1a1a',\n    fontWeight: '600',\n  },\n  memberUsername: {\n    fontSize: 13,\n    color: '#888',\n    marginTop: 2,\n  },\n  roleBadge: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 4,\n    backgroundColor: 'rgba(255, 215, 0, 0.15)',\n    paddingHorizontal: 8,\n    paddingVertical: 4,\n    borderRadius: 12,\n  },\n  roleBadgeText: {\n    fontSize: 11,\n    fontWeight: '700',\n    color: '#B8860B',\n  },\n  removeMemberButton: {\n    padding: 8,\n    marginLeft: 8,\n  },\n  aiBadgeSmall: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 3,\n    backgroundColor: 'rgba(10, 145, 104, 1)',\n    paddingHorizontal: 7,\n    paddingVertical: 3,\n    borderRadius: 10,\n  },\n  aiBadgeTextSmall: {\n    color: '#fff',\n    fontSize: 10,\n    fontWeight: '700',\n  },\n  viewAllButton: {\n    marginTop: 12,\n    borderRadius: 14,\n    overflow: 'hidden',\n  },\n  viewAllGradient: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    gap: 6,\n    paddingVertical: 14,\n  },\n  viewAllText: {\n    color: 'rgba(10, 145, 104, 1)',\n    fontSize: 15,\n    fontWeight: '700',\n  },\n\n  // M√©dias\n  mediaGrid: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    gap: 10,\n    marginTop: 8,\n  },\n  mediaItem: {\n    flex: 1,\n  },\n  mediaItemGradient: {\n    alignItems: 'center',\n    paddingVertical: 20,\n    paddingHorizontal: 12,\n    borderRadius: 16,\n  },\n  mediaCount: {\n    fontSize: 22,\n    fontWeight: 'bold',\n    color: '#1a1a1a',\n    marginTop: 10,\n  },\n  mediaLabel: {\n    fontSize: 12,\n    color: '#666',\n    marginTop: 6,\n    fontWeight: '600',\n  },\n\n  // Param√®tres\n  settingsGroup: {\n    borderRadius: 16,\n    overflow: 'hidden',\n    backgroundColor: '#fafafa',\n    marginTop: 8,\n  },\n  settingRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingVertical: 16,\n    paddingHorizontal: 16,\n    backgroundColor: '#fff',\n    borderBottomWidth: 1,\n    borderBottomColor: '#f5f5f5',\n  },\n  settingRowFirst: {\n    borderTopLeftRadius: 16,\n    borderTopRightRadius: 16,\n  },\n  settingRowLast: {\n    borderBottomLeftRadius: 16,\n    borderBottomRightRadius: 16,\n    borderBottomWidth: 0,\n  },\n  iconContainer: {\n    width: 42,\n    height: 42,\n    borderRadius: 21,\n    backgroundColor: 'rgba(10, 145, 104, 0.12)',\n    alignItems: 'center',\n    justifyContent: 'center',\n    marginRight: 14,\n  },\n  iconDanger: {\n    backgroundColor: 'rgba(255, 107, 107, 0.12)',\n  },\n  settingContent: {\n    flex: 1,\n  },\n  settingTitle: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: '#1a1a1a',\n  },\n  settingTitleDanger: {\n    color: '#ff6b6b',\n  },\n  settingSubtitle: {\n    fontSize: 13,\n    color: '#888',\n    marginTop: 3,\n  },\n\n  // Info Section\n  infoSection: {\n    paddingVertical: 24,\n    paddingHorizontal: 20,\n    alignItems: 'center',\n    marginHorizontal: 16,\n  },\n  infoText: {\n    fontSize: 13,\n    color: '#999',\n    textAlign: 'center',\n    lineHeight: 20,\n  },\n});","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/conversations.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'GroupMember' is defined but never used.","line":84,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":84,"endColumn":22},{"ruleId":"react/display-name","severity":2,"message":"Component definition is missing display name","line":198,"column":21,"nodeType":"CallExpression","messageId":"noDisplayName","endLine":247,"endColumn":3},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":254,"column":37,"nodeType":null,"messageId":"unusedVar","endLine":254,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'prefetchConversationsOverview' is assigned a value but never used.","line":270,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":270,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'groupInvitations' is assigned a value but never used.","line":282,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":282,"endColumn":26},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchConnections', 'fetchConversations', 'getCachedConnections', 'getCachedConversations', 'getCachedGroupInvitations', 'getCachedGroups', and 'prefetchAvatars'. Either include them or remove the dependency array.","line":618,"column":6,"nodeType":"ArrayExpression","endLine":618,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchConnections, fetchConversations, getCachedConnections, getCachedConversations, getCachedGroupInvitations, getCachedGroups, prefetchAvatars]","fix":{"range":[21083,21085],"text":"[fetchConnections, fetchConversations, getCachedConnections, getCachedConversations, getCachedGroupInvitations, getCachedGroups, prefetchAvatars]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchGroupInvitations' and 'fetchGroups'. Either include them or remove the dependency array.","line":626,"column":6,"nodeType":"ArrayExpression","endLine":626,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [fetchGroupInvitations, fetchGroups, viewMode]","fix":{"range":[21300,21310],"text":"[fetchGroupInvitations, fetchGroups, viewMode]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'searchAllUsers'. Either include it or remove the dependency array.","line":640,"column":6,"nodeType":"ArrayExpression","endLine":640,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [query, myConnections, viewMode, searchAllUsers]","fix":{"range":[21751,21783],"text":"[query, myConnections, viewMode, searchAllUsers]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'modeFiltered' is assigned a value but never used.","line":773,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":773,"endColumn":21},{"ruleId":"@typescript-eslint/array-type","severity":1,"message":"Array type using 'Array<T>' is forbidden. Use 'T[]' instead.","line":778,"column":21,"nodeType":"TSTypeReference","messageId":"errorStringArray","endLine":788,"endColumn":5,"fix":{"range":[26928,27157],"text":"{\n    uuid: string;\n    name: string;\n    photoUrl?: string;\n    unread: boolean;\n    conversationId?: string;\n    hasConversation: boolean;\n    isGroup?: boolean;\n    memberCount?: number;\n    unreadMessages?: number;\n  }[]"}},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1114,"column":51,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[42331,42383],"text":"\n                Aucun utilisateur ne correspond √† &quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[42331,42383],"text":"\n                Aucun utilisateur ne correspond √† &ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[42331,42383],"text":"\n                Aucun utilisateur ne correspond √† &#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[42331,42383],"text":"\n                Aucun utilisateur ne correspond √† &rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":1114,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[42390,42406],"text":"&quot;\n              "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[42390,42406],"text":"&ldquo;\n              "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[42390,42406],"text":"&#34;\n              "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[42390,42406],"text":"&rdquo;\n              "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'pathname'. Either include it or remove the dependency array.","line":298,"column":6,"nodeType":"ArrayExpression","endLine":298,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [pathname]","fix":{"range":[8369,8371],"text":"[pathname]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":3,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { styles } from '@/styles/appStyles';\nimport { Ionicons } from '@expo/vector-icons';\nimport { router, usePathname } from 'expo-router';\nimport React, { ComponentRef, useEffect, useRef, useState } from 'react';\nimport {\n    ActivityIndicator,\n    Alert,\n    FlatList,\n    Image,\n    RefreshControl,\n    ScrollView,\n    StyleSheet,\n    Text,\n    TextInput,\n    TouchableOpacity,\n    View\n} from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport { CreateGroupModal } from '../../components/CreateGroupModal';\nimport DefaultAvatar from '../../components/DefaultAvatar';\nimport { useAuth } from '../../contexts/AuthContext';\nimport { useChat } from '../../contexts/ChatContext';\nimport { useTransition } from '../../contexts/TransitionContext';\n\n// Import type pour forcer TypeScript √† reconna√Ætre la route\n\n// Types pour les donn√©es des conversations\ninterface Conversation {\n  id: number;\n  uuid: string;\n  last_message: {\n    content: string;\n    sender_username: string;\n    created_at: string;\n  } | null;\n  other_participant: {\n    uuid: string;\n    username: string;\n    surnom: string;\n    photo_profil_url?: string;\n  } | null; // ‚Üê Peut √™tre null\n  unread_count: number;\n  created_at: string;\n  updated_at: string;\n}\n\n// Type pour les utilisateurs dans les r√©sultats de recherche\ninterface User {\n  uuid: string;\n  username: string;\n  surnom: string;\n  photo_profil_url?: string;\n  is_friend?: boolean;\n}\n\n// Type pour les connexions (amis)\ninterface Connection {\n  id: number;\n  uuid: string;\n  user_uuid?: string; // UUID de l'utilisateur si diff√©rent du uuid de la connexion\n  username: string;\n  surnom: string;\n  first_name?: string;\n  last_name?: string;\n  photo_profil_url?: string;\n  statut_relation?: string;\n}\n\n// Type pour les groupes\ninterface Group {\n  id: number;\n  uuid: string;\n  name: string;\n  description?: string;\n  avatar?: string | null;\n  member_count: number;\n  my_role?: 'owner' | 'moderator' | 'member';\n  unread_messages?: number;\n  created_at: string;\n  conversation_uuid?: string;\n}\n\n// Type pour les membres de groupe\ninterface GroupMember {\n  id: number;\n  user: number;\n  username: string;\n  user_uuid: string;\n  surnom?: string;\n  role: 'owner' | 'moderator' | 'member';\n  photo_profil_url?: string | null;\n  joined_at: string;\n}\n\n// Type pour les invitations de groupe\ninterface GroupInvitation {\n  id: number;\n  uuid: string;\n  group: {\n    uuid: string;\n    name: string;\n    description?: string;\n    member_count: number;\n  };\n  created_by: {\n    uuid: string;\n    username: string;\n    photo_profil_url?: string | null;\n  };\n  invitation_type: 'official' | 'member_request';\n  status: 'sent' | 'viewed' | 'pending' | 'accepted' | 'declined' | 'expired';\n  message?: string;\n  created_at: string;\n  expires_at: string;\n}\n\nconst SearchBar = ({ query, setQuery }: { query: string; setQuery: (q: string) => void }) => (\n  <View style={styles.searchContainer}>\n    <TextInput\n      style={styles.searchInput}\n      placeholder=\"Search for a conversation\"\n      placeholderTextColor=\"#777\"\n      value={query}\n      onChangeText={setQuery}\n    />\n  </View>\n);\n\n\nconst ConversationSquare = ({ \n  name, \n  unread, \n  onPress,\n  photoUrl,\n  squareRef\n}: { \n  name: string; \n  unread: boolean; \n  onPress: () => void;\n  photoUrl?: string;\n  squareRef?: React.RefObject<ComponentRef<typeof TouchableOpacity>>;\n}) => (\n  <TouchableOpacity\n    ref={squareRef}\n    style={[\n      styles.conversationSquare,\n      {\n        shadowColor: unread ? \"rgba(10, 145, 104, 0.8)\" : \"#777\",\n        shadowOpacity: 0.6,\n      },\n    ]}\n    onPress={onPress}\n  >\n    {photoUrl ? (\n      <Image source={{ uri: photoUrl }} style={styles.avatar} />\n    ) : (\n      <DefaultAvatar name={name} size={110} style={styles.avatar} />\n    )}\n    <View style={styles.conversationNameBadge}>\n      <Text style={styles.conversationName} numberOfLines={1}>\n        {name}\n      </Text>\n    </View>\n  </TouchableOpacity>\n);\n\n// Composant pour afficher un utilisateur dans les r√©sultats de recherche\nconst UserSquare = ({ \n  user, \n  onPress,\n}: { \n  user: User; \n  onPress: () => void;\n}) => (\n  <TouchableOpacity\n    style={[\n      styles.conversationSquare,\n      {\n        shadowColor: \"#777\",\n        shadowOpacity: 0.4,\n      },\n    ]}\n    onPress={onPress}\n  >\n    {user.photo_profil_url ? (\n      <Image source={{ uri: user.photo_profil_url }} style={styles.avatar} />\n    ) : (\n      <DefaultAvatar name={user.surnom || user.username} size={110} style={styles.avatar} />\n    )}\n    <View style={styles.conversationNameBadge}>\n      <Text style={styles.conversationName} numberOfLines={1}>\n        {user.surnom || user.username}\n      </Text>\n    </View>\n  </TouchableOpacity>\n);\n\nconst GroupSquare = React.memo(({ \n  group, \n  onPress,\n}: { \n  group: Group; \n  onPress: () => void;\n}) => {\n  if (!group) {\n    console.warn('‚ö†Ô∏è GroupSquare re√ßu un groupe null');\n    return null;\n  }\n\n  const groupName = group.name || 'Groupe';\n  const memberCount = typeof group.member_count === 'number' ? group.member_count : 0;\n  const unreadCount = typeof group.unread_messages === 'number' ? group.unread_messages : 0;\n\n  return (\n    <TouchableOpacity\n      style={[\n        styles.conversationSquare,\n        {\n          shadowColor: \"#777\",\n          shadowOpacity: 0.4,\n        },\n      ]}\n      onPress={onPress}\n    >\n      {group.avatar ? (\n        <Image source={{ uri: group.avatar }} style={styles.avatar} />\n      ) : (\n        <View style={[styles.avatar, { backgroundColor: 'rgba(10, 145, 104, 0.2)', justifyContent: 'center', alignItems: 'center' }]}>\n          <Ionicons name=\"people\" size={40} color=\"rgba(10, 145, 104, 1)\" />\n        </View>\n      )}\n      {unreadCount > 0 && (\n        <View style={styles.unreadBadge}>\n          <Text style={styles.unreadText}>{unreadCount}</Text>\n        </View>\n      )}\n      <View style={styles.conversationNameBadge}>\n        <Text style={styles.conversationName} numberOfLines={1}>\n          {groupName}\n        </Text>\n        <Text style={{ fontSize: 10, color: '#888', marginTop: 2 }}>\n          {memberCount} membre{memberCount > 1 ? 's' : ''}\n        </Text>\n      </View>\n    </TouchableOpacity>\n  );\n});\n\nexport default function ConversationsScreen() {\n  const pathname = usePathname();\n  const [conversations, setConversations] = useState<Conversation[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const { makeAuthenticatedRequest, user } = useAuth(); // Utiliser la nouvelle fonction\n  const { setTransitionPosition } = useTransition();\n  const insets = useSafeAreaInsets();\n  const [query, setQuery] = useState(\"\");\n  const [viewMode, setViewMode] = useState<'direct' | 'group'>('direct');\n  const {\n    prefetchConversation,\n    prefetchAvatars,\n    getCachedConversations,\n    setCachedConversations,\n    getCachedConnections,\n    setCachedConnections,\n    getCachedGroups,\n    setCachedGroups,\n    getCachedGroupInvitations,\n    setCachedGroupInvitations,\n    prefetchConversationsOverview,\n  } = useChat();\n  const squareRefs = useRef<Map<string, React.RefObject<ComponentRef<typeof TouchableOpacity>>>>(new Map());\n  \n  // √âtats pour la recherche d'utilisateurs\n  const [searchResults, setSearchResults] = useState<{ friends: User[], strangers: User[] }>({ friends: [], strangers: [] });\n  const [isSearching, setIsSearching] = useState(false);\n  const [myConnections, setMyConnections] = useState<Connection[]>([]);\n  \n  // √âtats pour les groupes\n  const [groups, setGroups] = useState<Group[]>([]);\n  const [showCreateGroupModal, setShowCreateGroupModal] = useState(false);\n  const [groupInvitations, setGroupInvitations] = useState<GroupInvitation[]>([]);\n  \n  // Utilise le proxy local pour √©viter CORS en d√©veloppement web\n  const API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n    ? \"http://localhost:3001\"\n    : \"https://reseausocial-production.up.railway.app\";\n\n  // Forcer la route base sur /conversations pour √©viter le ‚Äúrebascule‚Äù vers Home\n  useEffect(() => {\n    try {\n      if (!pathname.includes('/conversations')) {\n        router.replace('/(tabs)/conversations');\n      }\n    } catch {}\n    // volontairement [] pour ne d√©clencher qu'au montage de l'√©cran\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fonction pour r√©cup√©rer les conversations\n  const fetchConversations = async (isRefresh = false) => {\n    try {\n      if (!isRefresh) setLoading(true);\n      \n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/messaging/conversations/`\n      );\n\n      if (!response.ok) {\n        throw new Error(`Erreur ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      console.log('Conversations r√©cup√©r√©es:', data);\n      const list = data.results || data;\n      setConversations(list);\n      setCachedConversations(list);\n      // Pr√©charger avatars de la liste de conversations\n      try {\n        const avatarUrls: string[] = [];\n        (Array.isArray(data.results ? data.results : data) ? (data.results || data) : []).forEach((c: any) => {\n          const url = c.other_participant?.photo_profil_url || c.group?.avatar;\n          if (url) avatarUrls.push(url);\n        });\n        await prefetchAvatars(avatarUrls);\n      } catch {}\n      \n    } catch (error) {\n      console.error('Erreur lors du chargement des conversations:', error);\n      const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';\n      if (errorMessage.includes('Token expir√©')) {\n        // L'utilisateur sera automatiquement d√©connect√©\n        return;\n      }\n      Alert.alert(\n        'Erreur', \n        'Impossible de charger les conversations. V√©rifiez votre connexion.'\n      );\n    } finally {\n      setLoading(false);\n      setRefreshing(false);\n    }\n  };\n\n  // Fonction pour rechercher tous les utilisateurs\n  const searchAllUsers = async (searchQuery: string) => {\n    if (!searchQuery.trim()) {\n      setSearchResults({ friends: [], strangers: [] });\n      setIsSearching(false);\n      return;\n    }\n\n    setIsSearching(true);\n    try {\n      // R√©cup√©rer tous les utilisateurs\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/api/users/`\n      );\n\n      if (!response.ok) {\n        console.log(`Erreur lors de la r√©cup√©ration des utilisateurs (${response.status})`);\n        throw new Error(`Erreur ${response.status}: Impossible de r√©cup√©rer la liste des utilisateurs`);\n      }\n\n      const data = await response.json();\n      let allUsers: User[] = Array.isArray(data) ? data : (data.results || []);\n      \n      // Filtrer localement par surnom ou username\n      const users = allUsers.filter(u => {\n        const surnom = (u.surnom || '').toLowerCase();\n        const username = (u.username || '').toLowerCase();\n        const query = searchQuery.toLowerCase();\n        return surnom.includes(query) || username.includes(query);\n      });\n      \n      // Cr√©er un Set avec les UUIDs des connexions (user_uuid en priorit√©, sinon uuid)\n      const connectionUuids = new Set(myConnections.map(c => c.user_uuid || c.uuid));\n      \n      console.log('üîç Utilisateurs trouv√©s:', users.length);\n      console.log('üìã Connexions actives:', myConnections.length);\n      console.log('üë• UUIDs des connexions:', Array.from(connectionUuids));\n      \n      // S√©parer les r√©sultats en amis (connexions accept√©es) et inconnus (tous les autres)\n      const friends = users.filter(u => connectionUuids.has(u.uuid));\n      const strangers = users.filter(u => !connectionUuids.has(u.uuid));\n      \n      console.log('‚úÖ Amis trouv√©s:', friends.length, friends.map(f => f.surnom || f.username));\n      console.log('üÜï Inconnus trouv√©s:', strangers.length, strangers.map(s => s.surnom || s.username));\n      \n      setSearchResults({ friends, strangers });\n    } catch (error) {\n      console.error('Erreur lors de la recherche d\\'utilisateurs:', error);\n      setSearchResults({ friends: [], strangers: [] });\n    } finally {\n      setIsSearching(false);\n    }\n  };\n\n  // Fonction pour r√©cup√©rer les connexions\n  const fetchConnections = async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/my-connections/`\n      );\n      \n      if (response.ok) {\n        const data = await response.json();\n        const connections: Connection[] = data.connexions || [];\n        setMyConnections(connections);\n        setCachedConnections(connections);\n        console.log('üì± Connexions charg√©es:', connections.length, connections.map(c => c.surnom || c.username));\n        console.log('üìã Structure premi√®re connexion:', JSON.stringify(connections[0], null, 2));\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des connexions:', error);\n    }\n  };\n\n  // Fonction pour r√©cup√©rer les groupes\n  const fetchGroups = async () => {\n    try {\n      console.log('üì° Chargement des groupes...');\n      \n      // D'abord r√©cup√©rer toutes les conversations pour filtrer\n      const conversationsResponse = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/messaging/conversations/`\n      );\n      \n      const privateConversationUuids = new Set<string>();\n      if (conversationsResponse.ok) {\n        const convList = await conversationsResponse.json();\n        // Marquer toutes les conversations avec other_participant comme priv√©es\n        convList.forEach((c: any) => {\n          if (c.other_participant) {\n            privateConversationUuids.add(c.uuid);\n            console.log('üîí Conv priv√©e d√©tect√©e:', c.uuid, '- participant:', c.other_participant.username);\n          }\n        });\n        console.log('üîí Conversations priv√©es trouv√©es:', privateConversationUuids.size);\n      }\n      \n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/my-groups/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        console.log('üìã Groupes de base r√©cup√©r√©s:', data.length);\n        \n        // /groups/my-groups/ ne retourne pas conversation_uuid\n        // Il faut charger les d√©tails de chaque groupe\n        const groupsWithDetails = [];\n        \n        for (const group of data) {\n          try {\n            console.log('üîç Chargement d√©tails pour:', group.name);\n            const detailsResponse = await makeAuthenticatedRequest(\n              `${API_BASE_URL}/groups/${group.uuid}/`\n            );\n            \n            if (detailsResponse.ok) {\n              const groupDetails = await detailsResponse.json();\n              const convUuid = groupDetails.conversation_uuid;\n              \n              console.log('üîç D√©tails complets pour', group.name, ':', JSON.stringify({\n                conversation_uuid: convUuid,\n                my_role: groupDetails.my_role,\n                my_membership: groupDetails.my_membership,\n                member_count: groupDetails.member_count\n              }, null, 2));\n              \n              // V√©rifier si c'est vraiment un conflit (groupe avec my_role devrait √™tre affich√©)\n              const hasGroupRole = groupDetails.my_membership || groupDetails.my_role;\n              if (convUuid && privateConversationUuids.has(convUuid) && !hasGroupRole) {\n                console.warn('‚ö†Ô∏è Groupe', group.name, 'a un conversation_uuid qui est une conv priv√©e, ignor√©');\n                console.warn('   ‚Üí conversation_uuid:', convUuid);\n                console.warn('   ‚Üí group_uuid:', group.uuid);\n                console.warn('   ‚Üí my_role:', groupDetails.my_role, 'my_membership:', groupDetails.my_membership);\n                continue;\n              }\n              \n              if (convUuid && privateConversationUuids.has(convUuid)) {\n                console.log('‚ö†Ô∏è CONFLIT d√©tect√© pour', group.name, '- mais le groupe a un r√¥le, donc affich√© quand m√™me');\n              }\n              \n              console.log('‚úÖ D√©tails r√©cup√©r√©s pour', group.name, '- conversation_uuid:', convUuid);\n              groupsWithDetails.push({\n                ...group,\n                conversation_uuid: convUuid,\n                members: groupDetails.members,\n                my_membership: groupDetails.my_membership,\n                invite_code: groupDetails.invite_code,\n              });\n            } else {\n              console.error('‚ùå Erreur HTTP pour', group.name, ':', detailsResponse.status);\n              groupsWithDetails.push(group);\n            }\n          } catch (error) {\n            console.error('‚ùå Erreur chargement d√©tails groupe:', group.name, error);\n            // Garder le groupe m√™me si on ne peut pas charger les d√©tails\n            groupsWithDetails.push(group);\n          }\n        }\n        \n        setGroups(groupsWithDetails);\n        setCachedGroups(groupsWithDetails);\n        console.log('üë• Groupes charg√©s:', groupsWithDetails.length, groupsWithDetails.map((g: any) => g.name));\n        console.log('üìã Groupes avec conversation_uuid:', JSON.stringify(groupsWithDetails.map((g: any) => ({\n          name: g.name,\n          uuid: g.uuid,\n          conversation_uuid: g.conversation_uuid\n        })), null, 2));\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des groupes:', error);\n    }\n  };\n\n  // Fonction pour r√©cup√©rer les invitations de groupe\n  const fetchGroupInvitations = async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/invitations/received/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        setGroupInvitations(data);\n        setCachedGroupInvitations(data);\n        console.log('üì® Invitations de groupe:', data.length);\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des invitations:', error);\n    }\n  };\n\n  // Fonction pour cr√©er un nouveau groupe\n  const createGroup = async (name: string, description: string) => {\n    try {\n      console.log('üÜï Cr√©ation groupe:', name);\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/create/`,\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            name: name.trim(),\n            description: description.trim() || undefined,\n          }),\n        }\n      );\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        console.error('‚ùå Erreur cr√©ation groupe:', errorData);\n        throw new Error(errorData.detail || errorData.error || `Erreur ${response.status}`);\n      }\n\n      const newGroup = await response.json();\n      console.log('‚úÖ Groupe cr√©√©:', newGroup.name, 'UUID:', newGroup.uuid, 'Conversation:', newGroup.conversation_uuid);\n      console.log('üìã Donn√©es compl√®tes du groupe:', JSON.stringify(newGroup, null, 2));\n      \n      // Ajouter le nouveau groupe √† la liste\n      setGroups(prev => [newGroup, ...prev]);\n      \n      Alert.alert(\n        'Succ√®s',\n        `Le groupe \"${name}\" a √©t√© cr√©√© avec succ√®s !`\n      );\n\n      // Si le groupe a une conversation, on peut l'ouvrir\n      if (newGroup.conversation_uuid) {\n        console.log('üéØ Ouverture conversation groupe:', newGroup.conversation_uuid);\n        router.push({\n          pathname: '/(tabs)/conversation-group',\n          params: { conversationId: newGroup.conversation_uuid }\n        });\n      } else {\n        console.warn('‚ö†Ô∏è Le groupe cr√©√© n\\'a pas de conversation_uuid');\n      }\n    } catch (error) {\n      console.error('‚ùå Erreur lors de la cr√©ation du groupe:', error);\n      throw error;\n    }\n  };\n\n  // Charger depuis le cache au montage pour affichage instantan√©, puis rafra√Æchir en arri√®re-plan l√©ger\n  useEffect(() => {\n    const cachedConvs = getCachedConversations();\n    const cachedConns = getCachedConnections();\n    const cachedGroups = getCachedGroups();\n    const cachedInvites = getCachedGroupInvitations();\n\n    if (cachedConvs) {\n      setConversations(cachedConvs as any);\n      // Pr√©charger avatars pour un rendu encore plus fluide\n      try {\n        const avatarUrls: string[] = [];\n        (cachedConvs as any[]).forEach((c: any) => {\n          const url = c.other_participant?.photo_profil_url || c.group?.avatar;\n          if (url) avatarUrls.push(url);\n        });\n        prefetchAvatars(avatarUrls);\n      } catch {}\n    }\n  if (cachedConns) setMyConnections(cachedConns as any);\n  // Hydrater imm√©diatement les groupes/invitations pour que l'onglet Groupe s'affiche instantan√©ment\n  if (cachedGroups) setGroups(cachedGroups as any);\n  if (cachedInvites) setGroupInvitations(cachedInvites as any);\n\n    // Si on a d√©j√† des conversations en cache, pas de spinner\n    setLoading(!(cachedConvs && (cachedConvs as any[]).length > 0));\n\n    // Rafra√Æchissement l√©ger en arri√®re-plan (sans changer loading)\n    fetchConversations(true);\n    fetchConnections();\n    // Les groupes sont charg√©s uniquement lors du passage en mode 'group'\n  }, []); // Supprimer accessToken des d√©pendances\n\n  // Charger les groupes quand on passe en mode Groupe\n  useEffect(() => {\n    if (viewMode === 'group') {\n      fetchGroups();\n      fetchGroupInvitations();\n    }\n  }, [viewMode]);\n\n  // D√©clencher la recherche quand la query change (seulement en mode Priv√©)\n  useEffect(() => {\n    if (viewMode === 'direct') {\n      const timeoutId = setTimeout(() => {\n        searchAllUsers(query);\n      }, 300); // Debounce de 300ms\n      \n      return () => clearTimeout(timeoutId);\n    } else {\n      // En mode Groupe, r√©initialiser les r√©sultats de recherche\n      setSearchResults({ friends: [], strangers: [] });\n    }\n  }, [query, myConnections, viewMode]);\n\n  // Fonction de rafra√Æchissement (pull-to-refresh)\n  const onRefresh = () => {\n    setRefreshing(true);\n    fetchConversations(true);\n    fetchConnections();\n  };\n\n  // D√©clencher le pr√©chargement pour les √©l√©ments visibles\n  const handleItemVisibility = async (items: typeof displayItems) => {\n    try {\n      const candidateIds = items\n        .map((it) => it.conversationId)\n        .filter((id): id is string => typeof id === 'string' && id.length > 0)\n        .slice(0, 9); // limiter pour √©viter surcharge\n      await Promise.allSettled(candidateIds.map((id) => prefetchConversation(id, makeAuthenticatedRequest)));\n    } catch {}\n  };\n\n  // Fonction pour cr√©er ou ouvrir une conversation avec un utilisateur\n  const handleUserPress = async (userUuid: string, userName: string) => {\n    try {\n      // V√©rifier s'il existe d√©j√† une conversation avec cet utilisateur (ami)\n      const existingConversation = conversations.find(\n        c => c.other_participant?.uuid === userUuid\n      );\n\n      if (existingConversation) {\n        // C'est un ami, ouvrir la conversation existante\n        router.push({\n          pathname: '/(tabs)/conversation-direct',\n          params: { conversationId: existingConversation.uuid }\n        });\n      } else {\n        // Ce n'est pas encore un ami, envoyer une demande de connexion\n        Alert.alert(\n          'Envoyer une demande',\n          `Voulez-vous envoyer une demande de connexion √† ${userName} ?`,\n          [\n            {\n              text: 'Annuler',\n              style: 'cancel'\n            },\n            {\n              text: 'Envoyer',\n              onPress: async () => {\n                try {\n                  console.log('üì§ Envoi demande de connexion pour UUID:', userUuid);\n                  \n                  const response = await makeAuthenticatedRequest(\n                    `${API_BASE_URL}/relations/connections/`,\n                    {\n                      method: 'POST',\n                      headers: {\n                        'Content-Type': 'application/json',\n                      },\n                      body: JSON.stringify({\n                        destinataire_uuid: userUuid,\n                        message: `Bonjour ${userName}, je souhaite te connecter !`,\n                      }),\n                    }\n                  );\n\n                  console.log('üì• R√©ponse statut:', response.status);\n\n                  if (!response.ok) {\n                    const errorData = await response.json().catch(() => ({}));\n                    console.error('‚ùå Erreur d√©tails:', errorData);\n                    \n                    // G√©rer les cas d'erreur sp√©cifiques\n                    let errorMessage = 'Impossible d\\'envoyer la demande de connexion.';\n                    \n                    if (errorData.detail) {\n                      errorMessage = errorData.detail;\n                    } else if (errorData.error) {\n                      errorMessage = errorData.error;\n                    } else if (errorData.non_field_errors) {\n                      errorMessage = errorData.non_field_errors[0];\n                    } else if (errorData.destinataire_uuid) {\n                      errorMessage = `UUID invalide: ${errorData.destinataire_uuid[0]}`;\n                    }\n                    \n                    throw new Error(errorMessage);\n                  }\n\n                  await response.json();\n                  console.log('‚úÖ Demande envoy√©e avec succ√®s');\n                  \n                  Alert.alert(\n                    'Demande envoy√©e',\n                    `Votre demande de connexion a √©t√© envoy√©e √† ${userName}. Vous pourrez discuter une fois qu'elle sera accept√©e.`\n                  );\n                } catch (error) {\n                  console.error('Erreur lors de l\\'envoi de la demande de connexion:', error);\n                  const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';\n                  \n                  Alert.alert(\n                    'Erreur',\n                    errorMessage.includes('existe d√©j√†') || errorMessage.includes('d√©j√†')\n                      ? 'Une demande de connexion existe d√©j√† avec cet utilisateur.'\n                      : errorMessage\n                  );\n                }\n              }\n            }\n          ]\n        );\n      }\n    } catch (error) {\n      console.error('Erreur lors de la gestion de l\\'utilisateur:', error);\n      Alert.alert(\n        'Erreur',\n        'Une erreur est survenue.'\n      );\n    }\n  };\n\n    \n    // Affichage de chargement\n  if (loading) {\n    return (\n      <View style={styles.container}>\n        <ActivityIndicator size=\"large\" color=\"rgba(10, 145, 104, 1)\" />\n        <Text style={{ marginTop: 10, color: '#666' }}>Chargement...</Text>\n      </View>\n    );\n  }\n\n  // Helpers to detect 1-on-1 vs group\n  const isDirect = (c: Conversation) => !!c.other_participant;\n  const isGroup = (c: Conversation) => !c.other_participant;\n\n  const modeFiltered = conversations.filter((c) =>\n    viewMode === 'direct' ? isDirect(c) : isGroup(c)\n  );\n\n  // Cr√©er une liste selon le mode s√©lectionn√©\n  let displayItems: Array<{\n    uuid: string;\n    name: string;\n    photoUrl?: string;\n    unread: boolean;\n    conversationId?: string;\n    hasConversation: boolean;\n    isGroup?: boolean;\n    memberCount?: number;\n    unreadMessages?: number;\n  }> = [];\n\n  if (viewMode === 'direct') {\n    // Mode Priv√© : afficher tous les amis (avec ou sans conversation)\n    displayItems = myConnections.map(friend => {\n      // Utiliser user_uuid si disponible, sinon uuid\n      const friendUuid = friend.user_uuid || friend.uuid;\n      \n      // Trouver la conversation correspondante s'il y en a une\n      const conversation = conversations.find(c => \n        c.other_participant?.uuid === friendUuid || \n        c.other_participant?.uuid === friend.uuid\n      );\n      \n      return {\n        uuid: friendUuid,\n        name: friend.surnom || friend.username,\n        photoUrl: friend.photo_profil_url,\n        unread: conversation ? conversation.unread_count > 0 : false,\n        conversationId: conversation?.uuid,\n        hasConversation: !!conversation,\n      };\n    });\n  } else {\n    // Mode Groupe : afficher les groupes depuis l'API /groups/my-groups/\n    displayItems = groups.map(group => ({\n      uuid: group.uuid,\n      name: group.name,\n      photoUrl: group.avatar || undefined,\n      unread: false, // L'unread sera g√©r√© via group.unread_messages\n      conversationId: group.conversation_uuid,\n      hasConversation: !!group.conversation_uuid,\n      isGroup: true,\n      memberCount: group.member_count,\n      unreadMessages: group.unread_messages || 0,\n    }));\n  }\n\n  // Filtrer selon la recherche\n  const filteredFriends = query.trim()\n    ? displayItems.filter(f => f.name.toLowerCase().includes(query.toLowerCase()))\n    : displayItems;\n\n  // Afficher les \"autres utilisateurs\" seulement si on a une recherche active en mode Priv√©\n  const showStrangers = viewMode === 'direct' && query.trim().length > 0 && searchResults.strangers.length > 0;\n  \n  return (\n    <View style={[styles.container, { paddingTop: (insets.top || 0) + 0 }]}> \n      <SearchBar query={query} setQuery={setQuery} />\n\n      {/* Toggle 1-on-1 / Groupes */}\n      <View style={localStyles.toggleContainer}>\n        <TouchableOpacity\n          style={[localStyles.toggleButton, viewMode === 'direct' && localStyles.toggleActive]}\n          onPress={() => setViewMode('direct')}\n          activeOpacity={0.8}\n        >\n          <Ionicons name=\"person-outline\" size={16} color={viewMode === 'direct' ? '#fff' : '#666'} />\n          <Text style={[localStyles.toggleLabel, viewMode === 'direct' && localStyles.toggleLabelActive]}>Priv√©</Text>\n        </TouchableOpacity>\n        <TouchableOpacity\n          style={[localStyles.toggleButton, viewMode === 'group' && localStyles.toggleActive]}\n          onPress={() => setViewMode('group')}\n          activeOpacity={0.8}\n        >\n          <Ionicons name=\"people-outline\" size={16} color={viewMode === 'group' ? '#fff' : '#666'} />\n          <Text style={[localStyles.toggleLabel, viewMode === 'group' && localStyles.toggleLabelActive]}>Groupe</Text>\n        </TouchableOpacity>\n      </View>\n\n      {/* Header Cr√©er un groupe (en mode Groupe avec recherche) */}\n      {viewMode === 'group' && query.trim().length > 0 && (\n        <TouchableOpacity\n          style={[localStyles.categoryHeaderSearch, { marginTop: 160 }]}\n          onPress={() => {\n            console.log('üÜï Cr√©ation groupe depuis header');\n            setShowCreateGroupModal(true);\n          }}\n          activeOpacity={0.7}\n        >\n          <Ionicons name=\"add-circle\" size={18} color=\"rgba(10, 145, 104, 1)\" />\n          <Text style={localStyles.categoryTitleSearch}>Cr√©er un groupe</Text>\n          <Ionicons name=\"chevron-forward\" size={18} color=\"rgba(10, 145, 104, 1)\" />\n        </TouchableOpacity>\n      )}\n\n      {/* Grille de conversations avec section \"Autres utilisateurs\" si recherche */}\n      {filteredFriends.length === 0 && !showStrangers && !(viewMode === 'group' && query.trim().length > 0) ? (\n        <View style={localStyles.emptyConversationsContainer}>\n          <Ionicons \n            name={viewMode === 'direct' ? \"person-outline\" : \"people-outline\"} \n            size={80} \n            color=\"rgba(10, 145, 104, 0.3)\" \n          />\n          <Text style={localStyles.emptyConversationsTitle}>\n            {viewMode === 'direct' ? 'Aucun ami' : 'Aucun groupe'}\n          </Text>\n          <Text style={localStyles.emptyConversationsText}>\n            {viewMode === 'direct' \n              ? 'Utilisez la barre de recherche pour trouver des personnes et commencer √† discuter'\n              : 'Vous n\\'avez pas encore de conversation de groupe'\n            }\n          </Text>\n        </View>\n      ) : (\n        <ScrollView\n          showsVerticalScrollIndicator={false}\n          refreshControl={\n            <RefreshControl\n              refreshing={refreshing}\n              onRefresh={onRefresh}\n            />\n          }\n          onLayout={() => handleItemVisibility(filteredFriends)}\n          onScrollEndDrag={() => handleItemVisibility(filteredFriends)}\n        >\n          {/* Grille des amis (toujours affich√©e) */}\n      <FlatList\n            data={filteredFriends}\n        keyExtractor={(item) => item.uuid}\n        renderItem={({ item }) => {\n          // Si c'est un groupe, utiliser GroupSquare\n          if (item.isGroup) {\n            const group = groups.find(g => g.uuid === item.uuid);\n            if (group) {\n              return (\n                <GroupSquare\n                  group={group}\n                  onPress={async () => {\n                    console.log('üîç Clic sur groupe:', {\n                      name: group.name,\n                      uuid: group.uuid,\n                      conversation_uuid: group.conversation_uuid\n                    });\n                    \n                    if (group.conversation_uuid) {\n                      console.log('üë• Ouverture groupe:', group.name, 'conversation:', group.conversation_uuid);\n        router.push({\n          pathname: '/(tabs)/conversation-group',\n          params: { conversationId: group.conversation_uuid }\n        });\n                    } else {\n                      // Le groupe devrait avoir un conversation_uuid d√®s la cr√©ation\n                      // Si ce n'est pas le cas, recharger les donn√©es du groupe\n                      console.log('‚ö†Ô∏è Groupe sans conversation_uuid, rechargement...');\n                      try {\n                        const response = await makeAuthenticatedRequest(\n                          `${API_BASE_URL}/groups/${group.uuid}/`\n                        );\n                        \n                        if (!response.ok) {\n                          console.error('‚ùå Erreur rechargement:', response.status);\n                          throw new Error(`Erreur ${response.status}`);\n                        }\n                        \n                        const updatedGroup = await response.json();\n                        console.log('‚úÖ Groupe recharg√©:', {\n                          name: updatedGroup.name,\n                          conversation_uuid: updatedGroup.conversation_uuid\n                        });\n                        \n                        // Mettre √† jour le groupe dans la liste\n                        setGroups(prev => prev.map(g => \n                          g.uuid === group.uuid ? {\n                            ...updatedGroup,\n                            conversation_uuid: updatedGroup.conversation_uuid\n                          } : g\n                        ));\n                        \n                        if (updatedGroup.conversation_uuid) {\n                          // Ouvrir la conversation maintenant\n                          console.log('‚úÖ Ouverture conversation:', updatedGroup.conversation_uuid);\n                          router.push({\n                            pathname: '/(tabs)/conversation-group',\n                            params: { conversationId: updatedGroup.conversation_uuid }\n                          });\n                        } else {\n                          console.error('‚ùå Groupe recharg√© mais pas de conversation_uuid');\n                          Alert.alert(\n                            'Erreur', \n                            'Ce groupe n\\'a pas encore de conversation associ√©e. Veuillez r√©essayer plus tard.'\n                          );\n                        }\n                      } catch (error) {\n                        console.error('‚ùå Erreur lors du rechargement du groupe:', error);\n                        Alert.alert('Erreur', 'Impossible d\\'ouvrir le groupe.');\n                      }\n                    }\n                  }}\n                />\n              );\n            }\n            return null;\n          }\n\n          // Sinon, c'est une conversation directe\n          if (!squareRefs.current.has(item.uuid)) {\n                squareRefs.current.set(item.uuid, React.createRef() as React.RefObject<ComponentRef<typeof TouchableOpacity>>);\n          }\n          const squareRef = squareRefs.current.get(item.uuid)!;\n          \n          return (\n            <ConversationSquare\n                  name={item.name}\n                  unread={item.unread}\n                  photoUrl={item.photoUrl}\n              squareRef={squareRef}\n                  onPress={async () => {\n                    if (item.hasConversation) {\n                      // Si conversation existe, ouvrir la conversation directement\n                      squareRef.current?.measure((x: number, y: number, width: number, height: number, pageX: number, pageY: number) => {\n                        setTransitionPosition({ x: pageX, y: pageY, width, height });\n                        router.push({\n                          pathname: '/(tabs)/conversation-direct',\n                          params: { conversationId: item.conversationId }\n                        });\n                      });\n                    } else {\n                      // Si ami sans conversation, v√©rifier d'abord si une conversation existe\n                      try {\n                        console.log('üîç Recherche conversation avec UUID:', item.uuid);\n                        \n                        // V√©rifier dans toutes les conversations (m√™me celles filtr√©es)\n                        const existingConv = conversations.find(c => c.other_participant?.uuid === item.uuid);\n                        \n                        if (existingConv) {\n                          console.log('‚úÖ Conversation trouv√©e:', existingConv.uuid);\n                          squareRef.current?.measure((x: number, y: number, width: number, height: number, pageX: number, pageY: number) => {\n                            setTransitionPosition({ x: pageX, y: pageY, width, height });\n                        router.push({\n                          pathname: '/(tabs)/conversation-direct',\n                          params: { conversationId: existingConv.uuid }\n                        });\n                          });\n                          return;\n                        }\n                        \n                        console.log('üÜï Cr√©ation nouvelle conversation pour UUID:', item.uuid);\n                        console.log('üìã Nom de l\\'ami:', item.name);\n                        \n                        const response = await makeAuthenticatedRequest(\n                          `${API_BASE_URL}/messaging/conversations/`,\n                          {\n                            method: 'POST',\n                            headers: {\n                              'Content-Type': 'application/json',\n                            },\n                            body: JSON.stringify({\n                              other_user_uuid: item.uuid,\n                            }),\n                          }\n                        );\n\n                        if (!response.ok) {\n                          const errorData = await response.json().catch(() => ({}));\n                          console.error('‚ùå Erreur cr√©ation conversation pour UUID:', item.uuid);\n                          console.error('‚ùå D√©tails erreur:', errorData);\n                          throw new Error(errorData.detail || errorData.error || `Erreur ${response.status}`);\n                        }\n\n                        const newConversation = await response.json();\n                        console.log('‚úÖ Conversation cr√©√©e:', newConversation.uuid);\n                        \n                        // Ajouter la nouvelle conversation et l'ouvrir\n                        setConversations(prev => [newConversation, ...prev]);\n                        \n                        squareRef.current?.measure((x: number, y: number, width: number, height: number, pageX: number, pageY: number) => {\n                  setTransitionPosition({ x: pageX, y: pageY, width, height });\n                  router.push({\n                    pathname: '/(tabs)/conversation-direct',\n                    params: { conversationId: newConversation.uuid }\n                  });\n                });\n                      } catch (error) {\n                        console.error('‚ùå Erreur lors de la cr√©ation de la conversation:', error);\n                        Alert.alert(\n                          'Erreur',\n                          'Impossible de cr√©er la conversation.'\n                        );\n                      }\n                    }\n              }}\n            />\n          );\n        }}\n        numColumns={3}\n        columnWrapperStyle={styles.row}\n        contentContainerStyle={[styles.conversationGrid, localStyles.gridCompact]}\n            scrollEnabled={false}\n            ListFooterComponent={\n              showStrangers ? (\n                <View>\n                  <View style={localStyles.categoryHeaderSearch}>\n                    <Ionicons name=\"person-add\" size={18} color=\"rgba(10, 145, 104, 1)\" />\n                    <Text style={localStyles.categoryTitleSearch}>Autres utilisateurs</Text>\n                    <View style={localStyles.categoryBadge}>\n                      <Text style={localStyles.categoryBadgeText}>{searchResults.strangers.length}</Text>\n                    </View>\n                  </View>\n                  \n                  {/* Grille des autres utilisateurs */}\n                  <FlatList\n                    data={searchResults.strangers}\n                    keyExtractor={(item) => item.uuid}\n                    renderItem={({ item }) => (\n                      <UserSquare\n                        user={item}\n                        onPress={() => handleUserPress(item.uuid, item.surnom || item.username)}\n                      />\n                    )}\n                    numColumns={3}\n                    columnWrapperStyle={styles.row}\n                    contentContainerStyle={{ paddingHorizontal: 10 }}\n                    scrollEnabled={false}\n                  />\n                </View>\n              ) : null\n            }\n          />\n\n          {/* Message si aucun r√©sultat avec recherche */}\n          {query.trim() && filteredFriends.length === 0 && searchResults.strangers.length === 0 && !isSearching && viewMode === 'direct' && (\n            <View style={localStyles.noResultsContainer}>\n              <Ionicons name=\"search-outline\" size={64} color=\"#ccc\" />\n              <Text style={localStyles.noResultsTitle}>Aucun r√©sultat</Text>\n              <Text style={localStyles.noResultsText}>\n                Aucun utilisateur ne correspond √† \"{query}\"\n              </Text>\n            </View>\n          )}\n        </ScrollView>\n      )}\n\n      {/* Modal de cr√©ation de groupe */}\n      <CreateGroupModal\n        visible={showCreateGroupModal}\n        onClose={() => setShowCreateGroupModal(false)}\n        onCreate={createGroup}\n      />\n    </View>\n  );\n}\n\nconst localStyles = StyleSheet.create({\n  toggleContainer: {\n    position: 'absolute',\n    top: 120,\n    left: 20,\n    right: 20,\n    flexDirection: 'row',\n    backgroundColor: 'rgba(255, 255, 255, 0.85)',\n    padding: 3,\n    borderRadius: 25,\n    zIndex: 10,\n    shadowColor: 'rgba(255, 255, 255, 0.75)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.7,\n    shadowRadius: 8,\n    elevation: 5,\n  },\n  toggleButton: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 10,\n    paddingHorizontal: 12,\n    borderRadius: 25,\n    backgroundColor: 'transparent',\n  },\n  toggleActive: {\n    backgroundColor: 'rgba(10, 145, 104, 0.65)',\n    shadowColor: 'rgba(10, 145, 104, 0.7)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.3,\n    shadowRadius: 4,\n    elevation: 2,\n  },\n  toggleLabel: {\n    marginLeft: 6,\n    color: '#666',\n    fontWeight: '600',\n    fontSize: 14,\n  },\n  toggleLabelActive: {\n    color: '#fff',\n    fontWeight: '700',\n  },\n  gridCompact: {\n    paddingTop: 145,\n    marginTop: 0,\n  },\n  categoryHeader: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    backgroundColor: 'rgba(240, 250, 248, 1)',\n    borderRadius: 16,\n    marginBottom: 4,\n    marginHorizontal: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.2)',\n    shadowOffset: { width: 0, height: 2 },\n    shadowOpacity: 0.3,\n    shadowRadius: 4,\n    elevation: 2,\n  },\n  categoryHeaderSearch: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    marginTop: 20,\n    marginBottom: 15,\n    marginHorizontal: 20,\n    backgroundColor: 'rgba(255,255,255,0.6)',\n    borderRadius: 25,\n    shadowColor: '#fff',\n    shadowOpacity: 0.9,\n    elevation: 5,\n    paddingHorizontal: 15,\n    paddingVertical: 12,\n    zIndex: 5,\n  },\n  categoryTitleSearch: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: 'rgba(10, 145, 104, 1)',\n    marginLeft: 10,\n    flex: 1,\n  },\n  categoryTitle: {\n    fontSize: 18,\n    fontWeight: '700',\n    color: 'rgba(10, 145, 104, 1)',\n    marginLeft: 10,\n    flex: 1,\n  },\n  categoryBadge: {\n    backgroundColor: 'rgba(10, 145, 104, 1)',\n    paddingHorizontal: 10,\n    paddingVertical: 4,\n    borderRadius: 12,\n    minWidth: 28,\n    alignItems: 'center',\n  },\n  categoryBadgeText: {\n    color: '#fff',\n    fontSize: 13,\n    fontWeight: '700',\n  },\n  noResultsContainer: {\n    flex: 1,\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 80,\n    paddingHorizontal: 40,\n  },\n  noResultsTitle: {\n    fontSize: 20,\n    fontWeight: '700',\n    color: '#333',\n    marginTop: 16,\n    marginBottom: 8,\n  },\n  noResultsText: {\n    fontSize: 14,\n    color: '#6c8a6e',\n    textAlign: 'center',\n    lineHeight: 20,\n  },\n  emptyConversationsContainer: {\n    flex: 1,\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingHorizontal: 40,\n    paddingTop: 120,\n  },\n  emptyConversationsTitle: {\n    fontSize: 22,\n    fontWeight: '700',\n    color: '#333',\n    marginTop: 20,\n    marginBottom: 12,\n  },\n  emptyConversationsText: {\n    fontSize: 15,\n    color: '#6c8a6e',\n    textAlign: 'center',\n    lineHeight: 22,\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/friends.tsx","messages":[{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":411,"column":48,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[12820,12943],"text":"\n                Recherchez des personnes dans l&apos;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[12820,12943],"text":"\n                Recherchez des personnes dans l&lsquo;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[12820,12943],"text":"\n                Recherchez des personnes dans l&#39;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[12820,12943],"text":"\n                Recherchez des personnes dans l&rsquo;onglet Conversations pour envoyer des demandes de connexion\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":454,"column":23,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[14737,14820],"text":"\n                Vous n&apos;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[14737,14820],"text":"\n                Vous n&lsquo;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[14737,14820],"text":"\n                Vous n&#39;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[14737,14820],"text":"\n                Vous n&rsquo;avez pas de demandes de connexion en attente\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":537,"column":23,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[18317,18399],"text":"\n                Vous n&apos;avez pas d'invitations de groupe en attente\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[18317,18399],"text":"\n                Vous n&lsquo;avez pas d'invitations de groupe en attente\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[18317,18399],"text":"\n                Vous n&#39;avez pas d'invitations de groupe en attente\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[18317,18399],"text":"\n                Vous n&rsquo;avez pas d'invitations de groupe en attente\n              "},"desc":"Replace with `&rsquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":537,"column":34,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[18317,18399],"text":"\n                Vous n'avez pas d&apos;invitations de groupe en attente\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[18317,18399],"text":"\n                Vous n'avez pas d&lsquo;invitations de groupe en attente\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[18317,18399],"text":"\n                Vous n'avez pas d&#39;invitations de groupe en attente\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[18317,18399],"text":"\n                Vous n'avez pas d&rsquo;invitations de groupe en attente\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import DefaultAvatar from '@/components/DefaultAvatar';\nimport { BACKGROUND_GRAY, ECHO_COLOR } from '@/constants/colors';\nimport { useAuth } from '@/contexts/AuthContext';\nimport { Ionicons } from '@expo/vector-icons';\nimport { router } from 'expo-router';\nimport React, { useCallback, useEffect, useState } from 'react';\nimport {\n    ActivityIndicator,\n    Alert,\n    Image,\n    RefreshControl,\n    ScrollView,\n    StyleSheet,\n    Text,\n    TouchableOpacity,\n    View\n} from 'react-native';\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\n\nconst API_BASE_URL = typeof window !== 'undefined' && window.location.hostname === 'localhost'\n  ? \"http://localhost:3001\"\n  : \"https://reseausocial-production.up.railway.app\";\n\n// Types\ninterface UserInfo {\n  id: number;\n  uuid: string;\n  username: string;\n  surnom: string;\n  first_name: string;\n  last_name: string;\n  photo_profil_url?: string;\n}\n\ninterface Connection {\n  id: number;\n  uuid: string;\n  username: string;\n  surnom: string;\n  first_name: string;\n  last_name: string;\n  photo_profil_url?: string;\n  statut_relation: string;\n}\n\ninterface Invitation {\n  id: number;\n  uuid: string;\n  demandeur_info: UserInfo;\n  destinataire_info: UserInfo;\n  statut: string;\n  message: string;\n  date_demande: string;\n  date_reponse?: string;\n}\n\ninterface GroupInvitation {\n  id: number;\n  uuid: string;\n  group: {\n    uuid: string;\n    name: string;\n    description?: string;\n    member_count?: number;\n  };\n  created_by: {\n    uuid: string;\n    username: string;\n    surnom?: string;\n  };\n  status: string;\n  message?: string;\n  created_at: string;\n  is_expired?: boolean;\n}\n\nexport default function FriendsScreen() {\n  const { makeAuthenticatedRequest } = useAuth();\n  const insets = useSafeAreaInsets();\n  \n  const [connections, setConnections] = useState<Connection[]>([]);\n  const [invitations, setInvitations] = useState<Invitation[]>([]);\n  const [groupInvitations, setGroupInvitations] = useState<GroupInvitation[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const [activeTab, setActiveTab] = useState<'friends' | 'invitations' | 'groupInvitations'>('friends');\n  const [processingIds, setProcessingIds] = useState<Set<number>>(new Set());\n\n  const fetchConnections = useCallback(async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/my-connections/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        setConnections(data.connexions || []);\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des connexions:', error);\n    }\n  }, [makeAuthenticatedRequest]);\n\n  const fetchInvitations = useCallback(async () => {\n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/pending/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        setInvitations(data.demandes || []);\n      }\n    } catch (error) {\n      console.error('Erreur lors du chargement des invitations:', error);\n    }\n  }, [makeAuthenticatedRequest]);\n\n  const fetchGroupInvitations = useCallback(async () => {\n    try {\n      console.log('üì® Chargement invitations de groupe...');\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/invitations/received/`\n      );\n      if (response.ok) {\n        const data = await response.json();\n        console.log('‚úÖ Invitations de groupe re√ßues:', data.length);\n        console.log('üìã Invitations d√©tails:', data);\n        // Filtrer les invitations expir√©es\n        const activeInvitations = data.filter((inv: GroupInvitation) => !inv.is_expired);\n        console.log('‚úÖ Invitations actives:', activeInvitations.length);\n        setGroupInvitations(activeInvitations || []);\n      } else {\n        console.error('‚ùå Erreur chargement invitations groupe:', response.status);\n      }\n    } catch (error) {\n      console.error('‚ùå Erreur lors du chargement des invitations de groupe:', error);\n    }\n  }, [makeAuthenticatedRequest]);\n\n  const fetchData = useCallback(async () => {\n    try {\n      setLoading(true);\n      await Promise.all([fetchConnections(), fetchInvitations(), fetchGroupInvitations()]);\n    } finally {\n      setLoading(false);\n      setRefreshing(false);\n    }\n  }, [fetchConnections, fetchInvitations, fetchGroupInvitations]);\n\n  useEffect(() => {\n    fetchData();\n  }, [fetchData]);\n\n  const onRefresh = () => {\n    setRefreshing(true);\n    fetchData();\n  };\n\n  const handleInvitationResponse = async (invitationId: number, action: 'acceptee' | 'refusee', senderName: string) => {\n    setProcessingIds(prev => new Set(prev).add(invitationId));\n    \n    try {\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/relations/connections/${invitationId}/`,\n        {\n          method: 'PATCH',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            statut: action,\n          }),\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error(`Erreur ${response.status}`);\n      }\n\n      // Retirer l'invitation de la liste\n      setInvitations(prev => prev.filter(inv => inv.id !== invitationId));\n      \n      // Si accept√©e, recharger les connexions\n      if (action === 'acceptee') {\n        await fetchConnections();\n        Alert.alert(\n          'Demande accept√©e',\n          `Vous √™tes maintenant connect√© avec ${senderName} !`\n        );\n      } else {\n        Alert.alert(\n          'Demande refus√©e',\n          `La demande de ${senderName} a √©t√© refus√©e.`\n        );\n      }\n    } catch (error) {\n      console.error('Erreur lors de la r√©ponse √† l\\'invitation:', error);\n      Alert.alert(\n        'Erreur',\n        'Impossible de traiter la demande. Veuillez r√©essayer.'\n      );\n    } finally {\n      setProcessingIds(prev => {\n        const newSet = new Set(prev);\n        newSet.delete(invitationId);\n        return newSet;\n      });\n    }\n  };\n\n  const handleGroupInvitationResponse = async (invitationUuid: string, action: 'accept' | 'decline', groupName: string) => {\n    setProcessingIds(prev => new Set(prev).add(invitationUuid as any));\n    \n    try {\n      console.log(`üì® ${action === 'accept' ? 'Acceptation' : 'Refus'} invitation groupe:`, invitationUuid);\n      const response = await makeAuthenticatedRequest(\n        `${API_BASE_URL}/groups/invitations/${invitationUuid}/respond/`,\n        {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            action: action\n          })\n        }\n      );\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        console.error('‚ùå Erreur r√©ponse invitation:', errorData);\n        throw new Error(`Erreur ${response.status}`);\n      }\n\n      // Retirer l'invitation de la liste\n      setGroupInvitations(prev => prev.filter(inv => inv.uuid !== invitationUuid));\n      \n      if (action === 'accept') {\n        Alert.alert(\n          'Invitation accept√©e',\n          `Vous avez rejoint le groupe \"${groupName}\" !`,\n          [{ \n            text: 'OK', \n            onPress: () => {\n              // Retourner √† la page conversations pour voir le nouveau groupe\n              console.log('üîÑ Navigation vers conversations pour recharger les groupes');\n              router.push('/(tabs)/conversations');\n            }\n          }]\n        );\n      } else {\n        Alert.alert(\n          'Invitation refus√©e',\n          `L'invitation au groupe \"${groupName}\" a √©t√© refus√©e.`\n        );\n      }\n      \n      console.log('‚úÖ Invitation trait√©e avec succ√®s');\n    } catch (error) {\n      console.error('‚ùå Erreur lors de la r√©ponse √† l\\'invitation de groupe:', error);\n      Alert.alert(\n        'Erreur',\n        'Impossible de traiter l\\'invitation. Veuillez r√©essayer.'\n      );\n    } finally {\n      setProcessingIds(prev => {\n        const newSet = new Set(prev);\n        newSet.delete(invitationUuid as any);\n        return newSet;\n      });\n    }\n  };\n\n  const handleRemoveFriend = (connectionId: number, userName: string) => {\n    Alert.alert(\n      'Supprimer un ami',\n      `Voulez-vous vraiment supprimer ${userName} de vos amis ?`,\n      [\n        {\n          text: 'Annuler',\n          style: 'cancel'\n        },\n        {\n          text: 'Supprimer',\n          style: 'destructive',\n          onPress: async () => {\n            try {\n              // Supprimer la connexion via l'API\n              const response = await makeAuthenticatedRequest(\n                `${API_BASE_URL}/relations/connections/${connectionId}/`,\n                {\n                  method: 'DELETE',\n                }\n              );\n\n              if (!response.ok) {\n                throw new Error(`Erreur ${response.status}`);\n              }\n\n              // Retirer de la liste locale\n              setConnections(prev => prev.filter(c => c.id !== connectionId));\n              \n              Alert.alert(\n                'Ami supprim√©',\n                `${userName} a √©t√© retir√© de vos amis.`\n              );\n            } catch (error) {\n              console.error('Erreur lors de la suppression:', error);\n              Alert.alert(\n                'Erreur',\n                'Impossible de supprimer cet ami. Veuillez r√©essayer.'\n              );\n            }\n          }\n        }\n      ]\n    );\n  };\n\n  if (loading) {\n    return (\n      <View style={styles.loadingContainer}>\n        <ActivityIndicator size=\"large\" color={ECHO_COLOR} />\n      </View>\n    );\n  }\n\n  return (\n    <View style={[styles.container, { paddingTop: insets.top }]}>\n      {/* Header harmonis√© */}\n      <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>\n        <Ionicons name=\"chevron-back\" size={24} color=\"#fff\" />\n      </TouchableOpacity>\n      \n      <View style={styles.header}>\n        <Ionicons name=\"people\" size={20} color=\"#fff\" />\n        <Text style={styles.headerTitle}>Mes Connexions</Text>\n      </View>\n\n      {/* Tabs */}\n      <View style={styles.tabsContainer}>\n        <TouchableOpacity\n          style={[styles.tab, activeTab === 'friends' && styles.tabActive]}\n          onPress={() => setActiveTab('friends')}\n          activeOpacity={0.7}\n        >\n          <Ionicons\n            name=\"people\"\n            size={18}\n            color={activeTab === 'friends' ? '#fff' : ECHO_COLOR}\n          />\n          <Text style={[styles.tabText, activeTab === 'friends' && styles.tabTextActive]}>\n            Amis ({connections.length})\n          </Text>\n        </TouchableOpacity>\n\n        <TouchableOpacity\n          style={[styles.tab, activeTab === 'invitations' && styles.tabActive]}\n          onPress={() => setActiveTab('invitations')}\n          activeOpacity={0.7}\n        >\n          <Ionicons\n            name=\"mail\"\n            size={18}\n            color={activeTab === 'invitations' ? '#fff' : ECHO_COLOR}\n          />\n          <Text style={[styles.tabText, activeTab === 'invitations' && styles.tabTextActive]}>\n            Invitations ({invitations.length})\n          </Text>\n          {invitations.length > 0 && (\n            <View style={styles.badge}>\n              <Text style={styles.badgeText}>{invitations.length}</Text>\n            </View>\n          )}\n        </TouchableOpacity>\n\n        <TouchableOpacity\n          style={[styles.tab, activeTab === 'groupInvitations' && styles.tabActive]}\n          onPress={() => setActiveTab('groupInvitations')}\n          activeOpacity={0.7}\n        >\n          <Ionicons\n            name=\"people-circle\"\n            size={18}\n            color={activeTab === 'groupInvitations' ? '#fff' : ECHO_COLOR}\n          />\n          <Text style={[styles.tabText, activeTab === 'groupInvitations' && styles.tabTextActive]}>\n            Groupes ({groupInvitations.length})\n          </Text>\n          {groupInvitations.length > 0 && (\n            <View style={styles.badge}>\n              <Text style={styles.badgeText}>{groupInvitations.length}</Text>\n            </View>\n          )}\n        </TouchableOpacity>\n      </View>\n\n      {/* Content */}\n      <ScrollView\n        style={styles.scrollView}\n        contentContainerStyle={styles.scrollContent}\n        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}\n        showsVerticalScrollIndicator={false}\n      >\n        {activeTab === 'friends' ? (\n          // Liste des amis\n          connections.length === 0 ? (\n            <View style={styles.emptyState}>\n              <Ionicons name=\"people-outline\" size={64} color=\"#ccc\" />\n              <Text style={styles.emptyTitle}>Aucun ami</Text>\n              <Text style={styles.emptyText}>\n                Recherchez des personnes dans l'onglet Conversations pour envoyer des demandes de connexion\n              </Text>\n            </View>\n          ) : (\n            connections.map((connection) => (\n              <View key={connection.uuid} style={styles.card}>\n                <View style={styles.cardContent}>\n                  {connection.photo_profil_url ? (\n                    <Image\n                      source={{ uri: connection.photo_profil_url }}\n                      style={styles.avatar}\n                    />\n                  ) : (\n                    <DefaultAvatar\n                      name={connection.surnom || connection.username}\n                      size={56}\n                    />\n                  )}\n                  <View style={styles.cardInfo}>\n                    <Text style={styles.cardName}>\n                      {connection.surnom || connection.username}\n                    </Text>\n                    {connection.surnom && connection.username !== connection.surnom && (\n                      <Text style={styles.cardUsername}>@{connection.username}</Text>\n                    )}\n                  </View>\n                  <TouchableOpacity\n                    style={styles.deleteButton}\n                    onPress={() => handleRemoveFriend(connection.id, connection.surnom || connection.username)}\n                  >\n                    <Ionicons name=\"trash-outline\" size={20} color=\"#ff4444\" />\n                  </TouchableOpacity>\n                </View>\n              </View>\n            ))\n          )\n        ) : activeTab === 'invitations' ? (\n          // Liste des invitations\n          invitations.length === 0 ? (\n            <View style={styles.emptyState}>\n              <Ionicons name=\"mail-outline\" size={64} color=\"#ccc\" />\n              <Text style={styles.emptyTitle}>Aucune invitation</Text>\n              <Text style={styles.emptyText}>\n                Vous n'avez pas de demandes de connexion en attente\n              </Text>\n            </View>\n          ) : (\n            invitations.map((invitation) => {\n              const isProcessing = processingIds.has(invitation.id);\n              const sender = invitation.demandeur_info;\n              \n              return (\n                <View key={invitation.id} style={styles.invitationCard}>\n                  <View style={styles.cardContent}>\n                    {sender.photo_profil_url ? (\n                      <Image\n                        source={{ uri: sender.photo_profil_url }}\n                        style={styles.avatar}\n                      />\n                    ) : (\n                      <DefaultAvatar\n                        name={sender.surnom || sender.username}\n                        size={56}\n                      />\n                    )}\n                    <View style={styles.cardInfo}>\n                      <Text style={styles.cardName}>\n                        {sender.surnom || sender.username}\n                      </Text>\n                      {sender.surnom && sender.username !== sender.surnom && (\n                        <Text style={styles.cardUsername}>@{sender.username}</Text>\n                      )}\n                      {invitation.message && (\n                        <Text style={styles.invitationMessage} numberOfLines={2}>\n                          {invitation.message}\n                        </Text>\n                      )}\n                    </View>\n                  </View>\n                  \n                  {isProcessing ? (\n                    <View style={styles.actionsContainer}>\n                      <ActivityIndicator size=\"small\" color={ECHO_COLOR} />\n                    </View>\n                  ) : (\n                    <View style={styles.actionsContainer}>\n                      <TouchableOpacity\n                        style={styles.acceptButton}\n                        onPress={() =>\n                          handleInvitationResponse(\n                            invitation.id,\n                            'acceptee',\n                            sender.surnom || sender.username\n                          )\n                        }\n                      >\n                        <Ionicons name=\"checkmark\" size={20} color=\"#fff\" />\n                        <Text style={styles.acceptButtonText}>Accepter</Text>\n                      </TouchableOpacity>\n                      \n                      <TouchableOpacity\n                        style={styles.rejectButton}\n                        onPress={() =>\n                          handleInvitationResponse(\n                            invitation.id,\n                            'refusee',\n                            sender.surnom || sender.username\n                          )\n                        }\n                      >\n                        <Ionicons name=\"close\" size={20} color=\"#666\" />\n                        <Text style={styles.rejectButtonText}>Refuser</Text>\n                      </TouchableOpacity>\n                    </View>\n                  )}\n                </View>\n              );\n            })\n          )\n        ) : activeTab === 'groupInvitations' ? (\n          // Liste des invitations de groupe\n          groupInvitations.length === 0 ? (\n            <View style={styles.emptyState}>\n              <Ionicons name=\"people-circle-outline\" size={64} color=\"#ccc\" />\n              <Text style={styles.emptyTitle}>Aucune invitation de groupe</Text>\n              <Text style={styles.emptyText}>\n                Vous n'avez pas d'invitations de groupe en attente\n              </Text>\n            </View>\n          ) : (\n            groupInvitations.map((invitation) => {\n              const isProcessing = processingIds.has(invitation.uuid as any);\n              \n              return (\n                <View key={invitation.uuid} style={styles.invitationCard}>\n                  <View style={styles.cardContent}>\n                    <View style={{\n                      width: 56,\n                      height: 56,\n                      borderRadius: 28,\n                      backgroundColor: 'rgba(10, 145, 104, 0.15)',\n                      justifyContent: 'center',\n                      alignItems: 'center',\n                    }}>\n                      <Ionicons name=\"people\" size={28} color=\"rgba(10, 145, 104, 1)\" />\n                    </View>\n                    <View style={styles.cardInfo}>\n                      <Text style={styles.cardName}>\n                        {invitation.group.name}\n                      </Text>\n                      <Text style={styles.cardUsername}>\n                        Invit√© par {invitation.created_by?.surnom || invitation.created_by?.username || 'Inconnu'}\n                      </Text>\n                      {invitation.message && (\n                        <Text style={styles.invitationMessage} numberOfLines={2}>\n                          {invitation.message}\n                        </Text>\n                      )}\n                      {invitation.is_expired && (\n                        <Text style={{ fontSize: 12, color: '#ff6b6b', marginTop: 4 }}>\n                          ‚ö†Ô∏è Invitation expir√©e\n                        </Text>\n                      )}\n                      {invitation.group.member_count !== undefined && (\n                        <Text style={styles.cardUsername}>\n                          {invitation.group.member_count} membre{invitation.group.member_count > 1 ? 's' : ''}\n                        </Text>\n                      )}\n                    </View>\n                  </View>\n                  \n                  {isProcessing ? (\n                    <View style={styles.actionsContainer}>\n                      <ActivityIndicator size=\"small\" color={ECHO_COLOR} />\n                    </View>\n                  ) : (\n                    <View style={styles.actionsContainer}>\n                      <TouchableOpacity\n                        style={styles.acceptButton}\n                        onPress={() =>\n                          handleGroupInvitationResponse(\n                            invitation.uuid,\n                            'accept',\n                            invitation.group.name\n                          )\n                        }\n                      >\n                        <Ionicons name=\"checkmark\" size={20} color=\"#fff\" />\n                        <Text style={styles.acceptButtonText}>Accepter</Text>\n                      </TouchableOpacity>\n                      <TouchableOpacity\n                        style={styles.rejectButton}\n                        onPress={() =>\n                          handleGroupInvitationResponse(\n                            invitation.uuid,\n                            'decline',\n                            invitation.group.name\n                          )\n                        }\n                      >\n                        <Ionicons name=\"close\" size={20} color=\"#666\" />\n                        <Text style={styles.rejectButtonText}>Refuser</Text>\n                      </TouchableOpacity>\n                    </View>\n                  )}\n                </View>\n              );\n            })\n          )\n        ) : null}\n      </ScrollView>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: BACKGROUND_GRAY,\n  },\n  container: {\n    flex: 1,\n    backgroundColor: BACKGROUND_GRAY,\n  },\n  backButton: {\n    position: 'absolute',\n    top: 65,\n    left: 20,\n    width: 40,\n    height: 40,\n    borderRadius: 20,\n    backgroundColor: 'rgba(10, 145, 104, 0.9)',\n    alignItems: 'center',\n    justifyContent: 'center',\n    zIndex: 20,\n    shadowColor: 'rgba(10, 145, 104, 0.4)',\n    shadowOffset: { width: 0, height: 4 },\n    shadowOpacity: 0.5,\n    shadowRadius: 8,\n    elevation: 8,\n  },\n  header: {\n    position: 'absolute',\n    top: 65,\n    left: 75,\n    right: 20,\n    height: 40,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    gap: 8,\n    paddingHorizontal: 16,\n    borderRadius: 20,\n    backgroundColor: 'rgba(10, 145, 104, 0.9)',\n    zIndex: 10,\n    shadowColor: 'rgba(10, 145, 104, 0.4)',\n    shadowOffset: { width: 0, height: 4 },\n    shadowOpacity: 0.5,\n    shadowRadius: 8,\n    elevation: 8,\n  },\n  headerTitle: {\n    fontSize: 15,\n    fontWeight: '600',\n    color: '#fff',\n  },\n  tabsContainer: {\n    flexDirection: 'row',\n    paddingHorizontal: 16,\n    paddingTop: 105,\n    paddingBottom: 12,\n    gap: 8,\n  },\n  tab: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 12,\n    paddingHorizontal: 16,\n    borderRadius: 16,\n    backgroundColor: 'white',\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 6,\n    elevation: 2,\n  },\n  tabActive: {\n    backgroundColor: ECHO_COLOR,\n    shadowColor: ECHO_COLOR,\n    shadowOpacity: 0.3,\n    shadowRadius: 8,\n  },\n  tabText: {\n    marginLeft: 8,\n    fontSize: 14,\n    fontWeight: '600',\n    color: ECHO_COLOR,\n  },\n  tabTextActive: {\n    color: '#fff',\n  },\n  badge: {\n    position: 'absolute',\n    top: 6,\n    right: 6,\n    backgroundColor: '#ff4444',\n    borderRadius: 10,\n    minWidth: 20,\n    height: 20,\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingHorizontal: 6,\n  },\n  badgeText: {\n    color: '#fff',\n    fontSize: 11,\n    fontWeight: '700',\n  },\n  scrollView: {\n    flex: 1,\n  },\n  scrollContent: {\n    padding: 16,\n    paddingBottom: 40,\n  },\n  card: {\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    marginBottom: 12,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 2,\n  },\n  invitationCard: {\n    backgroundColor: 'white',\n    borderRadius: 16,\n    padding: 16,\n    marginBottom: 12,\n    shadowColor: '#000',\n    shadowOpacity: 0.08,\n    shadowOffset: { width: 0, height: 2 },\n    shadowRadius: 8,\n    elevation: 2,\n  },\n  cardContent: {\n    flexDirection: 'row',\n    alignItems: 'center',\n  },\n  avatar: {\n    width: 56,\n    height: 56,\n    borderRadius: 28,\n    marginRight: 12,\n  },\n  cardInfo: {\n    flex: 1,\n  },\n  cardName: {\n    fontSize: 16,\n    fontWeight: '700',\n    color: '#1b5e20',\n    marginBottom: 2,\n  },\n  cardUsername: {\n    fontSize: 13,\n    color: '#6c8a6e',\n  },\n  invitationMessage: {\n    fontSize: 13,\n    color: '#6c8a6e',\n    marginTop: 4,\n    fontStyle: 'italic',\n  },\n  deleteButton: {\n    width: 44,\n    height: 44,\n    borderRadius: 22,\n    backgroundColor: '#fff0f0',\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  actionsContainer: {\n    flexDirection: 'row',\n    marginTop: 12,\n    gap: 8,\n    justifyContent: 'center',\n  },\n  acceptButton: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 10,\n    paddingHorizontal: 16,\n    borderRadius: 12,\n    backgroundColor: ECHO_COLOR,\n  },\n  acceptButtonText: {\n    marginLeft: 6,\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#fff',\n  },\n  rejectButton: {\n    flex: 1,\n    flexDirection: 'row',\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 10,\n    paddingHorizontal: 16,\n    borderRadius: 12,\n    backgroundColor: '#f5f5f5',\n  },\n  rejectButtonText: {\n    marginLeft: 6,\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#666',\n  },\n  emptyState: {\n    alignItems: 'center',\n    justifyContent: 'center',\n    paddingVertical: 60,\n    paddingHorizontal: 40,\n  },\n  emptyTitle: {\n    fontSize: 20,\n    fontWeight: '700',\n    color: '#333',\n    marginTop: 16,\n    marginBottom: 8,\n  },\n  emptyText: {\n    fontSize: 14,\n    color: '#6c8a6e',\n    textAlign: 'center',\n    lineHeight: 20,\n  },\n});\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/(tabs)/index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/+not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/_layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/edit-profile.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/app/index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/BottomBar.tsx","messages":[{"ruleId":"@typescript-eslint/array-type","severity":1,"message":"Array type using 'Array<T>' is forbidden. Use 'T[]' instead.","line":68,"column":56,"nodeType":"TSTypeReference","messageId":"errorStringArray","endLine":68,"endColumn":122,"fix":{"range":[2351,2417],"text":"{ id: number; role: 'user' | 'assistant'; content: string }[]"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'jarvisAgentUuid' is assigned a value but never used.","line":69,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":69,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setJarvisAgentUuid' is assigned a value but never used.","line":69,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":69,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isJarvisInputFocused' is assigned a value but never used.","line":70,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":30},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'keyboardOffset'. Either include it or remove the dependency array.","line":114,"column":6,"nodeType":"ArrayExpression","endLine":114,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [keyboardOffset]","fix":{"range":[4158,4160],"text":"[keyboardOffset]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":242,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":242,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'overlayOpacity' is assigned a value but never used.","line":415,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":415,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'blurIntensity' is assigned a value but never used.","line":421,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":421,"endColumn":22},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`'` can be escaped with `&apos;`, `&lsquo;`, `&#39;`, `&rsquo;`.","line":1077,"column":42,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&apos;"},"fix":{"range":[41159,41235],"text":"\n                ‚ú® Swipez pour d√©couvrir d&apos;autres agents IA ‚ú®\n              "},"desc":"Replace with `&apos;`."},{"messageId":"replaceWithAlt","data":{"alt":"&lsquo;"},"fix":{"range":[41159,41235],"text":"\n                ‚ú® Swipez pour d√©couvrir d&lsquo;autres agents IA ‚ú®\n              "},"desc":"Replace with `&lsquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#39;"},"fix":{"range":[41159,41235],"text":"\n                ‚ú® Swipez pour d√©couvrir d&#39;autres agents IA ‚ú®\n              "},"desc":"Replace with `&#39;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rsquo;"},"fix":{"range":[41159,41235],"text":"\n                ‚ú® Swipez pour d√©couvrir d&rsquo;autres agents IA ‚ú®\n              "},"desc":"Replace with `&rsquo;`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { Ionicons } from \"@expo/vector-icons\";\nimport { Audio } from 'expo-av';\nimport * as DocumentPicker from 'expo-document-picker';\nimport * as ImagePicker from 'expo-image-picker';\nimport { LinearGradient } from \"expo-linear-gradient\";\nimport { SymbolView } from \"expo-symbols\";\nimport { useEffect, useRef, useState } from \"react\";\nimport {\n  ActionSheetIOS,\n  Alert,\n  Animated,\n  Dimensions,\n  Keyboard,\n  KeyboardAvoidingView,\n  PanResponder,\n  Platform,\n  ScrollView,\n  Text,\n  TextInput,\n  TouchableOpacity,\n  View\n} from \"react-native\";\nimport { useSafeAreaInsets } from 'react-native-safe-area-context';\nimport { useAuth } from \"../contexts/AuthContext\";\nimport { useChat } from \"../contexts/ChatContext\";\nimport { useNavigation } from \"../contexts/NavigationContext\";\nimport { styles } from \"../styles/appStyles\";\n\ninterface BottomBarProps {\n  currentRoute: string;\n  chatText: string;\n  setChatText: (text: string) => void;\n  chatRecipient?: string;\n  onSendMessage?: () => void;\n  conversationId?: string;\n}\n\nexport default function BottomBar({ \n  currentRoute, \n  chatText, \n  setChatText, \n  chatRecipient = \"\",\n  onSendMessage,\n  conversationId\n}: BottomBarProps) {\n  \n  const insets = useSafeAreaInsets();\n  const isChat = currentRoute.includes(\"conversation-direct\") || currentRoute.includes(\"conversation-group\") || currentRoute.includes(\"conversation-detail\");\n  const { accessToken, makeAuthenticatedRequest } = useAuth();\n  const { navigateToScreen } = useNavigation();\n  const { sendMessage: sendChatMessage, websocket } = useChat();\n  \n  // Dimensions de l'√©cran\n  const screenHeight = Dimensions.get('window').height;\n  // hauteur de l'espace panneau (90% de l'√©cran)\n  const MAX_TRANSLATE = screenHeight * 0.75; // hauteur du panneau\n\n  // translateY du panneau: 0 = ouvert, MAX_TRANSLATE = ferm√© (cach√© sous la barre)\n  const sheetY = useRef(new Animated.Value(MAX_TRANSLATE)).current;\n  const isPanelOpen = useRef(false);\n  const dragStartY = useRef(0);\n\n  const [barHeight, setBarHeight] = useState(96); // default, will be measured\n  const keyboardOffset = useRef(new Animated.Value(0)).current;\n  const [jarvisKeyboardHeight, setJarvisKeyboardHeight] = useState(0);\n  // Jarvis mode ephemeral chat state\n  const [jarvisActive, setJarvisActive] = useState(false);\n  const [jarvisMessages, setJarvisMessages] = useState<Array<{ id: number; role: 'user' | 'assistant'; content: string }>>([]);\n  const [jarvisAgentUuid, setJarvisAgentUuid] = useState<string | null>(null);\n  const [isJarvisInputFocused, setIsJarvisInputFocused] = useState(false);\n  const jarvisScrollRef = useRef<any>(null);\n  const chatInputRef = useRef<TextInput>(null);\n  // Cible d‚Äôenvoi\n  const [sendTarget, setSendTarget] = useState<'chat' | 'jarvis'>(isChat ? 'chat' : 'jarvis');\n  \n  // Animations pour l'effet WOW\n  const particleAnim1 = useRef(new Animated.Value(0)).current;\n  const particleAnim2 = useRef(new Animated.Value(0)).current;\n  const particleAnim3 = useRef(new Animated.Value(0)).current;\n  const glowPulse = useRef(new Animated.Value(0)).current;\n  const scaleAnim = useRef(new Animated.Value(1)).current;\n\n  // Gestion du clavier - monte la bottomBar au-dessus\n  useEffect(() => {\n    const keyboardWillShow = Keyboard.addListener(\n      Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow',\n      (e) => {\n        Animated.timing(keyboardOffset, {\n          toValue: -e.endCoordinates.height,\n          duration: Platform.OS === 'ios' ? 250 : 200,\n          useNativeDriver: true,\n        }).start();\n        setJarvisKeyboardHeight(e.endCoordinates.height || 0);\n        setTimeout(() => jarvisScrollRef.current?.scrollToEnd({ animated: true }), 50);\n      }\n    );\n\n    const keyboardWillHide = Keyboard.addListener(\n      Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide',\n      () => {\n        Animated.timing(keyboardOffset, {\n          toValue: 0,\n          duration: Platform.OS === 'ios' ? 250 : 200,\n          useNativeDriver: true,\n        }).start();\n        setJarvisKeyboardHeight(0);\n      }\n    );\n\n    return () => {\n      keyboardWillShow.remove();\n      keyboardWillHide.remove();\n    };\n  }, []);\n\n  // Debug\n  console.log(\"BottomBar - currentRoute:\", currentRoute, \"isChat:\", isChat);\n  \n  // PanResponder pour g√©rer le swipe\n  const panResponder = useRef(\n    PanResponder.create({\n      onStartShouldSetPanResponder: () => true,\n      onStartShouldSetPanResponderCapture: (_, g) => Math.abs(g.dy) > 3,\n      onMoveShouldSetPanResponder: (_, g) => Math.abs(g.dy) > 6,\n      onMoveShouldSetPanResponderCapture: (_, g) => Math.abs(g.dy) > 6 && Math.abs(g.dy) > Math.abs(g.dx),\n      onPanResponderGrant: () => {\n        // @ts-ignore\n        dragStartY.current = (sheetY as any)._value ?? MAX_TRANSLATE;\n      },\n      onPanResponderMove: (_, g) => {\n        const next = dragStartY.current + g.dy;\n        const clamped = Math.max(0, Math.min(MAX_TRANSLATE, next));\n        sheetY.setValue(clamped);\n      },\n      onPanResponderRelease: (_, g) => {\n        // @ts-ignore\n        const current = (sheetY as any)._value ?? MAX_TRANSLATE;\n        const shouldOpen = current < MAX_TRANSLATE / 2 || g.vy < -0.5;\n        if (shouldOpen) openPanel(); else closePanel();\n      },\n    })\n  ).current;\n\n  const openPanel = () => {\n    isPanelOpen.current = true;\n    Animated.parallel([\n      Animated.spring(sheetY, { toValue: 0, useNativeDriver: true, tension: 50, friction: 8 }),\n      Animated.spring(scaleAnim, { toValue: 1.02, useNativeDriver: true, tension: 40, friction: 7 }),\n    ]).start(() => {\n      Animated.spring(scaleAnim, { toValue: 1, useNativeDriver: true, tension: 50, friction: 8 }).start();\n    });\n  };\n  const closePanel = () => {\n    isPanelOpen.current = false;\n    Animated.parallel([\n      Animated.spring(sheetY, { toValue: MAX_TRANSLATE, useNativeDriver: true, tension: 60, friction: 10 }),\n      Animated.spring(scaleAnim, { toValue: 1, useNativeDriver: true, tension: 50, friction: 8 }),\n    ]).start();\n  };\n\n  const API_BASE_URL = typeof window !== 'undefined' && (window as any).location?.hostname === 'localhost'\n    ? \"http://localhost:3001\"\n    : \"https://reseausocial-production.up.railway.app\";\n\n  // Effacement de l'historique Jarvis\n  const deleteJarvisHistory = async () => {\n    try {\n      const uuid = await resolveJarvisAgentUuid();\n      if (uuid) {\n        // Si l'API ne pr√©voit pas de delete, on tente un POST sp√©cial puis on purge localement\n        await makeAuthenticatedRequest(`${API_BASE_URL}/api/agents/${uuid}/responses/clear/`, { method: 'POST' }).catch(() => null as any);\n      }\n    } catch {}\n    setJarvisMessages([]);\n  };\n\n  // S'assurer qu'√† l'ouverture d'une conversation, on d√©marre en mode message,\n  // et hors conversation on repasse en mode Jarvis\n  useEffect(() => {\n    if (isChat) {\n      setSendTarget('chat');\n      setJarvisActive(false);\n    } else {\n      setSendTarget('jarvis');\n      setJarvisActive(false);\n    }\n  }, [isChat]);\n\n  const handleSendMessage = async () => {\n    if (!chatText.trim()) {\n      console.log(\"‚ö†Ô∏è Message vide, pas d'envoi\");\n      return;\n    }\n\n    try {\n      if (sendTarget === 'chat' && isChat && sendChatMessage) {\n        console.log(\"üì§ Envoi message via WebSocket:\", chatText);\n        sendChatMessage(chatText);\n        setChatText(\"\");\n      } else if (sendTarget === 'jarvis') {\n        if (!jarvisActive) setJarvisActive(true); // activer overlay UNIQUEMENT √† l'envoi\n        const userText = chatText.trim();\n        setJarvisMessages((prev) => [...prev, { id: Date.now(), role: 'user', content: userText }]);\n        setTimeout(() => jarvisScrollRef.current?.scrollToEnd({ animated: true }), 100);\n          setChatText(\"\");\n\n        try {\n          let agentUuid: string | null = null;\n          try {\n            const respAvail = await makeAuthenticatedRequest(`${API_BASE_URL}/api/agents/my-available/`);\n            if (respAvail.ok) {\n              const list = await respAvail.json();\n              const found = (Array.isArray(list) ? list : []).find((a: any) => (a.name || '').toLowerCase().includes('jarvis')) || (Array.isArray(list) ? list[0] : null);\n              if (found?.uuid) agentUuid = found.uuid;\n            }\n          } catch {}\n          if (!agentUuid) {\n            const respAgents = await makeAuthenticatedRequest(`${API_BASE_URL}/api/agents/`);\n            if (respAgents.ok) {\n              const list2 = await respAgents.json();\n              const found2 = (Array.isArray(list2) ? list2 : []).find((a: any) => (a.name || '').toLowerCase().includes('jarvis')) || (Array.isArray(list2) ? list2[0] : null);\n              if (found2?.uuid) agentUuid = found2.uuid;\n            }\n          }\n          if (!agentUuid) {\n            setJarvisMessages((prev) => [...prev, { id: Date.now()+1, role: 'assistant', content: 'Aucun agent disponible.' }]);\n            return;\n          }\n          const respTest = await makeAuthenticatedRequest(`${API_BASE_URL}/api/agents/${agentUuid}/test/`, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({ message: userText }),\n          });\n          if (respTest.ok) {\n            const data = await respTest.json().catch(() => ({} as any));\n            const reply = data.response || data.answer || data.text || '...';\n            setJarvisMessages((prev) => [...prev, { id: Date.now()+2, role: 'assistant', content: String(reply) }]);\n            setTimeout(() => jarvisScrollRef.current?.scrollToEnd({ animated: true }), 100);\n        } else {\n            setJarvisMessages((prev) => [...prev, { id: Date.now()+2, role: 'assistant', content: `Erreur (${respTest.status})`}]);\n          }\n        } catch (e) {\n          setJarvisMessages((prev) => [...prev, { id: Date.now()+2, role: 'assistant', content: 'Erreur r√©seau' }]);\n        }\n      } else {\n        console.warn(\"‚ö†Ô∏è Pas de fonction d'envoi disponible\");\n      }\n    } catch (error) {\n      console.error(\"‚ùå Erreur lors de l'envoi du message:\", error);\n    }\n  };\n\n  // --------- Pi√®ces jointes & Upload ---------\n  const uploadAttachment = async (file: { uri: string; name: string; type: string }): Promise<string | null> => {\n    try {\n      const form = new FormData();\n      // @ts-ignore\n      form.append('file', { uri: file.uri, name: file.name, type: file.type });\n      const resp = await fetch(`${API_BASE_URL}/messaging/attachments/upload/`, {\n        method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Accept': 'application/json' }, body: form,\n      });\n      if (!resp.ok) return null;\n      const data = await resp.json();\n      return data?.uuid || null;\n    } catch {\n      return null;\n    }\n  };\n\n  const sendAttachmentMessage = async (attachmentUuids: string[], caption?: string) => {\n    if (!conversationId) return;\n    const payload: any = { type: 'chat_message', conversation_uuid: conversationId, message: (caption || '').trim(), attachment_uuids: attachmentUuids };\n    try {\n      if (websocket) {\n        websocket.send(JSON.stringify(payload));\n      } else {\n        await fetch(`${API_BASE_URL}/messaging/conversations/${conversationId}/messages/create-with-attachments/`, {\n          method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ content: payload.message, attachment_uuids: attachmentUuids }),\n        });\n      }\n    } catch {}\n  };\n\n  const handlePlus = () => {\n    if (Platform.OS === 'ios') {\n      ActionSheetIOS.showActionSheetWithOptions({ options: ['Annuler', 'Photo', 'Fichier'], cancelButtonIndex: 0 }, (idx) => {\n        if (idx === 1) handlePickPhoto(); else if (idx === 2) handlePickDocument();\n      });\n    } else {\n      Alert.alert('Ajouter', 'Choisissez une option', [\n        { text: 'Photo', onPress: handlePickPhoto },\n        { text: 'Fichier', onPress: handlePickDocument },\n        { text: 'Annuler', style: 'cancel' },\n      ]);\n    }\n  };\n\n  const handlePickPhoto = async () => {\n    try {\n      const perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\n      if (!perm.granted) { Alert.alert('Photos', 'Autorisez l‚Äôacc√®s aux photos.'); return; }\n      const res = await ImagePicker.launchImageLibraryAsync({ mediaTypes: ImagePicker.MediaTypeOptions.Images, quality: 0.8 });\n      if (res.canceled) return;\n      const asset = res.assets?.[0];\n      if (!asset?.uri) return;\n      const name = asset.fileName || `photo_${Date.now()}.jpg`;\n      setStagedAttachments((prev) => [...prev, { uri: asset.uri, name, type: 'image/jpeg', kind: 'image' }]);\n    } catch (e) { console.error('pick photo error', e); }\n  };\n\n  const handlePickDocument = async () => {\n    try {\n      const res = await DocumentPicker.getDocumentAsync({ multiple: false, type: '*/*', copyToCacheDirectory: true });\n      // @ts-ignore\n      if (res.canceled || res.type === 'cancel') return;\n      // SDK variations\n      // @ts-ignore\n      const file = res.assets?.[0] || res;\n      const uri = file.uri;\n      const name = file.name || `file_${Date.now()}`;\n      const mime = file.mimeType || 'application/octet-stream';\n      setStagedAttachments((prev) => [...prev, { uri, name, type: mime, kind: 'file' }]);\n    } catch (e) { console.error('pick doc error', e); }\n  };\n\n  // --------- Message vocal ---------\n  const [recording, setRecording] = useState<Audio.Recording | null>(null);\n  const [recordedUri, setRecordedUri] = useState<string | null>(null);\n  const [isRecording, setIsRecording] = useState(false);\n  const [recordingSeconds, setRecordingSeconds] = useState(0);\n  const recordingTimerRef = useRef<any>(null);\n\n  const startRecording = async () => {\n    try {\n      const perm = await Audio.requestPermissionsAsync();\n      if (!perm.granted) { Alert.alert('Micro', 'Autorisez le micro pour enregistrer.'); return; }\n      await Audio.setAudioModeAsync({ allowsRecordingIOS: true, playsInSilentModeIOS: true });\n      const rec = new Audio.Recording();\n      await rec.prepareToRecordAsync(Audio.RecordingOptionsPresets.HIGH_QUALITY);\n      await rec.startAsync();\n      setRecording(rec);\n      setIsRecording(true);\n      setRecordingSeconds(0);\n      if (recordingTimerRef.current) clearInterval(recordingTimerRef.current);\n      recordingTimerRef.current = setInterval(() => setRecordingSeconds((s) => s + 1), 1000);\n    } catch (e) {\n      console.error('startRecording error', e);\n    }\n  };\n\n  const stopRecording = async () => {\n    try {\n      if (!recording) return;\n      await recording.stopAndUnloadAsync();\n      const uri = recording.getURI();\n      setRecording(null);\n      setIsRecording(false);\n      if (uri) setRecordedUri(uri);\n      if (recordingTimerRef.current) {\n        clearInterval(recordingTimerRef.current);\n        recordingTimerRef.current = null;\n      }\n    } catch (e) {\n      console.error('stopRecording error', e);\n    }\n  };\n\n  const cancelRecorded = () => {\n    setRecordedUri(null);\n    setRecordingSeconds(0);\n  };\n\n  const sendRecorded = async () => {\n    if (!recordedUri) return;\n    const uuid = await uploadAttachment({ uri: recordedUri, name: `voice_${Date.now()}.m4a`, type: 'audio/m4a' });\n    if (uuid) await sendAttachmentMessage([uuid]);\n    setRecordedUri(null);\n    setRecordingSeconds(0);\n  };\n\n  // --------- Staging visuel des PJ ---------\n  type StagedAttachment = { uri: string; name: string; type: string; kind: 'image' | 'file' };\n  const [stagedAttachments, setStagedAttachments] = useState<StagedAttachment[]>([]);\n  const removeStagedAt = (index: number) => {\n    setStagedAttachments((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const handleSend = async () => {\n    if (recordedUri) { await sendRecorded(); return; }\n    if (stagedAttachments.length > 0) {\n      try {\n        const uuids: string[] = [];\n        for (const att of stagedAttachments) {\n          const u = await uploadAttachment({ uri: att.uri, name: att.name, type: att.type });\n          if (u) uuids.push(u);\n        }\n        if (uuids.length > 0) {\n          await sendAttachmentMessage(uuids, chatText.trim());\n          setChatText(\"\");\n          setStagedAttachments([]);\n        }\n      } catch (e) { console.error('send attachments error', e); }\n      return;\n    }\n    await handleSendMessage();\n  };\n\n  // Calcul de l'opacit√© et autres interpolations\n  const blurOpacity = sheetY.interpolate({\n    inputRange: [0, MAX_TRANSLATE],\n    outputRange: [1, 0],\n    extrapolate: 'clamp',\n  });\n\n  const overlayOpacity = sheetY.interpolate({\n    inputRange: [0, MAX_TRANSLATE],\n    outputRange: [0.6, 0],\n    extrapolate: 'clamp',\n  });\n\n  const blurIntensity = sheetY.interpolate({\n    inputRange: [0, MAX_TRANSLATE],\n    outputRange: [20, 0],\n    extrapolate: 'clamp',\n  });\n\n  // Animations des particules\n  const particle1Y = particleAnim1.interpolate({\n    inputRange: [0, 1],\n    outputRange: [0, -100],\n  });\n\n  const particle2Y = particleAnim2.interpolate({\n    inputRange: [0, 1],\n    outputRange: [0, -150],\n  });\n\n  const particle3Y = particleAnim3.interpolate({\n    inputRange: [0, 1],\n    outputRange: [0, -80],\n  });\n\n  const particle1Opacity = particleAnim1.interpolate({\n    inputRange: [0, 0.5, 1],\n    outputRange: [0, 1, 0],\n  });\n\n  const particle2Opacity = particleAnim2.interpolate({\n    inputRange: [0, 0.5, 1],\n    outputRange: [0, 0.8, 0],\n  });\n\n  const particle3Opacity = particleAnim3.interpolate({\n    inputRange: [0, 0.5, 1],\n    outputRange: [0, 0.9, 0],\n  });\n\n  const glowScale = glowPulse.interpolate({\n    inputRange: [0, 1],\n    outputRange: [1, 1.3],\n  });\n\n  const glowOpacity = glowPulse.interpolate({\n    inputRange: [0, 1],\n    outputRange: [0.3, 0.7],\n  });\n\n  return (\n    <>\n      {/* Overlay Jarvis (absolute, sous la BottomBar) */}\n      {jarvisActive && (\n        <>\n          {/* Fond assombri derri√®re les messages et sous la BottomBar */}\n          <View style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, zIndex: 9000 }} pointerEvents=\"auto\">\n            <TouchableOpacity\n              activeOpacity={1}\n              onPress={() => { setIsJarvisInputFocused(false); setJarvisActive(false); Keyboard.dismiss(); }}\n              style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.6)' }}\n            />\n          </View>\n\n          {/* Contenu Jarvis √©vitant le clavier, toujours sous la BottomBar */}\n          <KeyboardAvoidingView\n            behavior={Platform.OS === 'ios' ? 'padding' : 'height'}\n            keyboardVerticalOffset={insets.top}\n            style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: barHeight, zIndex: 9500 }}\n            pointerEvents=\"box-none\"\n          >\n            {/* Bandeau top */}\n            <View style={{ position: 'absolute', top: insets.top + 6, left: 0, right: 0, height: 56, paddingHorizontal: 14, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\n              <Text style={{ fontWeight: '700', color: 'white', fontSize: 16 }}>Jarvis</Text>\n              <TouchableOpacity onPress={async () => { await deleteJarvisHistory(); }}>\n                {Platform.OS === 'ios' ? (\n                  <SymbolView name=\"trash.fill\" size={20} tintColor=\"#ff6b6b\" type=\"hierarchical\" />\n                ) : (\n                  <Ionicons name=\"trash\" size={20} color=\"#ff6b6b\" />\n                )}\n              </TouchableOpacity>\n            </View>\n\n            {/* Messages scrollables */}\n            <View style={{ position: 'absolute', top: insets.top + 70, left: 0, right: 0, bottom: 0, paddingHorizontal: 14 }} pointerEvents=\"box-none\">\n              <ScrollView ref={jarvisScrollRef} showsVerticalScrollIndicator={false} contentContainerStyle={{ paddingBottom: barHeight + jarvisKeyboardHeight + 12 }}>\n                {jarvisMessages.map((m) => (\n                  <View key={m.id} style={{ marginVertical: 6, alignItems: m.role === 'user' ? 'flex-end' : 'flex-start' }}>\n                    <View style={[\n                      styles.messageBubble,\n                      m.role === 'user' ? styles.myMessage : styles.theirMessage,\n                    ]}>\n                      <Text style={[styles.messageText, m.role === 'user' ? styles.myMessageText : styles.theirMessageText]}>\n                        {m.content}\n                      </Text>\n                    </View>\n                  </View>\n                ))}\n              </ScrollView>\n            </View>\n          </KeyboardAvoidingView>\n        </>\n      )}\n\n      <Animated.View\n        style={{ \n          position: 'absolute', \n          bottom: 0, \n          left: 0, \n          right: 0, \n          zIndex: 9999,\n          transform: [{ translateY: keyboardOffset }],\n        }}\n      >\n        {/* Particules lumineuses myst√©rieuses - seulement visibles quand le panneau est ouvert */}\n        <Animated.View\n          pointerEvents=\"none\"\n          style={{\n            position: 'absolute',\n            left: '20%',\n            bottom: 150,\n            opacity: Animated.multiply(blurOpacity, particle1Opacity),\n            transform: [{ translateY: particle1Y }],\n          }}\n        >\n          <View\n            style={{\n              width: 60,\n              height: 60,\n              borderRadius: 30,\n              backgroundColor: 'rgba(10, 145, 104, 0.4)',\n              shadowColor: 'rgba(10, 145, 104, 1)',\n              shadowOpacity: 0.8,\n              shadowRadius: 20,\n              elevation: 10,\n            }}\n          />\n        </Animated.View>\n\n        <Animated.View\n          pointerEvents=\"none\"\n          style={{\n            position: 'absolute',\n            right: '15%',\n            bottom: 180,\n            opacity: Animated.multiply(blurOpacity, particle2Opacity),\n            transform: [{ translateY: particle2Y }],\n          }}\n        >\n          <View\n            style={{\n              width: 40,\n              height: 40,\n              borderRadius: 20,\n              backgroundColor: 'rgba(10, 145, 104, 0.5)',\n              shadowColor: 'rgba(10, 145, 104, 1)',\n              shadowOpacity: 0.9,\n              shadowRadius: 15,\n              elevation: 10,\n            }}\n          />\n        </Animated.View>\n\n        <Animated.View\n          pointerEvents=\"none\"\n          style={{\n            position: 'absolute',\n            left: '60%',\n            bottom: 200,\n            opacity: Animated.multiply(blurOpacity, particle3Opacity),\n            transform: [{ translateY: particle3Y }],\n          }}\n        >\n          <View\n            style={{\n              width: 50,\n              height: 50,\n              borderRadius: 25,\n              backgroundColor: 'rgba(10, 145, 104, 0.35)',\n              shadowColor: 'rgba(10, 145, 104, 1)',\n              shadowOpacity: 0.7,\n              shadowRadius: 18,\n              elevation: 10,\n            }}\n          />\n        </Animated.View>\n\n        {/* Effet de lueur pulsante derri√®re le panneau */}\n        <Animated.View\n          pointerEvents=\"none\"\n          style={{\n            position: 'absolute',\n            left: 0,\n            right: 0,\n            bottom: 0,\n            height: 250,\n            opacity: blurOpacity,\n            zIndex: 500,\n          }}\n        >\n          <Animated.View\n            style={{\n              flex: 1,\n              opacity: glowOpacity,\n              transform: [{ scale: glowScale }],\n            }}\n          >\n            <LinearGradient\n              colors={[\n                'rgba(10, 145, 104, 0)',\n                'rgba(10, 145, 104, 0.1)',\n                'rgba(10, 145, 104, 0.3)',\n                'rgba(10, 145, 104, 0.5)',\n              ]}\n              style={{ flex: 1 }}\n              start={{ x: 0, y: 0 }}\n              end={{ x: 0, y: 1 }}\n            />\n          </Animated.View>\n        </Animated.View>\n\n        {/* Gradient principal myst√©rieux */}\n        <Animated.View\n          pointerEvents=\"none\"\n          style={{\n            position: 'absolute',\n            left: 0,\n            right: 0,\n            bottom: 0,\n            height: 200,\n            opacity: blurOpacity,\n            zIndex: 1000,\n          }}\n        >\n          <LinearGradient\n            colors={[\n              'rgba(10, 145, 104, 0)',\n              'rgba(10, 145, 104, 0.0)',\n              'rgba(10, 145, 104, 0.2)',\n              'rgba(10, 145, 104, 0.4)',\n            ]}\n            style={{ flex: 1 }}\n            start={{ x: 0, y: 0 }}\n            end={{ x: 0, y: 1 }}\n          />\n        </Animated.View>\n\n        {/* Panneau coulissant pour la gestion des agents IA - avec effet de profondeur */}\n        <Animated.View\n          style={{\n            position: 'absolute',\n            left: 0,\n            right: 0,\n            bottom: 0,\n            height: MAX_TRANSLATE,\n            backgroundColor: 'white',\n            shadowColor: 'rgba(10, 145, 104, 0.6)',\n            shadowOffset: { width: 0, height: -4 },\n            shadowOpacity: 0.5,\n            shadowRadius: 20,\n            elevation: 15,\n            transform: [\n              { translateY: sheetY },\n              { scale: scaleAnim },\n            ],\n          }}\n        >\n          {/* Jarvis messages overlay (√©ph√©m√®re) */}\n          {jarvisActive && (\n            <View style={{ position: 'absolute', left: 0, right: 0, top: 0, bottom: barHeight + 6, paddingHorizontal: 14, paddingTop: 80, pointerEvents: 'box-none' }}>\n              <ScrollView ref={jarvisScrollRef} showsVerticalScrollIndicator={false} contentContainerStyle={{ paddingBottom: 12 }}>\n                {jarvisMessages.map((m) => (\n                  <View key={m.id} style={{ marginVertical: 6, alignItems: m.role === 'user' ? 'flex-end' : 'flex-start' }}>\n                    <View style={[\n                      styles.messageBubble,\n                      m.role === 'user' ? styles.myMessage : styles.theirMessage,\n                    ]}>\n                      <Text style={[styles.messageText, m.role === 'user' ? styles.myMessageText : styles.theirMessageText]}>\n                        {m.content}\n                      </Text>\n                    </View>\n                  </View>\n                ))}\n              </ScrollView>\n            </View>\n          )}\n\n          {/* Bordure lumineuse en haut du panneau - effet dimension parall√®le */}\n          <Animated.View\n            pointerEvents=\"none\"\n            style={{\n              position: 'absolute',\n              top: 0,\n              left: 0,\n              right: 0,\n              height: 3,\n              opacity: blurOpacity,\n              zIndex: 1,\n            }}\n          >\n            <LinearGradient\n              colors={[\n                'rgba(10, 145, 104, 1)',\n                'rgba(10, 145, 104, 0.6)',\n                'rgba(10, 145, 104, 1)',\n              ]}\n              style={{ flex: 1 }}\n              start={{ x: 0, y: 0 }}\n              end={{ x: 1, y: 0 }}\n            />\n          </Animated.View>\n\n          {/* Gradient de fond subtil pour donner de la profondeur */}\n          <LinearGradient\n            colors={[\n              'rgba(240, 250, 248, 0.95)',\n              'rgba(255, 255, 255, 1)',\n            ]}\n            style={{\n              position: 'absolute',\n              top: 0,\n              left: 0,\n              right: 0,\n              bottom: 0,\n            }}\n          />\n\n          {/* BottomBar - toujours visible en haut du conteneur (fait aussi office de header) */}\n        <KeyboardAvoidingView\n          behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\n          keyboardVerticalOffset={0}\n        >\n          <View \n            style={styles.bottomBar} \n            onLayout={(e) => setBarHeight(e.nativeEvent.layout.height)}\n            {...panResponder.panHandlers}\n          >\n        {/* Indicateur de swipe - anim√© */}\n        <Animated.View style={{\n          width: 44,\n          height: 6,\n          backgroundColor: 'rgba(10, 145, 104, 0.3)',\n          borderRadius: 3,\n          alignSelf: 'center',\n          marginBottom: 5,\n          opacity: glowOpacity,\n          transform: [{ scaleX: glowScale }],\n          shadowColor: 'rgba(10, 145, 104, 0.5)',\n          shadowOffset: { width: 0, height: 0 },\n          shadowOpacity: 0.8,\n          shadowRadius: 6,\n          elevation: 3,\n        }} />\n        \n        {/* Barre de chat: enregistrement vocal ou saisie classique */}\n        <View style={styles.chatSection}>\n          {isRecording ? (\n            <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, paddingHorizontal: 12 }}>\n              <View style={{ flex: 1, flexDirection: 'row', alignItems: 'center' }}>\n                <Ionicons name=\"mic\" size={18} color=\"#ef4444\" />\n                <Text style={{ marginLeft: 8, color: '#ef4444', fontWeight: '700' }}>Enregistrement...</Text>\n                <Text style={{ marginLeft: 8, color: '#ef4444' }}>{Math.floor(recordingSeconds / 60)}:{String(recordingSeconds % 60).padStart(2, '0')}</Text>\n              </View>\n              <TouchableOpacity onPress={stopRecording}>\n                {Platform.OS === 'ios' ? (\n                  <SymbolView name=\"stop.circle.fill\" size={24} tintColor=\"#ef4444\" type=\"hierarchical\" />\n                ) : (\n                  <Ionicons name=\"stop-circle\" size={22} color=\"#ef4444\" />\n                )}\n              </TouchableOpacity>\n            </View>\n          ) : (\n          <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1 }}>\n              {stagedAttachments.length > 0 && (\n                <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ maxHeight: 56, marginRight: 8 }}>\n                  {stagedAttachments.map((att, idx) => (\n                    <View key={idx} style={{ flexDirection: 'row', alignItems: 'center', backgroundColor: 'rgba(10,145,104,0.08)', borderRadius: 12, paddingVertical: 6, paddingHorizontal: 8, marginRight: 6 }}>\n                      {att.kind === 'image' ? (\n                        <Ionicons name=\"image\" size={16} color=\"rgba(10,145,104,1)\" />\n                      ) : (\n                        <Ionicons name=\"document\" size={16} color=\"rgba(10,145,104,1)\" />\n                      )}\n                      <Text numberOfLines={1} style={{ maxWidth: 120, marginLeft: 6, color: '#1a1a1a' }}>{att.name}</Text>\n                      <TouchableOpacity onPress={() => removeStagedAt(idx)} style={{ marginLeft: 6 }}>\n                        {Platform.OS === 'ios' ? (\n                          <SymbolView name=\"xmark.circle.fill\" size={18} tintColor=\"#ff6b6b\" type=\"hierarchical\" />\n                        ) : (\n                          <Ionicons name=\"close-circle\" size={18} color=\"#ff6b6b\" />\n                        )}\n                      </TouchableOpacity>\n                    </View>\n                  ))}\n                </ScrollView>\n              )}\n              {recordedUri ? (\n                <View style={{ flexDirection: 'row', alignItems: 'center', flex: 1, paddingHorizontal: 8 }}>\n                  <Ionicons name=\"mic\" size={18} color=\"#4ade80\" />\n                  <Text style={{ marginLeft: 8, color: '#4ade80', fontWeight: '700' }}>Vocal pr√™t</Text>\n                  <TouchableOpacity style={{ marginLeft: 10 }} onPress={cancelRecorded}>\n                    {Platform.OS === 'ios' ? (\n                      <SymbolView name=\"xmark.circle.fill\" size={20} tintColor=\"#ff6b6b\" type=\"hierarchical\" />\n                    ) : (\n                      <Ionicons name=\"close-circle\" size={18} color=\"#ff6b6b\" />\n                    )}\n                  </TouchableOpacity>\n                </View>\n              ) : (\n                <TextInput\n                  ref={chatInputRef}\n              style={[styles.chatInput, { flex: 1, marginRight: 8 }]}\n              placeholder={\n                    sendTarget === 'jarvis' \n                      ? 'Ask Jarvis anything'\n                      : (websocket ? 'Message...' : 'Connexion...')\n              }\n              placeholderTextColor=\"rgba(105, 105, 105, 0.8)\"\n              value={chatText}\n              onChangeText={setChatText}\n                  onSubmitEditing={handleSend}\n                  editable={sendTarget === 'chat' ? !!websocket : true}\n                  onFocus={() => { if (sendTarget === 'jarvis') { setIsJarvisInputFocused(true); } }}\n                  onBlur={() => { if (sendTarget === 'jarvis') { setIsJarvisInputFocused(false); } }}\n                />\n              )}\n            <TouchableOpacity\n              style={{\n                  backgroundColor: (chatText.trim() || recordedUri || stagedAttachments.length>0) ? \"rgba(10, 145, 104, 0.)\" : 'rgba(200, 200, 200, 0.)',\n                borderRadius: 25,\n                paddingHorizontal: 8,\n                paddingVertical: 8,\n                  opacity: (chatText.trim() || recordedUri || stagedAttachments.length>0) ? 1 : 0.6,\n              }}\n                onPress={handleSend}\n                disabled={!chatText.trim() && !recordedUri && stagedAttachments.length===0}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name=\"arrow.up.circle.fill\"\n                  size={20}\n                  tintColor=\"white\"\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name=\"send\" size={18} color=\"white\" />\n              )}\n            </TouchableOpacity>\n          </View>\n          )}\n        </View>\n        \n        {/* Boutons conditionnels */}\n        {isChat ? (\n          <View style={styles.navBar}>\n            {/* Bouton + (photo/fichier) */}\n            <TouchableOpacity\n              style={styles.navButton}\n              onPress={handlePlus}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name=\"plus.circle.fill\"\n                  size={24}\n                  tintColor=\"rgba(240, 240, 240, 0.9)\"\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name=\"add-circle\" size={24} color=\"rgba(240, 240, 240, 0.9)\" />\n              )}\n            </TouchableOpacity>\n\n            {/* Retrait des boutons fichiers/photos (g√©r√©s par \"+\") */}\n\n            {/* Bouton permutation Jarvis <-> Chat */}\n            <TouchableOpacity\n              style={styles.navButton}\n              onPress={() => {\n                setSendTarget((prev) => {\n                  const next = prev === 'jarvis' ? 'chat' : 'jarvis';\n                  if (next === 'chat') { \n                    setJarvisActive(false); \n                  } else {\n                    setJarvisActive(true);\n                  }\n                  return next;\n                });\n              }}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name={sendTarget === 'jarvis' ? 'bubble.left.and.bubble.right.fill' : 'sparkles'}\n                  size={24}\n                  tintColor={sendTarget === 'jarvis' ? 'rgba(240, 240, 240, 0.9)' : 'rgba(255, 255, 255, 0.95)'}\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name={sendTarget === 'jarvis' ? 'chatbubbles' : 'sparkles'} size={22} color={sendTarget === 'jarvis' ? 'rgba(240, 240, 240, 0.9)' : 'rgba(255, 255, 255, 0.95)'} />\n              )}\n            </TouchableOpacity>\n\n            <TouchableOpacity\n              style={styles.navButton}\n              onLongPress={startRecording}\n              onPressOut={stopRecording}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name=\"mic.fill\"\n                  size={24}\n                  tintColor=\"rgba(240, 240, 240, 0.8)\"\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name=\"mic\" size={22} color=\"rgba(240, 240, 240, 0.8)\" />\n              )}\n            </TouchableOpacity>\n            {/* Envoi/annulation du vocal via la barre principale (send/croix) */}\n          </View>\n        ) : (\n          <View style={styles.navBar}>\n            <TouchableOpacity\n              style={styles.navButton}\n              onPress={() => navigateToScreen('conversations')}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name=\"bubble.left.and.bubble.right.fill\"\n                  size={24}\n                  tintColor=\"rgba(240, 240, 240, 0.8)\"\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name=\"chatbubbles\" size={22} color=\"rgba(240, 240, 240, 0.8)\" />\n              )}\n            </TouchableOpacity>\n\n            <TouchableOpacity\n              style={styles.navButton}\n              onPress={() => navigateToScreen('home')}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name=\"house.fill\"\n                  size={24}\n                  tintColor=\"rgba(240, 240, 240, 0.8)\"\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name=\"home\" size={22} color=\"rgba(240, 240, 240, 0.8)\" />\n              )}\n            </TouchableOpacity>\n\n            <TouchableOpacity\n              style={styles.navButton}\n              onPress={() => navigateToScreen('profile')}\n            >\n              {Platform.OS === 'ios' ? (\n                <SymbolView\n                  name=\"person.circle.fill\"\n                  size={24}\n                  tintColor=\"rgba(240, 240, 240, 0.8)\"\n                  type=\"hierarchical\"\n                />\n              ) : (\n                <Ionicons name=\"person-circle\" size={22} color=\"rgba(240, 240, 240, 0.8)\" />\n              )}\n            </TouchableOpacity>\n          </View>\n        )}\n          </View>\n        </KeyboardAvoidingView>\n\n          {/* Contenu du panneau - Monde parall√®le des agents IA */}\n          <View style={{ flex: 1, padding: 20 }}>\n            \n            <View style={{ alignItems: 'center', marginBottom: 25, marginTop: 10 }}>\n              <Animated.View\n                style={{\n                  opacity: glowOpacity,\n                  transform: [{ scale: glowScale }],\n                }}\n              >\n                <Ionicons name=\"flash\" size={40} color=\"rgba(10, 145, 104, 0.8)\" />\n              </Animated.View>\n              <Text style={{ \n                fontSize: 22, \n                fontWeight: 'bold', \n                color: 'rgba(10, 145, 104, 1)', \n                marginTop: 10,\n                textAlign: 'center',\n              }}>\n                Agents IA\n              </Text>\n              <Text style={{ fontSize: 14, color: '#666', marginTop: 5, textAlign: 'center' }}>\n                Vos assistants intelligents\n              </Text>\n            </View>\n            \n            {/* Carte Agent Jarvis avec effet de profondeur */}\n            <TouchableOpacity\n              activeOpacity={0.8}\n              style={{ marginBottom: 15 }}\n            >\n              <LinearGradient\n                colors={[\n                  'rgba(10, 145, 104, 0.08)',\n                  'rgba(10, 145, 104, 0.03)',\n                ]}\n                style={{\n                  padding: 18,\n                  borderRadius: 16,\n                  borderWidth: 1,\n                  borderColor: 'rgba(10, 145, 104, 0.2)',\n                  shadowColor: 'rgba(10, 145, 104, 0.3)',\n                  shadowOffset: { width: 0, height: 4 },\n                  shadowOpacity: 0.3,\n                  shadowRadius: 8,\n                  elevation: 5,\n                }}\n                start={{ x: 0, y: 0 }}\n                end={{ x: 1, y: 1 }}\n              >\n                <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 8 }}>\n                  <View style={{\n                    width: 44,\n                    height: 44,\n                    borderRadius: 22,\n                    backgroundColor: 'rgba(10, 145, 104, 0.15)',\n                    alignItems: 'center',\n                    justifyContent: 'center',\n                    marginRight: 12,\n                  }}>\n                    <Ionicons name=\"flash\" size={24} color=\"rgba(10, 145, 104, 1)\" />\n                  </View>\n                  <View style={{ flex: 1 }}>\n                    <Text style={{ fontSize: 18, fontWeight: 'bold', color: '#333' }}>\n                      Agent Jarvis\n                    </Text>\n                    <Text style={{ fontSize: 13, color: '#666', marginTop: 2 }}>\n                      Assistant personnel intelligent\n                    </Text>\n                  </View>\n                  <Ionicons name=\"chevron-forward\" size={20} color=\"rgba(10, 145, 104, 0.6)\" />\n                </View>\n              </LinearGradient>\n            </TouchableOpacity>\n\n            {/* Message myst√©rieux */}\n            <Animated.View\n              style={{\n                opacity: glowOpacity,\n                marginTop: 10,\n              }}\n            >\n              <Text style={{ \n                fontSize: 13, \n                color: 'rgba(10, 145, 104, 0.7)', \n                textAlign: 'center',\n                fontStyle: 'italic',\n              }}>\n                ‚ú® Swipez pour d√©couvrir d'autres agents IA ‚ú®\n              </Text>\n            </Animated.View>\n          </View>\n        </Animated.View>\n      </Animated.View>\n    </>\n  );\n}","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/CreateGroupModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/DefaultAvatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/FloatingHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/ImageViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/components/SwipeableContainer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/constants/colors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/contexts/AuthContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/contexts/ChatContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":129,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":129,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useEffect, useRef, useState } from 'react';\nimport { Image as RNImage } from 'react-native';\nimport { storage } from '../utils/storage';\n\ninterface CachedMessage {\n  id: number;\n  uuid: string;\n  sender_username: string;\n  content: string;\n  created_at: string;\n  is_read?: boolean;\n  conversation_uuid?: string;\n}\n\ninterface ChatContextType {\n  websocket: WebSocket | null;\n  setWebsocket: (ws: WebSocket | null) => void;\n  sendMessage: ((message: string) => void) | null;\n  setSendMessage: (fn: ((message: string) => void) | null) => void;\n  currentConversationId: string | null;\n  setCurrentConversationId: (id: string | null) => void;\n  // Cache lecture\n  getCachedMessages: (conversationId: string) => CachedMessage[] | undefined;\n  getCachedConversationInfo: (conversationId: string) => any | undefined;\n  // Prime/cache & prefetch\n  primeCache: (conversationId: string, info: any | null, messages: CachedMessage[]) => void;\n  prefetchConversation: (\n    conversationId: string,\n    request: (url: string, options?: RequestInit) => Promise<Response>\n  ) => Promise<void>;\n  prefetchAvatars: (urls: string[]) => Promise<void>;\n  prefetchAllMessages: (\n    request: (url: string, options?: RequestInit) => Promise<Response>\n  ) => Promise<void>;\n  // Caches liste (pour retour instantan√© √† Conversations)\n  getCachedConversations: () => any[] | undefined;\n  setCachedConversations: (list: any[]) => void;\n  getCachedConnections: () => any[] | undefined;\n  setCachedConnections: (list: any[]) => void;\n  getCachedGroups: () => any[] | undefined;\n  setCachedGroups: (list: any[]) => void;\n  getCachedGroupInvitations: () => any[] | undefined;\n  setCachedGroupInvitations: (list: any[]) => void;\n  prefetchConversationsOverview: (\n    request: (url: string, options?: RequestInit) => Promise<Response>\n  ) => Promise<void>;\n}\n\nconst ChatContext = createContext<ChatContextType | undefined>(undefined);\n\nexport function ChatProvider({ children }: { children: React.ReactNode }) {\n  const [websocket, setWebsocket] = useState<WebSocket | null>(null);\n  const [sendMessage, setSendMessage] = useState<((message: string) => void) | null>(null);\n  const [currentConversationId, setCurrentConversationId] = useState<string | null>(null);\n  // Caches en m√©moire pour acc√©l√©rer l'ouverture des √©crans\n  const messagesCacheRef = useRef<Map<string, CachedMessage[]>>(new Map());\n  const infoCacheRef = useRef<Map<string, any>>(new Map());\n  const inFlightPrefetchRef = useRef<Set<string>>(new Set());\n  const messagesIndexRef = useRef<Set<string>>(new Set());\n  // Caches d'overview\n  const conversationsListRef = useRef<any[] | undefined>(undefined);\n  const connectionsListRef = useRef<any[] | undefined>(undefined);\n  const groupsListRef = useRef<any[] | undefined>(undefined);\n  const invitationsListRef = useRef<any[] | undefined>(undefined);\n\n  const API_BASE_URL = typeof window !== 'undefined' && (window as any).location?.hostname === 'localhost'\n    ? 'http://localhost:3001'\n    : 'https://reseausocial-production.up.railway.app';\n\n  const getCachedMessages = (conversationId: string) => {\n    return messagesCacheRef.current.get(conversationId);\n  };\n\n  const getCachedConversationInfo = (conversationId: string) => {\n    return infoCacheRef.current.get(conversationId);\n  };\n\n  const primeCache = (conversationId: string, info: any | null, messages: CachedMessage[]) => {\n    if (info) infoCacheRef.current.set(conversationId, info);\n    if (messages && messages.length >= 0) messagesCacheRef.current.set(conversationId, messages);\n    try {\n      messagesIndexRef.current.add(conversationId);\n      storage.setItemAsync('cache_messages_index', JSON.stringify(Array.from(messagesIndexRef.current)));\n      storage.setItemAsync(`cache_messages_${conversationId}`, JSON.stringify(messages));\n    } catch {}\n  };\n\n  const prefetchConversation = async (\n    conversationId: string,\n    request: (url: string, options?: RequestInit) => Promise<Response>\n  ) => {\n    if (!conversationId) return;\n    if (messagesCacheRef.current.has(conversationId)) return; // d√©j√† en cache\n    if (inFlightPrefetchRef.current.has(conversationId)) return; // d√©j√† en cours\n    inFlightPrefetchRef.current.add(conversationId);\n    try {\n      const [infoResp, msgsResp] = await Promise.all([\n        request(`${API_BASE_URL}/messaging/conversations/${conversationId}/`),\n        request(`${API_BASE_URL}/messaging/conversations/${conversationId}/messages/`),\n      ]);\n\n      if (!infoResp.ok || !msgsResp.ok) {\n        throw new Error('Prefetch HTTP error');\n      }\n\n      const infoData = await infoResp.json();\n      const msgsData = await msgsResp.json();\n      let messages: CachedMessage[] = Array.isArray(msgsData) ? msgsData : (msgsData.results || []);\n      messages = messages\n        .filter((m: any) => !m.conversation_uuid || m.conversation_uuid === conversationId)\n        .map((m: any) => ({\n          id: m.id,\n          uuid: m.uuid,\n          sender_username: m.sender_username,\n          content: m.content,\n          created_at: m.created_at,\n          is_read: m.is_read,\n          conversation_uuid: m.conversation_uuid,\n        }))\n        .sort((a: CachedMessage, b: CachedMessage) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());\n\n      infoCacheRef.current.set(conversationId, infoData);\n      messagesCacheRef.current.set(conversationId, messages);\n      try {\n        messagesIndexRef.current.add(conversationId);\n        storage.setItemAsync('cache_messages_index', JSON.stringify(Array.from(messagesIndexRef.current)));\n        storage.setItemAsync(`cache_messages_${conversationId}`, JSON.stringify(messages));\n      } catch {}\n    } catch (e) {\n      // silencieux pour ne pas bloquer l'UI\n    } finally {\n      inFlightPrefetchRef.current.delete(conversationId);\n    }\n  };\n\n  const prefetchAvatars = async (urls: string[]) => {\n    const unique = Array.from(new Set((urls || []).filter(Boolean)));\n    if (unique.length === 0) return;\n    try {\n      await Promise.allSettled(unique.map((u) => RNImage.prefetch(u)));\n    } catch {}\n  };\n\n  const getCachedConversations = () => conversationsListRef.current;\n  const setCachedConversations = (list: any[]) => {\n    conversationsListRef.current = Array.isArray(list) ? list : [];\n    try { storage.setItemAsync('cache_conversations', JSON.stringify(conversationsListRef.current)); } catch {}\n  };\n  const getCachedConnections = () => connectionsListRef.current;\n  const setCachedConnections = (list: any[]) => {\n    connectionsListRef.current = Array.isArray(list) ? list : [];\n    try { storage.setItemAsync('cache_connections', JSON.stringify(connectionsListRef.current)); } catch {}\n  };\n  const getCachedGroups = () => groupsListRef.current;\n  const setCachedGroups = (list: any[]) => {\n    groupsListRef.current = Array.isArray(list) ? list : [];\n    try { storage.setItemAsync('cache_groups', JSON.stringify(groupsListRef.current)); } catch {}\n  };\n  const getCachedGroupInvitations = () => invitationsListRef.current;\n  const setCachedGroupInvitations = (list: any[]) => {\n    invitationsListRef.current = Array.isArray(list) ? list : [];\n    try { storage.setItemAsync('cache_group_invitations', JSON.stringify(invitationsListRef.current)); } catch {}\n  };\n\n  const prefetchConversationsOverview = async (\n    request: (url: string, options?: RequestInit) => Promise<Response>\n  ) => {\n    try {\n      // Conversations + connexions + groupes (+ d√©tails) + invitations\n      const [convResp, connResp, groupsResp, invResp] = await Promise.all([\n        request(`${API_BASE_URL}/messaging/conversations/`),\n        request(`${API_BASE_URL}/relations/connections/my-connections/`),\n        request(`${API_BASE_URL}/groups/my-groups/`),\n        request(`${API_BASE_URL}/groups/invitations/received/`),\n      ]);\n\n      if (convResp.ok) {\n        const convData = await convResp.json();\n        const list = Array.isArray(convData) ? convData : (convData.results || []);\n        setCachedConversations(list);\n        // Pr√©fetch avatars visibles\n        const avatarUrls: string[] = [];\n        list.forEach((c: any) => {\n          const url = c.other_participant?.photo_profil_url || c.group?.avatar;\n          if (url) avatarUrls.push(url);\n        });\n        await prefetchAvatars(avatarUrls);\n      }\n\n      if (connResp.ok) {\n        const connData = await connResp.json();\n        setCachedConnections(connData?.connexions || []);\n      }\n\n      if (groupsResp.ok) {\n        const groups = await groupsResp.json();\n        const groupsWithDetails: any[] = [];\n        for (const g of groups) {\n          try {\n            const det = await request(`${API_BASE_URL}/groups/${g.uuid}/`);\n            if (det.ok) {\n              const d = await det.json();\n              groupsWithDetails.push({ ...g, ...d, conversation_uuid: d.conversation_uuid });\n            } else {\n              groupsWithDetails.push(g);\n            }\n          } catch {\n            groupsWithDetails.push(g);\n          }\n        }\n        setCachedGroups(groupsWithDetails);\n        try {\n          const groupAvatarUrls = groupsWithDetails.map((gg: any) => gg.avatar).filter(Boolean);\n          await prefetchAvatars(groupAvatarUrls);\n        } catch {}\n      }\n\n      if (invResp.ok) {\n        setCachedGroupInvitations(await invResp.json());\n      }\n    } catch {}\n  };\n\n  const prefetchAllMessages = async (\n    request: (url: string, options?: RequestInit) => Promise<Response>\n  ) => {\n    try {\n      // S'assurer que la liste des conversations existe\n      if (!conversationsListRef.current || conversationsListRef.current.length === 0) {\n        await prefetchConversationsOverview(request);\n      }\n      const convs = conversationsListRef.current || [];\n      // Limiter la concurrence\n      const concurrency = 4;\n      let i = 0;\n      const worker = async () => {\n        while (i < convs.length) {\n          const idx = i++;\n          const c = convs[idx];\n          const convId = c?.uuid;\n          if (!convId) continue;\n          // √âviter de refetch si d√©j√† en cache\n          if (messagesCacheRef.current.has(convId)) continue;\n          await prefetchConversation(convId, request);\n        }\n      };\n      await Promise.all(Array.from({ length: Math.min(concurrency, convs.length) }).map(() => worker()))\n    } catch {}\n  };\n\n  // Hydrate les caches depuis le stockage au d√©marrage du provider\n  useEffect(() => {\n    (async () => {\n      try {\n        const [c, co, g, inv] = await Promise.all([\n          storage.getItemAsync('cache_conversations'),\n          storage.getItemAsync('cache_connections'),\n          storage.getItemAsync('cache_groups'),\n          storage.getItemAsync('cache_group_invitations'),\n        ]);\n        if (c) conversationsListRef.current = JSON.parse(c);\n        if (co) connectionsListRef.current = JSON.parse(co);\n        if (g) groupsListRef.current = JSON.parse(g);\n        if (inv) invitationsListRef.current = JSON.parse(inv);\n      } catch {}\n    })();\n  }, []);\n\n  return (\n    <ChatContext.Provider\n      value={{\n        websocket,\n        setWebsocket,\n        sendMessage,\n        setSendMessage,\n        currentConversationId,\n        setCurrentConversationId,\n        getCachedMessages,\n        getCachedConversationInfo,\n        primeCache,\n        prefetchConversation,\n        prefetchAvatars,\n        prefetchAllMessages,\n        getCachedConversations,\n        setCachedConversations,\n        getCachedConnections,\n        setCachedConnections,\n        getCachedGroups,\n        setCachedGroups,\n        getCachedGroupInvitations,\n        setCachedGroupInvitations,\n        prefetchConversationsOverview,\n      }}\n    >\n      {children}\n    </ChatContext.Provider>\n  );\n}\n\nexport function useChat() {\n  const context = useContext(ChatContext);\n  if (!context) {\n    throw new Error('useChat must be used within a ChatProvider');\n  }\n  return context;\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/contexts/NavigationContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/contexts/TransitionContext.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/expo-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/proxy-server.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/styles/appStyles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/tommasoaloisi/Echo Social/Echo_social/utils/storage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
